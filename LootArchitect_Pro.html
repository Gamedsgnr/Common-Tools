<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loot Architect Pro v1.2.1 - Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        .input-dark { @apply bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 transition-all; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        .warning-glow { box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); border-color: #ef4444; }
        canvas { width: 100% !important; height: 100% !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen p-4" x-data="lootSim()">

    <header class="mb-6 flex flex-wrap justify-between items-center bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-2xl">
        <div class="flex items-center gap-4">
            <div class="bg-blue-600 p-3 rounded-lg shadow-lg shadow-blue-900/20">
                <i class="fa-solid fa-box-open text-2xl text-white"></i>
            </div>
            <div>
                <h1 class="text-2xl font-black tracking-tight text-white uppercase">Loot Architect <span class="text-blue-500 text-sm">Pro v1.2.1</span></h1>
                <p class="text-xs text-gray-400 uppercase tracking-widest font-semibold">Симуляция экономики и вероятностей</p>
            </div>
        </div>
        <div class="flex gap-3 mt-4 sm:mt-0">
            <button @click="resetAll()" class="px-5 py-2 bg-gray-700 hover:bg-red-600 rounded-lg text-xs font-bold transition-all flex items-center gap-2">
                <i class="fa-solid fa-rotate-left"></i> СБРОС
            </button>
            
            <div class="flex bg-gray-900 p-1 rounded-lg border border-gray-700">
                <input type="file" x-ref="fileInput" @change="importConfig($event)" class="hidden" accept=".json">
                <button @click="$refs.fileInput.click()" class="px-4 py-2 hover:bg-gray-800 text-blue-400 rounded-l-md text-xs font-bold transition-all flex items-center gap-2 border-r border-gray-700">
                    <i class="fa-solid fa-file-import"></i> IMPORT
                </button>
                <button @click="exportConfig()" class="px-4 py-2 hover:bg-gray-800 text-green-400 rounded-r-md text-xs font-bold transition-all flex items-center gap-2">
                    <i class="fa-solid fa-file-export"></i> EXPORT
                </button>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 shadow-lg relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                <h2 class="text-sm font-bold mb-4 text-gray-400 uppercase tracking-wider flex justify-between items-center">
                    Настройка пула
                    <span class="bg-gray-900 px-2 py-1 rounded text-blue-400 border border-gray-700 font-mono" x-text="'Вес: ' + totalWeight"></span>
                </h2>
                
                <div class="space-y-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                    <template x-for="(item, index) in items" :key="item.id">
                        <div class="group flex items-center gap-2 bg-gray-900 p-2 rounded-lg border border-gray-700 hover:border-gray-500 transition-all">
                            <input type="color" x-model="item.color" class="w-6 h-10 rounded cursor-pointer bg-transparent border-none">
                            <div class="flex-1">
                                <input type="text" x-model="item.name" class="bg-transparent border-none text-white text-sm font-bold p-0 focus:ring-0 w-full" placeholder="Название">
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[10px] text-gray-500 font-mono">ВЕС:</span>
                                    <input type="number" x-model.number="item.weight" @input="onManualChange()" class="bg-gray-800 border-none text-blue-400 text-xs rounded p-0.5 w-16 focus:ring-1 focus:ring-blue-500 font-bold">
                                </div>
                            </div>
                            <div class="text-right mr-2">
                                <div class="text-sm font-bold text-white" x-text="item.percent + '%'"></div>
                                <div class="text-[10px] text-gray-500" x-text="item.count + ' шт'"></div>
                            </div>
                            <button @click="removeItem(index)" class="opacity-0 group-hover:opacity-100 text-gray-600 hover:text-red-500 transition-all p-2">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </template>
                </div>
                
                <button @click="addItem()" class="mt-4 w-full py-3 border-2 border-dashed border-gray-700 text-gray-500 rounded-xl hover:border-blue-500 hover:text-blue-400 transition-all font-bold text-sm">
                    <i class="fa-solid fa-plus mr-2"></i> ДОБАВИТЬ ПРЕДМЕТ
                </button>
            </div>

            <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 shadow-lg">
                <h2 class="text-sm font-bold mb-4 text-gray-400 uppercase tracking-wider flex items-center gap-2">
                    <i class="fa-solid fa-gears text-blue-500"></i> Правила
                </h2>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="col-span-2">
                        <label class="block text-xs text-gray-500 mb-1 ml-1 font-bold tracking-tighter uppercase">Режим</label>
                        <select x-model="settings.mode" class="input-dark bg-gray-900 border-none">
                            <option value="replacement">Infinite (Replacement)</option>
                            <option value="no_replacement">Box (No Replacement)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1 ml-1 font-bold uppercase">Цена ($)</label>
                        <input type="number" x-model.number="settings.costPerPull" class="input-dark bg-gray-900 border-none">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1 ml-1 font-bold uppercase tracking-widest">Val</label>
                        <input type="text" value="USD" class="input-dark bg-gray-900 border-none opacity-40 cursor-not-allowed text-center font-mono" disabled>
                    </div>
                </div>

                <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700 shadow-inner">
                    <div class="flex items-center justify-between mb-4">
                        <label class="text-sm font-black text-yellow-500 tracking-tight flex items-center gap-2">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> PITY (ГАРАНТ)
                        </label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" x-model="pity.enabled" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-600 shadow-lg"></div>
                        </label>
                    </div>
                    
                    <div x-show="pity.enabled" x-transition class="space-y-4">
                        <div>
                            <label class="block text-[10px] text-gray-500 mb-1 uppercase font-bold">Цель гаранта</label>
                            <select x-model="pity.targetId" class="input-dark border-none shadow-inner">
                                <template x-for="item in items" :key="item.id">
                                    <option :value="item.id" x-text="item.name" :selected="item.id == pity.targetId"></option>
                                </template>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-1 uppercase font-bold text-red-400">Hard Limit</label>
                                <input type="number" x-model.number="pity.hardLimit" :class="{'warning-glow': pity.softStart >= pity.hardLimit}" class="input-dark border-none">
                            </div>
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-1 uppercase font-bold text-yellow-400">Soft Start</label>
                                <input type="number" x-model.number="pity.softStart" class="input-dark border-none">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-blue-600 p-1 rounded-2xl shadow-xl shadow-blue-600/20 group">
                <div class="bg-gray-800 rounded-[14px] p-5">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <button @click="simulate(1)" class="py-3 rounded-xl bg-gray-700 hover:bg-gray-600 text-white font-black transition-all active:scale-95 shadow-lg border border-gray-600 uppercase text-xs tracking-widest">x1 Pull</button>
                        <button @click="simulate(10)" class="py-3 rounded-xl bg-gray-700 hover:bg-gray-600 text-white font-black transition-all active:scale-95 shadow-lg border border-gray-600 uppercase text-xs tracking-widest">x10 Pull</button>
                    </div>
                    <button @click="simulate(1000)" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-black rounded-xl transition-all active:scale-95 shadow-lg shadow-blue-600/30 mb-4 uppercase text-xs tracking-widest">
                        Run Batch (1,000)
                    </button>
                    <button @click="runMonteCarlo()" class="w-full py-4 bg-purple-600 hover:bg-purple-500 text-white font-black rounded-xl transition-all active:scale-95 shadow-lg shadow-purple-600/30 flex items-center justify-center gap-2 uppercase text-xs tracking-widest">
                        <i class="fa-solid fa-microchip"></i> Анализ удачи
                    </button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 text-center shadow-lg">
                    <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1">Всего круток</div>
                    <div class="text-3xl font-black text-white font-mono" x-text="stats.totalPulls">0</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 text-center border-b-4 border-b-green-500 shadow-lg">
                    <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1">Затраты</div>
                    <div class="text-3xl font-black text-green-400 font-mono" x-text="'$' + (stats.totalPulls * settings.costPerPull).toLocaleString()">0</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 text-center border-b-4 border-b-yellow-500 shadow-lg">
                    <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1">До Гаранта</div>
                    <div class="text-3xl font-black text-yellow-500 font-mono" x-text="pity.enabled ? Math.max(0, pity.hardLimit - pity.currentCounter) : '—'">0</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 text-center border-b-4 border-b-red-500 shadow-lg">
                    <div class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1">Max Streak</div>
                    <div class="text-3xl font-black text-red-500 font-mono" x-text="stats.worstDrought">0</div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-2xl">
                <div class="flex flex-wrap gap-6 mb-6 border-b border-gray-700 pb-4">
                    <button @click="activeTab = 'dist'" :class="activeTab === 'dist' ? 'text-blue-400 border-b-2 border-blue-400 pb-4' : 'text-gray-500'" class="text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 -mb-[17px]">
                        <i class="fa-solid fa-chart-simple"></i> Распределение
                    </button>
                    <button @click="activeTab = 'monte'" :class="activeTab === 'monte' ? 'text-purple-400 border-b-2 border-purple-400 pb-4' : 'text-gray-500'" class="text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 -mb-[17px]">
                        <i class="fa-solid fa-bezier-curve"></i> Анализ удачи
                    </button>
                    <button @click="activeTab = 'log'" :class="activeTab === 'log' ? 'text-green-400 border-b-2 border-green-400 pb-4' : 'text-gray-500'" class="text-xs font-black uppercase tracking-widest transition-all flex items-center gap-2 -mb-[17px]">
                        <i class="fa-solid fa-list-ul"></i> Лог событий
                    </button>
                </div>

                <div class="relative h-[400px]">
                    <div x-show="activeTab === 'dist'" class="h-full">
                        <canvas id="distChart"></canvas>
                    </div>
                    <div x-show="activeTab === 'monte'" class="h-full">
                        <div x-show="!stats.monteCarloDone" class="flex flex-col items-center justify-center h-full text-gray-600 bg-gray-900/30 rounded-xl border border-dashed border-gray-700">
                            <i class="fa-solid fa-flask-vial text-4xl mb-3 opacity-20"></i>
                            <p class="font-bold uppercase text-[10px] tracking-widest">Анализ не запущен</p>
                        </div>
                        <canvas x-show="stats.monteCarloDone" id="monteChart"></canvas>
                    </div>
                    <div x-show="activeTab === 'log'" class="h-full overflow-y-auto custom-scrollbar font-mono text-[11px] bg-gray-900 p-4 rounded-xl border border-gray-700 shadow-inner">
                        <template x-for="log in logs" :key="log.pullNum">
                            <div class="flex justify-between py-1.5 border-b border-gray-800 group hover:bg-gray-800/50 px-2 transition-colors">
                                <span class="text-gray-600" x-text="'[' + log.pullNum + ']'"></span>
                                <span :style="`color: ${log.color}`" class="font-bold uppercase tracking-tighter" x-text="log.itemName"></span>
                                <span class="text-[9px] px-2 py-0.5 rounded bg-gray-800 text-blue-500 font-bold border border-blue-900/50" x-show="log.pityStatus" x-text="log.pityStatus"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 shadow-lg">
                <h3 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-calculator text-blue-500"></i> Сверка (Theory vs Actual)
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-gray-900 text-gray-500 uppercase tracking-tighter">
                            <tr>
                                <th class="px-4 py-3 rounded-l-lg">Предмет</th>
                                <th class="px-4 py-3">План %</th>
                                <th class="px-4 py-3">Факт %</th>
                                <th class="px-4 py-3 rounded-r-lg">Delta</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            <template x-for="item in items" :key="item.id">
                                <tr class="hover:bg-gray-750">
                                    <td class="px-4 py-3 font-bold text-white flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full" :style="`background: ${item.color}`"></span>
                                        <span x-text="item.name"></span>
                                    </td>
                                    <td class="px-4 py-3 font-mono text-gray-400" x-text="item.percent + '%' text-right"></td>
                                    <td class="px-4 py-3 font-mono font-bold" x-text="stats.totalPulls > 0 ? ((item.count / stats.totalPulls)*100).toFixed(2) + '%' : '0.00%'"></td>
                                    <td class="px-4 py-3">
                                        <template x-if="stats.totalPulls > 0">
                                            <span :class="Math.abs(item.percent - ((item.count/stats.totalPulls)*100)) < 0.5 ? 'text-green-500' : 'text-red-400'" 
                                                  class="font-mono px-2 py-0.5 rounded bg-black/20"
                                                  x-text="Math.abs(item.percent - ((item.count/stats.totalPulls)*100)).toFixed(2) + '%'"></span>
                                        </template>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ГРАФИКОВ (для обхода Alpine Proxy)
        let chartInstances = { dist: null, monte: null };

        document.addEventListener('alpine:init', () => {
            Alpine.data('lootSim', () => ({
                items: [
                    { id: 1, name: 'Мусор (Common)', weight: 750, color: '#64748b', count: 0, percent: 0 },
                    { id: 2, name: 'Снаряжение (Rare)', weight: 200, color: '#3b82f6', count: 0, percent: 0 },
                    { id: 3, name: 'Артефакт (Epic)', weight: 45, color: '#a855f7', count: 0, percent: 0 },
                    { id: 4, name: 'ЛЕГЕНДА (Lego)', weight: 5, color: '#f59e0b', count: 0, percent: 0 },
                ],
                settings: { mode: 'replacement', costPerPull: 5 },
                pity: { enabled: true, targetId: 4, hardLimit: 80, softStart: 65, currentCounter: 0 },
                stats: { totalPulls: 0, worstDrought: 0, monteCarloDone: false },
                activeTab: 'dist',
                logs: [],
                totalWeight: 0,

                init() {
                    this.recalcPercents();
                    this.$nextTick(() => { 
                        this.initCharts();
                    });

                    // Следим за вкладками (важно для отрисовки графиков, которые были скрыты)
                    this.$watch('activeTab', () => {
                        this.$nextTick(() => {
                            if (chartInstances.dist) chartInstances.dist.resize();
                            if (chartInstances.monte) chartInstances.monte.resize();
                        });
                    });

                    // Глубокий слежка за данными пула
                    this.$watch('items', () => {
                        this.recalcPercents();
                        this.updateCharts();
                    }, { deep: true });
                },

                onManualChange() {
                    this.recalcPercents();
                    this.updateCharts();
                },

                addItem() {
                    const id = Date.now();
                    this.items.push({ id, name: 'New Item ' + (this.items.length+1), weight: 10, color: '#' + Math.floor(Math.random()*16777215).toString(16), count: 0, percent: 0 });
                },

                removeItem(index) {
                    if(this.items.length <= 1) return;
                    const removedId = this.items[index].id;
                    this.items.splice(index, 1);
                    if (this.pity.targetId == removedId) this.pity.targetId = this.items[0].id;
                },

                recalcPercents() {
                    this.totalWeight = this.items.reduce((sum, i) => sum + (Number(i.weight) || 0), 0);
                    this.items.forEach(i => {
                        i.percent = this.totalWeight > 0 ? ((Number(i.weight) / this.totalWeight) * 100).toFixed(2) : 0;
                    });
                },

                simulate(count) {
                    for (let i = 0; i < count; i++) {
                        this.stats.totalPulls++;
                        this.pity.currentCounter++;

                        let rolledItem = null;
                        let isPityHit = false;

                        if (this.pity.enabled && this.pity.currentCounter >= this.pity.hardLimit) {
                            rolledItem = this.items.find(x => x.id == this.pity.targetId);
                            isPityHit = true;
                        }

                        if (!rolledItem) {
                            let currentTotalW = this.totalWeight;
                            let bonusWeight = 0;
                            if (this.pity.enabled && this.pity.currentCounter >= this.pity.softStart) {
                                const target = this.items.find(x => x.id == this.pity.targetId);
                                if (target) {
                                    const steps = this.pity.currentCounter - this.pity.softStart;
                                    bonusWeight = (this.totalWeight * 0.2) * steps; 
                                    currentTotalW += bonusWeight;
                                }
                            }

                            let rnd = Math.random() * currentTotalW;
                            let accum = 0;
                            for (let item of this.items) {
                                let w = Number(item.weight);
                                if (this.pity.enabled && item.id == this.pity.targetId) w += bonusWeight;
                                accum += w;
                                if (rnd <= accum) { rolledItem = item; break; }
                            }
                        }

                        if (!rolledItem) rolledItem = this.items[0];
                        rolledItem.count++;
                        
                        if (this.pity.enabled && rolledItem.id == this.pity.targetId) {
                            if (this.pity.currentCounter > this.stats.worstDrought) this.stats.worstDrought = this.pity.currentCounter;
                            this.pity.currentCounter = 0;
                        }

                        if (count <= 100) {
                            if (this.logs.length >= 100) this.logs.pop();
                            this.logs.unshift({
                                pullNum: this.stats.totalPulls,
                                itemName: rolledItem.name,
                                color: rolledItem.color,
                                pityStatus: isPityHit ? 'HARD PITY' : (rolledItem.id == this.pity.targetId ? 'GOAL!' : '')
                            });
                        }
                    }
                    this.updateCharts();
                },

                runMonteCarlo() {
                    const iterations = 5000;
                    const results = [];
                    const targetId = this.pity.targetId;
                    
                    for(let k=0; k<iterations; k++) {
                        let pulls = 0;
                        let found = false;
                        let localPity = 0;
                        while(!found && pulls < 1000) {
                            pulls++; localPity++;
                            if (this.pity.enabled && localPity >= this.pity.hardLimit) {
                                found = true;
                            } else {
                                let bonus = 0;
                                if(this.pity.enabled && localPity >= this.pity.softStart) {
                                    bonus = (this.totalWeight * 0.2) * (localPity - this.pity.softStart);
                                }
                                let rnd = Math.random() * (this.totalWeight + bonus);
                                let accum = 0;
                                for(let itm of this.items) {
                                    let w = Number(itm.weight);
                                    if(itm.id == targetId) w += bonus;
                                    accum += w;
                                    if(rnd <= accum) {
                                        if(itm.id == targetId) found = true;
                                        break;
                                    }
                                }
                            }
                        }
                        results.push(pulls);
                    }
                    this.renderMonteCarloChart(results);
                    this.stats.monteCarloDone = true;
                    this.activeTab = 'monte';
                },

                initCharts() {
                    Chart.defaults.color = '#9ca3af';
                    Chart.defaults.font.family = 'monospace';

                    const ctxDist = document.getElementById('distChart').getContext('2d');
                    chartInstances.dist = new Chart(ctxDist, {
                        type: 'bar',
                        data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderRadius: 4 }] },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                y: { beginAtZero: true, grid: { color: '#374151'} },
                                x: { grid: { display: false } }
                            }
                        }
                    });

                    const ctxMonte = document.getElementById('monteChart').getContext('2d');
                    chartInstances.monte = new Chart(ctxMonte, {
                        type: 'line',
                        data: { labels: [], datasets: [{ label: 'Успех %', data: [], borderColor: '#a855f7', fill: true, backgroundColor: 'rgba(168, 85, 247, 0.1)', tension: 0.4 }] },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true } },
                            scales: { 
                                y: { max: 100, grid: { color: '#374151'} },
                                x: { grid: { color: '#374151'} }
                            }
                        }
                    });
                    this.updateCharts();
                },

                updateCharts() {
                    if (!chartInstances.dist) return;
                    chartInstances.dist.data.labels = this.items.map(i => i.name);
                    chartInstances.dist.data.datasets[0].data = this.items.map(i => i.count);
                    chartInstances.dist.data.datasets[0].backgroundColor = this.items.map(i => i.color);
                    chartInstances.dist.update();
                },

                renderMonteCarloChart(results) {
                    if (!chartInstances.monte) return;
                    results.sort((a,b) => a-b);
                    const bins = [];
                    const data = [];
                    const max = results[results.length-1];
                    const step = Math.max(1, Math.ceil(max / 40));

                    for(let i=0; i<=max; i+=step) {
                        const count = results.filter(r => r <= i).length;
                        bins.push(i);
                        data.push(((count / results.length) * 100).toFixed(1));
                    }
                    chartInstances.monte.data.labels = bins;
                    chartInstances.monte.data.datasets[0].data = data;
                    chartInstances.monte.update();
                },

                resetAll() {
                    if(!confirm("Сбросить всю статистику?")) return;
                    this.items.forEach(i => i.count = 0);
                    this.stats.totalPulls = 0;
                    this.stats.worstDrought = 0;
                    this.stats.monteCarloDone = false;
                    this.pity.currentCounter = 0;
                    this.logs = [];
                    this.updateCharts();
                },

                exportConfig() {
                    const data = { items: this.items, pity: this.pity, settings: this.settings };
                    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `loot_arch_${Date.now()}.json`;
                    a.click();
                },

                importConfig(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const config = JSON.parse(e.target.result);
                            if (config.items) this.items = config.items;
                            if (config.pity) this.pity = config.pity;
                            if (config.settings) this.settings = config.settings;
                            this.resetAll(); // Сбрасываем счетчики при новом конфиге
                            alert("Конфигурация загружена!");
                        } catch (err) { alert("Ошибка JSON"); }
                    };
                    reader.readAsText(file);
                }
            }));
        });
    </script>
</body>
</html>