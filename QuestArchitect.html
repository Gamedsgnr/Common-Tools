<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Architect Pro v5.0 - Cloud Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
    <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --df-node-bg: #1f2937;
            --df-node-border: #374151;
            --df-node-text: #f3f4f6;
            --df-connection-color: #3b82f6;
            --df-connection-width: 3px;
        }
        #drawflow {
            background-size: 25px 25px;
            background-image: radial-gradient(#374151 1px, transparent 1px);
            background-color: #111827;
            height: 100%; width: 100%;
        }
        .drawflow .drawflow-node {
            background: var(--df-node-bg);
            border: 2px solid var(--df-node-border);
            border-radius: 8px;
            min-width: 220px;
            color: var(--df-node-text);
            padding: 0;
            z-index: 2;
        }
        .drawflow .drawflow-node.selected {
            background: var(--df-node-bg) !important;
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6);
        }
        .drawflow-node .output {
            cursor: pointer; border: 2px solid #000; width: 15px; height: 15px;
        }
        .drawflow-node .output:hover { transform: scale(1.2); background: #60a5fa; }
        .drawflow-node .input { width: 15px; height: 15px; background: #4b5563; }

        .node-header { @apply p-2 border-b border-gray-700 font-bold text-xs uppercase tracking-wider flex items-center gap-2 rounded-t-lg; }
        .node-content { @apply p-3 text-sm; }
        .header-dialogue { background: #1e3a8a; }
        .header-condition { background: #7c2d12; }
        .header-action { background: #064e3b; }
        .header-start { background: #4338ca; }

        .custom-menu { 
            position: fixed; z-index: 999; background: #1f2937; 
            border: 1px solid #374151; border-radius: 6px; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); min-width: 160px;
        }
        .menu-item { @apply w-full text-left px-4 py-2 text-xs hover:bg-blue-600 flex items-center gap-2 transition-colors; }
        .connection-label {
            position: absolute; transform: translate(-50%, -50%);
            background: #1f2937; color: #93c5fd; padding: 2px 8px;
            border-radius: 10px; border: 1px solid #3b82f6;
            font-size: 10px; font-weight: bold; pointer-events: none;
            white-space: nowrap; max-width: 150px; overflow: hidden; text-overflow: ellipsis;
            z-index: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .edit-modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        textarea.nodrag { resize: vertical; min-height: 60px; }
        select.nodrag { cursor: pointer; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 overflow-hidden h-screen flex flex-col" x-data="questEditor()">

    <header class="h-16 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-6 z-10 shadow-xl">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 p-2 rounded"><i class="fa-solid fa-sitemap text-xl"></i></div>
            <div>
                <h1 class="text-lg font-black tracking-tighter">QUEST ARCHITECT <span class="text-indigo-400">PRO v5</span></h1>
                <p class="text-[10px] text-gray-400 uppercase font-bold">Инструментарий Геймдизайнера</p>
            </div>
        </div>
        
        <div class="flex gap-2 items-center">
            
            <button @click="togglePlayMode()" :class="isPlayMode ? 'bg-red-600' : 'bg-green-600'" class="px-4 py-2 rounded text-xs font-bold flex items-center gap-2 transition-all mr-4">
                <i :class="isPlayMode ? 'fa-solid fa-stop' : 'fa-solid fa-play'"></i>
                <span x-text="isPlayMode ? 'СТОП' : 'ТЕСТ'"></span>
            </button>
            <div class="h-8 w-px bg-gray-600 mx-2"></div>

            <template x-if="isAuth">
                <div class="flex gap-2 animate-fade-in">
                     <span class="flex items-center text-[10px] text-green-400 font-bold mr-2"><i class="fa-solid fa-link mr-1"></i> ONLINE</span>
                     
                     <button @click="openCloudModal('load')" class="px-4 py-2 bg-indigo-700 hover:bg-indigo-600 rounded text-xs font-bold uppercase border border-indigo-500 flex items-center gap-2 shadow-lg hover:shadow-indigo-500/20">
                        <i class="fa-solid fa-cloud-arrow-down"></i> DB Import
                    </button>
                    
                    <button @click="openCloudModal('save')" class="px-4 py-2 bg-pink-700 hover:bg-pink-600 rounded text-xs font-bold uppercase border border-pink-500 flex items-center gap-2 shadow-lg hover:shadow-pink-500/20">
                        <i class="fa-solid fa-cloud-arrow-up"></i> DB Export
                    </button>
                </div>
            </template>

            <template x-if="!isAuth">
                <div class="flex gap-2">
                    <input type="file" x-ref="fileInput" @change="importData($event)" class="hidden" accept=".json">
                    <button @click="$refs.fileInput.click()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-xs font-bold uppercase border border-gray-600 flex items-center gap-2">
                        <i class="fa-solid fa-file-import"></i> File Import
                    </button>
                    <button @click="exportData()" class="px-4 py-2 bg-blue-700 hover:bg-blue-600 rounded text-xs font-bold uppercase border border-blue-600 flex items-center gap-2">
                        <i class="fa-solid fa-file-export"></i> File Export
                    </button>
                </div>
            </template>

        </div>
    </header>

    <div class="flex-1 flex overflow-hidden relative">
        <aside class="w-64 bg-gray-800 border-r border-gray-700 p-4 flex flex-col gap-4 overflow-y-auto z-10">
            <h3 class="text-[10px] font-black text-gray-500 uppercase">Базовые узлы</h3>
            <div class="grid gap-2">
                <div draggable="true" @dragstart="drag($event, 'start')" class="cursor-grab p-3 bg-gray-700 rounded border border-gray-600 hover:border-indigo-500 transition-all flex items-center gap-3">
                    <i class="fa-solid fa-play text-indigo-400"></i><span class="text-xs font-bold">Старт</span>
                </div>
                <div draggable="true" @dragstart="drag($event, 'dialogue')" class="cursor-grab p-3 bg-gray-700 rounded border border-gray-600 hover:border-blue-500 transition-all flex items-center gap-3">
                    <i class="fa-solid fa-comment text-blue-400"></i><span class="text-xs font-bold">Диалог</span>
                </div>
                <div draggable="true" @dragstart="drag($event, 'condition')" class="cursor-grab p-3 bg-gray-700 rounded border border-gray-600 hover:border-orange-500 flex items-center gap-3">
                    <i class="fa-solid fa-code-branch text-orange-400"></i><span class="text-xs font-bold">Условие</span>
                </div>
                <div draggable="true" @dragstart="drag($event, 'action')" class="cursor-grab p-3 bg-gray-700 rounded border border-gray-600 hover:border-green-500 flex items-center gap-3">
                    <i class="fa-solid fa-bolt text-green-400"></i><span class="text-xs font-bold">Действие</span>
                </div>
            </div>

            <div class="border-t border-gray-700 pt-4 mt-2">
                <h3 class="text-[10px] font-black text-gray-500 uppercase mb-2">Персонажи (NPC)</h3>
                <div class="space-y-2 mb-2">
                    <template x-for="(npc, index) in npcList" :key="index">
                        <div class="flex items-center justify-between bg-gray-900 p-2 rounded border border-gray-700 group">
                            <span class="text-xs font-bold text-blue-300" x-text="npc"></span>
                            <button @click="removeNPC(index)" class="text-gray-600 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                        </div>
                    </template>
                </div>
                <button @click="addNPC()" class="w-full text-[9px] text-gray-400 hover:text-white border border-dashed border-gray-600 py-1.5 rounded tracking-widest bg-gray-800/50">+ ДОБАВИТЬ NPC</button>
            </div>

            <div class="border-t border-gray-700 pt-4 mt-2">
                <h3 class="text-[10px] font-black text-gray-500 uppercase mb-2">Переменные мира</h3>
                <div class="bg-gray-900 p-2 rounded border border-gray-700 space-y-2">
                    <template x-for="(f, n) in worldState" :key="n">
                        <div class="p-1 border-b border-gray-800 flex flex-col gap-1">
                            <div class="flex justify-between text-[9px] text-gray-500 font-mono"><span x-text="n"></span><span x-text="f.type"></span></div>
                            <template x-if="f.type === 'bool'"><input type="checkbox" x-model="f.value" class="rounded bg-gray-700"></template>
                            <template x-if="f.type === 'number'"><input type="number" x-model.number="f.value" class="bg-gray-800 text-[10px] p-1 rounded border-none w-full text-blue-400"></template>
                            <template x-if="f.type === 'string'"><input type="text" x-model="f.value" class="bg-gray-800 text-[10px] p-1 rounded border-none w-full text-green-400"></template>
                        </div>
                    </template>
                    <button @click="addFlag()" class="w-full text-[9px] text-gray-500 hover:text-white border border-dashed border-gray-700 py-1 mt-2 tracking-widest">+ ПЕРЕМЕННАЯ</button>
                </div>
            </div>
        </aside>

        <main class="flex-1 relative" @mousemove="handleGlobalMove($event)">
            <div id="drawflow" 
                 @dragover.prevent 
                 @drop="drop($event)"
                 @dblclick="handleDblClick($event)"
                 @contextmenu.prevent="openContextMenu($event)"
                 @mouseup="handleMouseUp($event)"
                 @mousedown="closeMenus()"></div>

            <div x-show="menu.show" x-cloak class="custom-menu" :style="`left: ${menu.x}px; top: ${menu.y}px`" @click.stop>
                <div class="text-[9px] font-black text-gray-500 px-4 py-1 uppercase border-b border-gray-700">Создать</div>
                <button class="menu-item" @click="createFromMenu('dialogue')"><i class="fa-solid fa-comment text-blue-400"></i> Диалог</button>
                <button class="menu-item" @click="createFromMenu('condition')"><i class="fa-solid fa-code-branch text-orange-400"></i> Условие</button>
                <button class="menu-item" @click="createFromMenu('action')"><i class="fa-solid fa-bolt text-green-400"></i> Действие</button>
            </div>

            <div x-show="connEditor.show" x-cloak class="edit-modal-overlay" @click.self="closeMenus()">
                <div class="bg-gray-800 p-5 rounded-xl border border-gray-600 shadow-2xl w-96">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                        <label class="text-sm font-bold text-blue-400 uppercase tracking-wider">Ответ игрока</label>
                    </div>
                    <input type="text" x-ref="connInput" x-model="connEditor.label" @keyup.enter="saveAndCloseConn()" class="w-full bg-gray-900 border border-gray-700 rounded p-3 text-sm text-white focus:border-blue-500 outline-none">
                    <div class="flex justify-end mt-6 gap-2">
                        <button @click="closeMenus()" class="px-4 py-2 rounded text-xs font-bold text-gray-400 hover:bg-gray-700">Отмена</button>
                        <button @click="saveAndCloseConn()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-xs font-bold text-white">Сохранить</button>
                    </div>
                </div>
            </div>

            <div x-show="cloud.show" x-cloak class="absolute inset-0 bg-black/90 z-[101] flex items-center justify-center p-10">
                <div class="bg-gray-800 w-full max-w-4xl h-[600px] rounded-2xl border border-gray-600 shadow-2xl overflow-hidden flex flex-col">
                    <div class="bg-gray-700 p-4 flex justify-between items-center border-b border-gray-600">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-database text-indigo-400"></i>
                            <span class="text-xs font-bold uppercase tracking-widest text-gray-200">Supabase Cloud Manager</span>
                        </div>
                        <button @click="cloud.show = false"><i class="fa-solid fa-times"></i></button>
                    </div>
                    
                    <div class="flex-1 flex overflow-hidden">
                        <div class="w-72 bg-gray-900 p-4 border-r border-gray-700 flex flex-col gap-4">
                            
                            <div class="text-center p-2 bg-green-900/20 border border-green-900 rounded mb-4">
                                <i class="fa-solid fa-check-circle text-green-500 mb-1"></i>
                                <p class="text-[10px] text-green-400">Соединение установлено</p>
                            </div>
                            
                            <div class="mt-auto bg-gray-800 p-3 rounded border border-gray-600">
                                <h4 class="text-[10px] text-pink-400 font-bold uppercase mb-2">Сохранить текущий</h4>
                                <input type="text" x-ref="cloudSaveInput" x-model="cloud.saveName" placeholder="Название квеста..." class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-xs mb-2 text-white">
                                <button @click="saveToCloud()" class="w-full py-2 bg-pink-700 hover:bg-pink-600 rounded text-xs font-bold shadow-lg">ЗАПИСАТЬ В БД</button>
                            </div>
                        </div>

                        <div class="flex-1 p-4 overflow-y-auto bg-gray-800">
                            <h3 class="text-xs font-bold uppercase text-gray-400 mb-4 sticky top-0 bg-gray-800 py-2 border-b border-gray-700">
                                <i class="fa-solid fa-list mr-2"></i> Доступные квесты
                            </h3>
                            <div x-show="cloud.loading" class="text-center text-gray-500 py-10"><i class="fa-solid fa-spinner fa-spin text-2xl"></i><br>Загрузка...</div>
                            
                            <div class="grid grid-cols-1 gap-2">
                                <template x-for="q in cloud.list" :key="q.id">
                                    <div @click="loadFromCloud(q)" class="bg-gray-700 hover:bg-indigo-900 p-3 rounded border border-gray-600 cursor-pointer transition-all hover:border-indigo-500 group flex justify-between items-center">
                                        <div>
                                            <h4 class="font-bold text-sm text-white group-hover:text-indigo-300" x-text="q.title"></h4>
                                            <span class="text-[10px] text-gray-500">ID: <span x-text="q.id"></span> | <span x-text="new Date(q.created_at).toLocaleDateString()"></span></span>
                                        </div>
                                        <i class="fa-solid fa-download text-gray-600 group-hover:text-indigo-400"></i>
                                    </div>
                                </template>
                            </div>
                            
                            <div x-show="!cloud.loading && cloud.list.length === 0" class="text-center text-gray-500 py-10 italic">Список пуст или нет соединения</div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="isPlayMode" x-cloak class="absolute inset-0 bg-black/80 z-[100] flex items-center justify-center p-10">
                <div class="bg-gray-800 w-full max-w-2xl rounded-2xl border border-gray-600 shadow-2xl overflow-hidden flex flex-col">
                    <div class="bg-gray-700 p-4 flex justify-between items-center border-b border-gray-600">
                        <span class="text-xs font-bold uppercase tracking-widest text-gray-400">Тест сценария</span>
                        <button @click="isPlayMode = false"><i class="fa-solid fa-times"></i></button>
                    </div>
                    <div class="p-8">
                        <div class="mb-6">
                            <span class="text-blue-400 text-xs font-black uppercase tracking-widest border border-blue-900 bg-blue-900/20 px-2 py-0.5 rounded" x-text="sim.npc || '???'"></span>
                            <p class="text-xl mt-3 font-serif whitespace-pre-wrap leading-relaxed" x-text="sim.content || '...'"></p>
                        </div>
                        <div class="space-y-2">
                            <template x-for="opt in sim.options" :key="opt.id">
                                <button @click="makeChoice(opt.toNode)" class="w-full text-left p-4 bg-gray-700 hover:bg-blue-600 rounded-lg border border-gray-600 flex justify-between items-center transition-all group">
                                    <span x-text="opt.text"></span>
                                    <i class="fa-solid fa-chevron-right text-xs opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all"></i>
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ВАШИ КЛЮЧИ
        const SUPABASE_URL = 'https://vmwwvwtsznxwoswzdzui.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_hfVfEOEyUxTAl9TCGQLQdA_2qpquHGk';

        function questEditor() {
            return {
                editor: null,
                isPlayMode: false,
                isAuth: false, // Флаг авторизации
                worldState: {
                    gold: { type: 'number', value: 100 },
                    knows_truth: { type: 'bool', value: false }
                },
                npcList: ['Рассказчик', 'Трактирщик', 'Герой'],
                menu: { show: false, x: 0, y: 0, fromNode: null, fromPort: null },
                connEditor: { show: false, label: '', id: null, port: null },
                sim: { npc: '', content: '', options: [] },
                
                // --- SUPABASE CONFIG ---
                supabase: null,
                cloud: {
                    show: false,
                    url: SUPABASE_URL,
                    key: SUPABASE_KEY,
                    isAdmin: false,
                    list: [],
                    loading: false,
                    saveName: 'Новый квест'
                },

                init() {
                    // 1. Проверяем авторизацию из sessionStorage (от index.html)
                    const sessionAuth = sessionStorage.getItem('ct_supabase_auth');
                    if(sessionAuth === 'true') {
                        this.isAuth = true;
                        this.cloud.isAdmin = true; 
                        this.initSupabaseAuto(); // Авто-старт
                    }

                    const el = document.getElementById("drawflow");
                    this.editor = new Drawflow(el);
                    this.editor.start();
                    
                    if(Object.keys(this.editor.drawflow.Home.data).length === 0) {
                        this.addNodeAtPos('start', 50, 100);
                    }

                    this.editor.on('connectionCreated', this.onConnectionCreated.bind(this));
                    this.editor.on('connectionStart', (info) => {
                        this.menu.fromNode = info.node_id;
                        this.menu.fromPort = info.output_class;
                    });

                    const update = () => this.updateLabels();
                    this.editor.on('connectionRemoved', update);
                    this.editor.on('nodeMoved', update);
                    this.editor.on('zoom', update);
                    this.editor.on('translate', update);
                    this.editor.on('import', () => { setTimeout(() => this.restoreDataBindings(), 50); });
                },

                initSupabaseAuto() {
                    try {
                        this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                        console.log("Supabase connected automagically");
                    } catch(e) {
                        console.error("Auto-connect failed", e);
                    }
                },

                // --- CLOUD LOGIC ---
                
                openCloudModal(mode) {
                    this.cloud.show = true;
                    // Если мы уже подключены (isAuth), сразу грузим список
                    if(this.supabase) {
                        this.fetchQuests();
                    }
                    
                    if(mode === 'save') {
                        // Небольшая задержка, чтобы Alpine успел показать окно
                        setTimeout(() => {
                            if(this.$refs.cloudSaveInput) this.$refs.cloudSaveInput.focus();
                        }, 100);
                    }
                },

                // --- ФУНКЦИИ API ---

                async fetchQuests() {
                    if(!this.supabase) return;
                    this.cloud.loading = true;
                    const { data, error } = await this.supabase
                        .from('quests')
                        .select('id, title, created_at')
                        .order('created_at', { ascending: false });
                    
                    if(error) {
                        console.error("Load error:", error);
                    } else {
                        this.cloud.list = data;
                    }
                    this.cloud.loading = false;
                },

                async saveToCloud() {
                    if(!this.supabase) return;

                    const exportData = {
                        drawflow: this.editor.export(),
                        worldState: this.worldState,
                        npcList: this.npcList
                    };

                    const { data, error } = await this.supabase
                        .from('quests')
                        .insert([
                            { title: this.cloud.saveName, content: exportData }
                        ]);

                    if(error) {
                        alert("Ошибка сохранения: " + error.message);
                    } else {
                        alert("Квест успешно сохранен!");
                        this.fetchQuests();
                    }
                },

                async loadFromCloud(questMeta) {
                    if(!confirm(`Загрузить квест "${questMeta.title}"? Текущие данные будут потеряны.`)) return;
                    
                    this.cloud.loading = true;
                    const { data, error } = await this.supabase
                        .from('quests')
                        .select('content')
                        .eq('id', questMeta.id)
                        .single();

                    if(error) {
                        alert("Ошибка загрузки данных: " + error.message);
                    } else {
                        const json = data.content;
                        this.editor.import(json.drawflow || json);
                        if (json.worldState) this.worldState = json.worldState;
                        if (json.npcList) this.npcList = json.npcList;
                        this.restoreDataBindings();
                        this.cloud.show = false;
                    }
                    this.cloud.loading = false;
                },

                // --- LOCAL FILE LOGIC ---

                exportData() { 
                    const data = {
                        drawflow: this.editor.export(),
                        worldState: this.worldState,
                        npcList: this.npcList
                    };
                    const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'quest_project.json'; a.click();
                },

                importData(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            this.editor.import(json.drawflow || json);
                            if (json.worldState) this.worldState = json.worldState;
                            if (json.npcList) this.npcList = json.npcList;
                            this.restoreDataBindings();
                        } catch (err) {
                            alert("Ошибка файла!");
                        }
                    };
                    reader.readAsText(file);
                    e.target.value = '';
                },

                // --- NODE LOGIC ---

                addNPC() {
                    const name = prompt("Имя персонажа:");
                    if (name && !this.npcList.includes(name)) {
                        this.npcList.push(name);
                        this.updateAllDialogueSelects();
                    }
                },

                removeNPC(index) {
                    if(confirm(`Удалить персонажа "${this.npcList[index]}"?`)) {
                        this.npcList.splice(index, 1);
                        this.updateAllDialogueSelects();
                    }
                },

                updateAllDialogueSelects() {
                    const selects = document.querySelectorAll('.npc-selector');
                    selects.forEach(sel => {
                        const currentVal = sel.value;
                        sel.innerHTML = this.npcList.map(name => `<option value="${name}">${name}</option>`).join('');
                        if (this.npcList.includes(currentVal)) {
                            sel.value = currentVal;
                        } else if (this.npcList.length > 0) {
                            sel.value = this.npcList[0];
                            sel.dispatchEvent(new Event('change'));
                        }
                    });
                },

                bindNodeInputs(id, type, data) {
                    const el = document.getElementById(`node-${id}`);
                    if(!el) return;

                    if (type === 'dialogue') {
                        const ta = el.querySelector('textarea');
                        if(ta) {
                            ta.value = data.text || '';
                            ta.oninput = (e) => {
                                const n = this.editor.getNodeFromId(id);
                                n.data.text = e.target.value;
                                this.editor.updateNodeDataFromId(id, n.data);
                            };
                            ta.onmousedown = (e) => e.stopPropagation(); 
                        }
                        const sel = el.querySelector('.npc-selector');
                        if(sel) {
                            sel.innerHTML = this.npcList.map(name => `<option value="${name}">${name}</option>`).join('');
                            sel.value = data.npc || (this.npcList.length > 0 ? this.npcList[0] : '');
                            sel.onchange = (e) => {
                                const n = this.editor.getNodeFromId(id);
                                n.data.npc = e.target.value;
                                this.editor.updateNodeDataFromId(id, n.data);
                            };
                            sel.onmousedown = (e) => e.stopPropagation();
                        }
                    } 
                    else if (type === 'condition') {
                        const selects = el.querySelectorAll('select');
                        const input = el.querySelector('input');
                        if(selects.length >= 2 && input) {
                            selects[0].value = data.varName || Object.keys(this.worldState)[0];
                            selects[1].value = data.op || '==';
                            input.value = data.val || '';
                            const updateData = () => {
                                const n = this.editor.getNodeFromId(id);
                                n.data.varName = selects[0].value;
                                n.data.op = selects[1].value;
                                n.data.val = input.value;
                                this.editor.updateNodeDataFromId(id, n.data);
                            };
                            selects[0].onchange = updateData;
                            selects[1].onchange = updateData;
                            input.oninput = updateData;
                        }
                    }
                    else if (type === 'action') {
                        const list = el.querySelector('.act-list');
                        list.innerHTML = '';
                        if (data.actions && Array.isArray(data.actions)) {
                            data.actions.forEach((act, index) => {
                                this.createActionRow(list, id, act, index);
                            });
                        }
                        const btn = el.querySelector('button');
                        const newBtn = btn.cloneNode(true);
                        btn.parentNode.replaceChild(newBtn, btn);
                        newBtn.onclick = () => {
                            const n = this.editor.getNodeFromId(id);
                            if(!n.data.actions) n.data.actions = [];
                            const newAct = { var: Object.keys(this.worldState)[0], op: '=', val: 1 };
                            n.data.actions.push(newAct);
                            this.editor.updateNodeDataFromId(id, n.data);
                            this.createActionRow(list, id, newAct, n.data.actions.length - 1);
                        };
                    }
                },

                createActionRow(container, nodeId, actionData, index) {
                    const row = document.createElement('div');
                    row.className = "flex gap-1 items-center mb-1";
                    const varOpts = Object.keys(this.worldState).map(k => `<option value="${k}" ${k===actionData.var?'selected':''}>${k}</option>`).join('');
                    row.innerHTML = `
                        <select class="bg-gray-900 text-[9px] rounded p-0.5 text-blue-400 w-1/2 var-sel">${varOpts}</select>
                        <select class="bg-gray-800 text-[9px] rounded p-0.5 op-sel">
                            <option value="=" ${actionData.op==='='?'selected':''}>=</option>
                            <option value="+" ${actionData.op==='+'?'selected':''}>+</option>
                            <option value="-" ${actionData.op==='-'?'selected':''}>-</option>
                        </select>
                        <input type="text" class="bg-gray-800 text-[9px] rounded p-0.5 w-full val-inp" value="${actionData.val}">
                        <button class="text-red-500 hover:text-red-300 px-1 text-[9px] del-btn"><i class="fa-solid fa-times"></i></button>
                    `;
                    const updateRow = () => {
                        const n = this.editor.getNodeFromId(nodeId);
                        const allRows = container.querySelectorAll('div.flex');
                        const newActions = [];
                        allRows.forEach(r => {
                            newActions.push({
                                var: r.querySelector('.var-sel').value,
                                op: r.querySelector('.op-sel').value,
                                val: r.querySelector('.val-inp').value
                            });
                        });
                        n.data.actions = newActions;
                        this.editor.updateNodeDataFromId(nodeId, n.data);
                    };
                    row.querySelector('.var-sel').onchange = updateRow;
                    row.querySelector('.op-sel').onchange = updateRow;
                    row.querySelector('.val-inp').oninput = updateRow;
                    row.querySelector('.del-btn').onclick = () => { row.remove(); updateRow(); };
                    container.appendChild(row);
                },

                restoreDataBindings() {
                    const nodes = this.editor.export().drawflow.Home.data;
                    Object.values(nodes).forEach(node => {
                        this.bindNodeInputs(node.id, node.name, node.data);
                    });
                    this.updateLabels();
                },

                onConnectionCreated(info) {
                    const nodeOut = this.editor.getNodeFromId(info.output_id);
                    const nodeIn = this.editor.getNodeFromId(info.input_id);
                    if(nodeOut.outputs[info.output_class].connections.length > 1) {
                        this.editor.removeSingleConnection(info.output_id, info.input_id, info.output_class, info.input_class);
                        return;
                    }
                    if(nodeIn.inputs[info.input_class].connections.length > 1) {
                        this.editor.removeSingleConnection(info.output_id, info.input_id, info.output_class, info.input_class);
                        return;
                    }
                    if(nodeOut.name === 'dialogue') {
                        const currentOuts = Object.keys(nodeOut.outputs).length;
                        if(info.output_class === `output_${currentOuts}`) {
                            this.editor.addNodeOutput(info.output_id);
                        }
                    }
                    this.updateLabels();
                },

                handleGlobalMove(e) { if (e.buttons === 1) this.updateLabels(); },

                handleDblClick(e) {
                    const outputEl = e.target.closest('.output');
                    if (outputEl) {
                        const nodeEl = outputEl.closest('.drawflow-node');
                        const nodeId = nodeEl.id.replace('node-', '');
                        const node = this.editor.getNodeFromId(nodeId);
                        if (node.name === 'dialogue') {
                            const classes = Array.from(outputEl.classList);
                            const portClass = classes.find(c => c.startsWith('output_'));
                            if (portClass) {
                                this.connEditor.id = nodeId;
                                this.connEditor.port = portClass;
                                this.connEditor.label = node.data.labels?.[portClass] || "";
                                this.connEditor.show = true;
                                this.$nextTick(() => this.$refs.connInput.focus());
                            }
                        }
                    }
                },

                saveAndCloseConn() {
                    let node = this.editor.getNodeFromId(this.connEditor.id);
                    if(!node.data.labels) node.data.labels = {};
                    node.data.labels[this.connEditor.port] = this.connEditor.label;
                    this.editor.updateNodeDataFromId(this.connEditor.id, node.data);
                    this.updateLabels();
                    this.closeMenus();
                },

                updateLabels() {
                    requestAnimationFrame(() => {
                        const container = document.querySelector('#drawflow .drawflow');
                        if(!container) return;
                        const existing = container.querySelectorAll('.connection-label');
                        existing.forEach(el => el.remove());

                        const data = this.editor.export().drawflow.Home.data;
                        const zoom = this.editor.zoom;
                        const canvasRect = container.getBoundingClientRect();

                        Object.values(data).forEach(node => {
                            if(!node.outputs) return;
                            Object.keys(node.outputs).forEach(outKey => {
                                const output = node.outputs[outKey];
                                const labelText = node.data.labels?.[outKey];
                                if(labelText && output.connections.length > 0) {
                                    output.connections.forEach(conn => {
                                        const outElem = document.querySelector(`#node-${node.id} .outputs .${outKey}`);
                                        const inElem = document.querySelector(`#node-${conn.node} .inputs .${conn.output}`);
                                        if(outElem && inElem) {
                                            const outRect = outElem.getBoundingClientRect();
                                            const inRect = inElem.getBoundingClientRect();
                                            const startX = (outRect.left + outRect.width/2 - canvasRect.left) / zoom;
                                            const startY = (outRect.top + outRect.height/2 - canvasRect.top) / zoom;
                                            const endX = (inRect.left + inRect.width/2 - canvasRect.left) / zoom;
                                            const endY = (inRect.top + inRect.height/2 - canvasRect.top) / zoom;
                                            const midX = startX * 0.125 + (startX + Math.abs(endX - startX) * 0.5) * 0.75 + endX * 0.125;
                                            const midY = (startY + endY) / 2; 
                                            const el = document.createElement('div');
                                            el.className = 'connection-label';
                                            el.innerText = labelText;
                                            el.style.left = `${midX}px`;
                                            el.style.top = `${midY}px`;
                                            container.appendChild(el);
                                        }
                                    });
                                }
                            });
                        });
                    });
                },

                addNodeAtPos(type, x, y) {
                    let html = '', hClass = '', title = '', inputs = 1, outputs = 1;
                    let data = { labels: {}, actions: [], text: '', varName: '', op: '==', val: '', npc: '' };

                    switch(type) {
                        case 'start':
                            title = 'START'; hClass = 'header-start'; inputs = 0;
                            html = `<div class="node-content text-center italic text-gray-500">Старт<br><span class="text-[9px]">Входная точка</span></div>`;
                            break;
                        case 'dialogue':
                            title = 'DIALOGUE'; hClass = 'header-dialogue'; outputs = 2;
                            html = `<div class="node-content flex flex-col gap-2">
                                <select class="npc-selector nodrag w-full bg-gray-800 text-xs text-blue-300 font-bold border border-gray-700 rounded p-1 outline-none"></select>
                                <textarea class="nodrag w-full bg-gray-900 border-none text-xs rounded p-1 text-white focus:ring-1 ring-blue-500 outline-none" rows="3" placeholder="Текст NPC..."></textarea>
                            </div>`;
                            break;
                        case 'action':
                            title = 'ACTIONS'; hClass = 'header-action';
                            html = `<div class="node-content space-y-2">
                                <div class="act-list space-y-1"></div>
                                <button class="w-full py-1 bg-green-900/30 hover:bg-green-900/50 text-green-400 text-[9px] font-bold border border-green-900/50 rounded transition-colors">+ ДЕЙСТВИЕ</button>
                            </div>`;
                            break;
                        case 'condition':
                            title = 'CONDITION'; hClass = 'header-condition'; outputs = 2;
                            html = `<div class="node-content space-y-2">
                                <select class="w-full bg-gray-900 text-[10px] border-none rounded p-1 text-blue-400 focus:ring-1 outline-none">
                                    ${Object.keys(this.worldState).map(k => `<option value="${k}">${k}</option>`).join('')}
                                </select>
                                <div class="flex gap-1">
                                    <select class="bg-gray-800 text-[10px] rounded outline-none"><option>==</option><option>&gt;</option><option>&lt;</option></select>
                                    <input type="text" class="bg-gray-800 text-[10px] rounded w-full p-1 outline-none" placeholder="Значение">
                                </div>
                            </div>`;
                            break;
                    }

                    const temp = `<div><div class="node-header ${hClass}"><i class="fa-solid ${this.getIcon(type)}"></i><span>${title}</span></div>${html}</div>`;
                    const id = this.editor.addNode(type, inputs, outputs, x, y, type, data, temp);
                    this.bindNodeInputs(id, type, data);
                    return id;
                },

                getIcon(t) { return {start:'fa-play', dialogue:'fa-comment', condition:'fa-code-branch', action:'fa-bolt'}[t] || 'fa-circle'; },
                
                addFlag() {
                    const n = prompt("Имя переменной (eng):");
                    if(!n) return;
                    const t = prompt("Тип (bool, number, string):", "number");
                    this.worldState[n] = { type: t, value: t === 'number' ? 0 : t === 'string' ? "" : false };
                },
                drag(ev, t) { ev.dataTransfer.setData("node", t); },
                drop(ev) {
                    ev.preventDefault();
                    this.addNodeAtPos(ev.dataTransfer.getData("node"), ev.clientX - 300, ev.clientY - 100);
                },
                openContextMenu(e) {
                    this.closeMenus();
                    this.menu.x = e.clientX;
                    this.menu.y = e.clientY;
                    this.menu.show = true;
                },
                handleMouseUp(e) {
                    if (this.editor.connection && !e.target.closest('.drawflow-node')) {
                        this.menu.x = e.clientX;
                        this.menu.y = e.clientY;
                        this.menu.show = true;
                    }
                },
                closeMenus() {
                    this.menu.show = false;
                    this.connEditor.show = false;
                },
                createFromMenu(type) {
                    const rect = this.editor.precanvas.getBoundingClientRect();
                    const x = (this.menu.x - rect.left) / this.editor.zoom;
                    const y = (this.menu.y - rect.top) / this.editor.zoom;
                    const id = this.addNodeAtPos(type, x, y);
                    if(this.menu.fromNode) {
                        this.editor.addConnection(this.menu.fromNode, id, this.menu.fromPort, 'input_1');
                    }
                    this.closeMenus();
                    this.menu.fromNode = null;
                },
                
                togglePlayMode() {
                    this.isPlayMode = !this.isPlayMode;
                    if(this.isPlayMode) this.resetSimulation();
                },
                resetSimulation() {
                    const nodes = this.editor.export().drawflow.Home.data;
                    const start = Object.values(nodes).find(n => n.name === 'start');
                    if(start) {
                        this.processNode(start.id);
                    } else {
                        alert("Ошибка: Не найден узел START!");
                        this.isPlayMode = false;
                    }
                },
                processNode(id) {
                    const node = this.editor.getNodeFromId(id);
                    const data = node.data;

                    if(node.name === 'start') {
                        this.sim.npc = "System";
                        this.sim.content = "Начало...";
                        this.sim.options = this.getConnections(id);
                    } else if(node.name === 'dialogue') {
                        this.sim.npc = data.npc || "???";
                        this.sim.content = data.text || "(Пустой диалог)";
                        this.sim.options = this.getConnections(id);
                    } else if(node.name === 'action') {
                        if(data.actions) {
                            data.actions.forEach(act => {
                                const f = this.worldState[act.var];
                                if(f) {
                                    let val = act.val;
                                    if(f.type === 'number') val = Number(val);
                                    if(act.op === '=') f.value = val;
                                    else if(act.op === '+') f.value += val;
                                    else if(act.op === '-') f.value -= val;
                                }
                            });
                        }
                        const next = this.getConnections(id)[0];
                        if(next) this.processNode(next.toNode);
                        else {
                            this.sim.npc = "System";
                            this.sim.content = "Конец ветки (Action)";
                            this.sim.options = [];
                        }
                    } else if(node.name === 'condition') {
                        const f = this.worldState[data.varName];
                        let res = false;
                        if(f) {
                            let target = data.val;
                            if(f.type === 'number') target = Number(target);
                            if(data.op === '==') res = f.value == target;
                            else if(data.op === '>') res = f.value > target;
                            else if(data.op === '<') res = f.value < target;
                        }
                        const conns = this.getConnections(id);
                        const next = res ? conns.find(c => c.port === 'output_1') : conns.find(c => c.port === 'output_2');
                        if(next) this.processNode(next.toNode);
                        else {
                            this.sim.npc = "System";
                            this.sim.content = `Условие: ${res}. Дальше пути нет.`;
                            this.sim.options = [];
                        }
                    }
                },
                getConnections(id) {
                    const node = this.editor.getNodeFromId(id);
                    const options = [];
                    Object.keys(node.outputs).forEach(port => {
                        const conns = node.outputs[port].connections;
                        if(conns.length > 0) {
                            options.push({
                                id: port,
                                port: port,
                                text: node.data.labels?.[port] || "Далее...",
                                toNode: conns[0].node
                            });
                        }
                    });
                    return options;
                },
                makeChoice(toId) { this.processNode(toId); }
            }
        }
    </script>
</body>
</html>