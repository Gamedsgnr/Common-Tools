<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Architect 5.0 | Pro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="quest_architect/quest_architect.css">
</head>
<body>
    <div id="app" class="h-screen w-screen flex flex-col relative">
        <input type="file" ref="loadInput" class="hidden" accept="application/json" @change="loadProject">

        <header class="h-14 bg-slate-900 border-b border-slate-700 flex items-center justify-between px-6 shrink-0 z-50">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-diagram-project text-blue-500 text-xl"></i>
                <h1 class="font-bold text-lg text-slate-100">Quest <span class="text-blue-500">Architect</span></h1>
                <div v-if="currentProjectTitle" class="ml-3 px-2 py-0.5 text-[10px] uppercase tracking-wider text-slate-300 bg-slate-800/70 border border-slate-700 rounded">
                    {{ currentProjectTitle }}
                </div>
            </div>
            <div class="flex gap-3">
                <button @click="triggerLoad" class="px-3 py-1.5 text-xs font-bold bg-slate-800 hover:bg-slate-700 rounded border border-slate-600 transition">
                    <i class="fa-solid fa-folder-open mr-1"></i> LOAD
                </button>
                <button @click="saveProject" class="px-3 py-1.5 text-xs font-bold bg-slate-800 hover:bg-slate-700 rounded border border-slate-600 transition">
                    <i class="fa-solid fa-save mr-1"></i> SAVE
                </button>
                <div class="auth-gated-btn-wrap">
                    <button
                        @click="exportPanelOpen = true"
                        :disabled="!isAuth"
                        class="px-3 py-1.5 text-xs font-bold bg-indigo-900/60 hover:bg-indigo-800/70 text-indigo-100 rounded border border-indigo-600/60 transition disabled:opacity-75 disabled:cursor-not-allowed disabled:hover:bg-indigo-900/60">
                        <i class="fa-solid fa-file-export mr-1"></i> VALIDATE / EXPORT
                    </button>
                    <button
                        v-if="!isAuth"
                        type="button"
                        class="auth-gated-btn-overlay"
                        aria-label="Только для авторизованных пользователей"
                        @click="notifyAuthRequired('export')"></button>
                    <div v-if="authHintKey === 'export'" class="auth-gated-toast">
                        Только для авторизованных пользователей
                    </div>
                </div>
                <div class="auth-gated-btn-wrap">
                    <button
                        @click="openCloudModal('load')"
                        :disabled="!isAuth"
                        class="px-3 py-1.5 text-xs font-bold bg-sky-900/60 hover:bg-sky-800/70 text-sky-200 rounded border border-sky-700/60 transition disabled:opacity-75 disabled:cursor-not-allowed disabled:hover:bg-sky-900/60">
                        <i class="fa-solid fa-cloud-arrow-down mr-1"></i> LOAD CLOUD
                    </button>
                    <button
                        v-if="!isAuth"
                        type="button"
                        class="auth-gated-btn-overlay"
                        aria-label="Только для авторизованных пользователей"
                        @click="notifyAuthRequired('load_cloud')"></button>
                    <div v-if="authHintKey === 'load_cloud'" class="auth-gated-toast">
                        Только для авторизованных пользователей
                    </div>
                </div>
                <div class="auth-gated-btn-wrap">
                    <button
                        @click="openCloudModal('save')"
                        :disabled="!isAuth"
                        class="px-3 py-1.5 text-xs font-bold bg-emerald-900/60 hover:bg-emerald-800/70 text-emerald-200 rounded border border-emerald-700/60 transition disabled:opacity-75 disabled:cursor-not-allowed disabled:hover:bg-emerald-900/60">
                        <i class="fa-solid fa-cloud-arrow-up mr-1"></i> SAVE CLOUD
                    </button>
                    <button
                        v-if="!isAuth"
                        type="button"
                        class="auth-gated-btn-overlay"
                        aria-label="Только для авторизованных пользователей"
                        @click="notifyAuthRequired('save_cloud')"></button>
                    <div v-if="authHintKey === 'save_cloud'" class="auth-gated-toast">
                        Только для авторизованных пользователей
                    </div>
                </div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden relative">
            
            <div class="flex-1 relative overflow-hidden bg-slate-950" ref="canvasContainer" 
                 @wheel.prevent="handleWheel"
                 @mousedown="onCanvasMouseDown">
                
                <div v-if="selectionBox.active"
                     class="selection-box"
                     :style="{ left: selectionBox.x + 'px', top: selectionBox.y + 'px', width: selectionBox.w + 'px', height: selectionBox.h + 'px' }"></div>
                
                <div class="origin-top-left absolute w-full h-full"
                     :style="{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${scale})` }">
                    
                    <div class="grid-canvas" style="width: 10000px; height: 10000px; transform: translate(-5000px, -5000px);"></div>

                    <svg class="connections-layer overflow-visible">
                        <path v-for="conn in connections" :key="conn.id"
                              :d="conn.path"
                              stroke="#64748b" stroke-width="3" fill="none"
                              class="connection-path"
                              :class="{'!stroke-blue-500 !stroke-[4px]': selectedConnId === conn.id}"
                              @click.stop="onConnectionClick(conn.id, $event)" />
                        
                        <path v-if="dragLine"
                              :d="dragLine.path"
                              stroke="#3b82f6" stroke-width="3" stroke-dasharray="8,4" fill="none" 
                              class="pointer-events-none opacity-80" />
                    </svg>

                    <div v-for="node in nodes" :key="node.id"
                         class="node-wrapper"
                         :class="{ 'selected': selectedNodeIds.includes(node.id), 'is-group': node.type === 'group' }"
                         :style="getNodeStyle(node)"
                         :data-node-id="node.id"
                         @mousedown.stop="onNodeMouseDown(node, $event)">
                        
                        <div class="node-header"
                             :class="node.type === 'group' ? '' : ('type-' + node.type)"
                             :style="getNodeHeaderStyle(node)"
                             @mousedown.stop="onNodeMouseDown(node, $event)">
                            <div class="flex items-center gap-2 min-w-0 text-xs font-bold text-white tracking-wide"
                                 :style="getNodeHeaderContentStyle(node)">
                                <i :class="getNodeIcon(node.type)"></i>
                                <button v-if="isNodeNameEditable(node.type) && editingNodeNameId !== node.id"
                                        type="button"
                                        class="node-header-name node-header-name-btn"
                                        @mousedown.stop
                                        @click.stop="startNodeNameEdit(node)"
                                        title="Rename node">
                                    {{ getNodeDisplayName(node) }}
                                </button>
                                <span v-else-if="editingNodeNameId !== node.id" class="node-header-name">
                                    {{ getNodeDisplayName(node) }}
                                </span>
                                <input v-else
                                       :data-node-name-input="node.id"
                                       v-model="nodeNameDraft"
                                       class="node-header-name-input"
                                       @mousedown.stop
                                       @keydown.enter.prevent="commitNodeNameEdit(node)"
                                       @keydown.esc.prevent="cancelNodeNameEdit"
                                       @blur="commitNodeNameEdit(node)" />
                            </div>
                            <div class="flex items-center gap-2">
                                <button v-if="node.type !== 'start' && node.type !== 'group'" @click.stop="deleteNode(node.id)" class="text-white/40 hover:text-white">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                            
                            <div v-if="canHaveInputSocket(node)" 
                                 class="socket socket-in hover:border-blue-400 bg-slate-900"
                                 :class="{ 'socket-occupied': isSocketOccupied(node.id, 'in') }"
                                 :data-node-id="node.id"
                                 data-socket-id="in"
                                 @mouseup="onSocketMouseUp(node.id, 'in')"></div>
                        </div>

                        <div class="p-3 text-slate-300 text-sm relative">
                            
                            <div v-if="node.type === 'start'" class="py-2 text-center text-xs text-slate-400">
                                Entry point
                                <div class="socket socket-out hover:border-emerald-400" 
                                     :class="{ 'socket-occupied': isSocketOccupied(node.id, 'default') }"
                                     :data-node-id="node.id"
                                     data-socket-id="default"
                                     @mousedown.stop.prevent="startDragLine(node.id, 'default', $event)"></div>
                            </div>

                            <div v-if="node.type === 'dialog'">
                                <select v-model="node.data.speakerId" @mousedown.stop
                                        class="w-full bg-slate-900/70 border border-slate-700 rounded px-2 py-1 text-xs text-blue-300 font-bold mb-2">
                                    <option :value="null">Character...</option>
                                    <option v-for="c in characters" :value="c.id">{{ c.name }}</option>
                                </select>
                                <textarea v-model="node.data.text" @mousedown.stop rows="3"
                                          class="w-full bg-slate-900/60 border border-slate-700/50 rounded p-2 text-xs text-slate-200 italic mb-3 min-h-[60px] resize-none"></textarea>
                                <div class="space-y-2">
                                    <div v-for="(choice, idx) in node.data.choices" :key="idx" 
                                         class="relative bg-slate-800 border border-slate-700 p-2 rounded text-xs flex justify-between translate-x-2">
                                        <input v-model="choice.text" @mousedown.stop
                                               class="flex-1 bg-transparent outline-none text-slate-200 pr-6"
                                               placeholder="Reply..." />
                                        <div class="socket socket-out" 
                                             :class="{ 'socket-occupied': isSocketOccupied(node.id, 'choice-' + idx) }"
                                             :data-node-id="node.id"
                                             :data-socket-id="'choice-' + idx"
                                             @mousedown.stop.prevent="startDragLine(node.id, 'choice-' + idx, $event)"></div>
                                    </div>
                                </div>
                                <button @click.stop="node.data.choices.push({text:'New Option'})"
                                        class="mt-2 w-full py-1 text-[10px] border border-dashed border-slate-600 text-slate-400 hover:text-white hover:border-slate-400 rounded transition">
                                    + Add reply
                                </button>
                            </div>

                            <div v-if="node.type === 'action'">
                                <div v-if="!node.data.ops.length" class="text-center text-xs text-slate-500 py-2">No actions</div>
                                <div v-else class="space-y-2">
                                    <div v-for="(op, i) in node.data.ops" :key="op.id" class="bg-purple-900/20 px-2 py-2 rounded text-xs border border-purple-500/30 space-y-2">
                                        <div class="flex items-center gap-2">
                                            <select v-model="op.varId" @change="onActionVarChange(op)" @mousedown.stop
                                                    class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-purple-200">
                                                <option :value="null">Variable...</option>
                                                <option v-for="v in variables" :value="v.id">{{ v.name }}</option>
                                            </select>
                                            <button @click.stop="removeActionOp(node, i)" class="text-slate-500 hover:text-red-400">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </div>

                                        <div v-if="!op.varId" class="text-[10px] text-slate-500">
                                            Select a variable.
                                        </div>

                                        <div v-else-if="getVarType(op.varId) === 'bool'">
                                            <label class="flex items-center gap-2 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-[11px] text-emerald-200">
                                                <input type="checkbox" v-model="op.val" @mousedown.stop class="accent-emerald-500">
                                                <span>Set {{ op.val ? 'True' : 'False' }}</span>
                                            </label>
                                        </div>

                                        <div v-else-if="getVarType(op.varId) === 'enum'">
                                            <select v-model="op.val" @mousedown.stop class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-purple-200">
                                                <option v-for="opt in getVarOptions(op.varId)" :value="opt">{{ opt }}</option>
                                            </select>
                                        </div>

                                        <div v-else-if="getVarType(op.varId) === 'string'">
                                            <input type="text" v-model="op.val" @mousedown.stop
                                                   class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-purple-200"
                                                   placeholder="Text..." />
                                        </div>

                                        <div v-else class="flex gap-2">
                                            <select v-model="op.op" @mousedown.stop class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-purple-200">
                                                <option value="add">+</option>
                                                <option value="sub">-</option>
                                                <option value="mul">*</option>
                                                <option value="div">/</option>
                                                <option value="set">=</option>
                                            </select>
                                            <input type="number" v-model.number="op.val" @mousedown.stop
                                                   class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-purple-200">
                                        </div>
                                    </div>
                                </div>
                                <button @click.stop="addActionOp(node)"
                                        class="mt-2 w-full py-1 text-[10px] border border-dashed border-purple-700 text-purple-300 hover:text-white hover:border-purple-400 rounded transition">
                                    + Extra action
                                </button>
                                <div class="socket socket-out hover:border-purple-400" 
                                     :class="{ 'socket-occupied': isSocketOccupied(node.id, 'default') }"
                                     :data-node-id="node.id"
                                     data-socket-id="default"
                                     @mousedown.stop.prevent="startDragLine(node.id, 'default', $event)"></div>
                            </div>

                            <div v-if="node.type === 'condition'">
                                <div class="bg-yellow-900/20 p-2 rounded border border-yellow-500/20 mb-3 space-y-2">
                                    <select v-model="node.data.varId" @mousedown.stop
                                            class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-yellow-200">
                                        <option :value="null">Variable...</option>
                                        <option v-for="v in variables" :value="v.id">{{ v.name }}</option>
                                    </select>
                                    <div v-if="node.data.varId">
                                        <div v-if="getVarType(node.data.varId) === 'bool'" class="flex gap-2">
                                            <select v-model="node.data.op" @mousedown.stop class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-yellow-200">
                                                <option value="eq">==</option>
                                                <option value="neq">!=</option>
                                            </select>
                                            <label class="flex items-center gap-2 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-emerald-200">
                                                <input type="checkbox" v-model="node.data.val" @mousedown.stop class="accent-emerald-500">
                                                <span>{{ node.data.val ? 'True' : 'False' }}</span>
                                            </label>
                                        </div>
                                        <div v-else-if="getVarType(node.data.varId) === 'enum'" class="flex gap-2">
                                            <select v-model="node.data.op" @mousedown.stop class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-yellow-200">
                                                <option value="eq">==</option>
                                                <option value="neq">!=</option>
                                            </select>
                                            <select v-model="node.data.val" @mousedown.stop
                                                    class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-yellow-200">
                                                <option v-for="opt in getVarOptions(node.data.varId)" :value="opt">{{ opt }}</option>
                                            </select>
                                        </div>
                                        <div v-else-if="getVarType(node.data.varId) === 'string'" class="flex gap-2">
                                            <select v-model="node.data.op" @mousedown.stop class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-yellow-200">
                                                <option value="eq">==</option>
                                                <option value="neq">!=</option>
                                            </select>
                                            <input type="text" v-model="node.data.val" @mousedown.stop
                                                   class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-yellow-200">
                                        </div>
                                        <div v-else class="flex gap-2">
                                            <select v-model="node.data.op" @mousedown.stop class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-yellow-200">
                                                <option value="eq">==</option>
                                                <option value="neq">!=</option>
                                                <option value="gt">&gt;</option>
                                                <option value="lt">&lt;</option>
                                            </select>
                                            <input type="number" v-model.number="node.data.val" @mousedown.stop
                                                   class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-yellow-200">
                                        </div>
                                    </div>
                                </div>
                                <div class="relative h-16 flex flex-col justify-between">
                                    <div class="flex items-center justify-end gap-0 pr-3" style="transform: translateX(37px);">
                                        <span class="text-[10px] font-bold text-emerald-500">TRUE</span>
                                        <div class="socket socket-cond socket-cond-true"
                                             :class="{ 'socket-occupied': isSocketOccupied(node.id, 'true') }"
                                             :data-node-id="node.id"
                                             data-socket-id="true"
                                             @mousedown.stop.prevent="startDragLine(node.id, 'true', $event)"></div>
                                    </div>
                                    <div class="flex items-center justify-end gap-0 pr-3" style="transform: translateX(37px);">
                                        <span class="text-[10px] font-bold text-rose-500">FALSE</span>
                                        <div class="socket socket-cond socket-cond-false"
                                             :class="{ 'socket-occupied': isSocketOccupied(node.id, 'false') }"
                                             :data-node-id="node.id"
                                             data-socket-id="false"
                                             @mousedown.stop.prevent="startDragLine(node.id, 'false', $event)"></div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="node.type === 'switcher'">
                                <div class="bg-sky-900/20 p-2 rounded border border-sky-500/20 mb-3 space-y-2">
                                    <select v-model="node.data.varId" @mousedown.stop @change="onSwitcherVarChange(node)"
                                            class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-sky-200">
                                        <option :value="null">Variable...</option>
                                        <option v-for="v in variables" :value="v.id">{{ v.name }}</option>
                                    </select>
                                </div>

                                <div v-if="!node.data.cases.length" class="text-center text-[10px] text-slate-500 py-1">
                                    No cases
                                </div>
                                <div class="space-y-2">
                                    <div v-for="(c, idx) in node.data.cases" :key="c.id"
                                         class="relative bg-slate-800 border border-slate-700 p-2 rounded text-xs flex items-center gap-2 translate-x-2 pr-6">
                                        <template v-if="!node.data.varId">
                                            <span class="text-[10px] text-slate-500">Select a variable</span>
                                        </template>
                                        <template v-else>
                                            <template v-if="getVarType(node.data.varId) === 'enum'">
                                                <select v-model="c.value" @mousedown.stop
                                                        class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-sky-200">
                                                    <option v-for="opt in getVarOptions(node.data.varId)" :value="opt">{{ opt }}</option>
                                                </select>
                                            </template>
                                            <template v-else-if="getVarType(node.data.varId) === 'string'">
                                                <input v-model="c.value" @mousedown.stop
                                                       class="flex-1 bg-transparent outline-none text-slate-200"
                                                       placeholder="Value..." />
                                            </template>
                                            <template v-else-if="getVarType(node.data.varId) === 'bool'">
                                                <select v-model="c.value" @mousedown.stop
                                                        class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-sky-200">
                                                    <option :value="true">True</option>
                                                    <option :value="false">False</option>
                                                </select>
                                            </template>
                                            <template v-else>
                                                <input type="number" v-model.number="c.value" @mousedown.stop
                                                       class="flex-1 bg-transparent outline-none text-slate-200"
                                                       placeholder="0" />
                                            </template>
                                        </template>
                                        <button @click.stop="removeSwitcherCase(node, c)" class="text-slate-500 hover:text-red-400">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                        <div class="socket socket-out case-socket" 
                                             :class="{ 'socket-occupied': isSocketOccupied(node.id, c.socketId) }"
                                             :data-node-id="node.id"
                                             :data-socket-id="c.socketId"
                                             @mousedown.stop.prevent="startDragLine(node.id, c.socketId, $event)"></div>
                                    </div>
                                </div>
                                <button @click.stop="addSwitcherCase(node)"
                                        class="mt-2 w-full py-1 text-[10px] border border-dashed border-sky-700 text-sky-300 hover:text-white hover:border-sky-400 rounded transition">
                                    + Add case
                                </button>

                                <div class="relative mt-3 bg-slate-900/40 border border-slate-700 rounded p-2 text-[10px] flex items-center justify-between translate-x-2">
                                    <span class="text-slate-400">DEFAULT</span>
                                    <div class="socket socket-out" 
                                         :class="{ 'socket-occupied': isSocketOccupied(node.id, 'default') }"
                                         :data-node-id="node.id"
                                         data-socket-id="default"
                                         @mousedown.stop.prevent="startDragLine(node.id, 'default', $event)"></div>
                                </div>
                            </div>

                            <div v-if="node.type === 'wait_event'">
                                <div class="bg-cyan-900/20 p-2 rounded border border-cyan-500/25 mb-2 space-y-2">
                                    <input v-model="node.data.eventKey" @mousedown.stop
                                           class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-cyan-100"
                                           placeholder="Event key: quest.bandits_cleared" />
                                    <input v-model="node.data.note" @mousedown.stop
                                           class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-cyan-200/90"
                                           placeholder="Optional note..." />
                                </div>
                                <div class="relative mt-2 bg-slate-900/40 border border-slate-700 rounded p-2 text-[10px] flex items-center justify-between translate-x-2">
                                    <span class="text-cyan-300/80 uppercase tracking-wide">Resume</span>
                                    <div class="socket socket-out"
                                         :class="{ 'socket-occupied': isSocketOccupied(node.id, 'default') }"
                                         :data-node-id="node.id"
                                         data-socket-id="default"
                                         @mousedown.stop.prevent="startDragLine(node.id, 'default', $event)"></div>
                                </div>
                            </div>

                            <div v-if="node.type === 'wait_condition'">
                                <div class="bg-amber-900/20 p-2 rounded border border-amber-500/25 mb-2 space-y-2">
                                    <select v-model="node.data.varId" @mousedown.stop
                                            class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-amber-200">
                                        <option :value="null">Variable...</option>
                                        <option v-for="v in variables" :value="v.id">{{ v.name }}</option>
                                    </select>
                                    <div v-if="node.data.varId">
                                        <div v-if="getVarType(node.data.varId) === 'bool'" class="flex gap-2">
                                            <select v-model="node.data.op" @mousedown.stop class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-amber-200">
                                                <option value="eq">==</option>
                                                <option value="neq">!=</option>
                                            </select>
                                            <label class="flex items-center gap-2 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-emerald-200">
                                                <input type="checkbox" v-model="node.data.val" @mousedown.stop class="accent-emerald-500">
                                                <span>{{ node.data.val ? 'True' : 'False' }}</span>
                                            </label>
                                        </div>
                                        <div v-else-if="getVarType(node.data.varId) === 'enum'" class="flex gap-2">
                                            <select v-model="node.data.op" @mousedown.stop class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-amber-200">
                                                <option value="eq">==</option>
                                                <option value="neq">!=</option>
                                            </select>
                                            <select v-model="node.data.val" @mousedown.stop class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-amber-200">
                                                <option v-for="opt in getVarOptions(node.data.varId)" :value="opt">{{ opt }}</option>
                                            </select>
                                        </div>
                                        <div v-else-if="getVarType(node.data.varId) === 'string'" class="flex gap-2">
                                            <select v-model="node.data.op" @mousedown.stop class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-amber-200">
                                                <option value="eq">==</option>
                                                <option value="neq">!=</option>
                                            </select>
                                            <input type="text" v-model="node.data.val" @mousedown.stop class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-amber-200">
                                        </div>
                                        <div v-else class="flex gap-2">
                                            <select v-model="node.data.op" @mousedown.stop class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-amber-200">
                                                <option value="eq">==</option>
                                                <option value="neq">!=</option>
                                                <option value="gt">&gt;</option>
                                                <option value="lt">&lt;</option>
                                            </select>
                                            <input type="number" v-model.number="node.data.val" @mousedown.stop class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-amber-200">
                                        </div>
                                    </div>
                                </div>
                                <div class="relative mt-2 bg-slate-900/40 border border-slate-700 rounded p-2 text-[10px] flex items-center justify-between translate-x-2">
                                    <span class="text-amber-300/80 uppercase tracking-wide">When true</span>
                                    <div class="socket socket-out"
                                         :class="{ 'socket-occupied': isSocketOccupied(node.id, 'default') }"
                                         :data-node-id="node.id"
                                         data-socket-id="default"
                                         @mousedown.stop.prevent="startDragLine(node.id, 'default', $event)"></div>
                                </div>
                            </div>

                            <div v-if="node.type === 'objective_set' || node.type === 'objective_complete' || node.type === 'objective_fail'">
                                <div class="bg-emerald-900/18 p-2 rounded border border-emerald-500/25 mb-2 space-y-2">
                                    <input v-model="node.data.objectiveId" @mousedown.stop
                                           class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-emerald-100"
                                           placeholder="Objective id: quest_find_relic" />
                                    <textarea v-if="node.type === 'objective_set'" v-model="node.data.objectiveText" @mousedown.stop rows="2"
                                              class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-emerald-100 resize-none"
                                              placeholder="Objective text in journal..."></textarea>
                                    <input v-else v-model="node.data.reason" @mousedown.stop
                                           class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-emerald-100"
                                           placeholder="Optional reason..." />
                                </div>
                                <div class="relative mt-2 bg-slate-900/40 border border-slate-700 rounded p-2 text-[10px] flex items-center justify-between translate-x-2">
                                    <span class="text-emerald-300/80 uppercase tracking-wide">Continue</span>
                                    <div class="socket socket-out"
                                         :class="{ 'socket-occupied': isSocketOccupied(node.id, 'default') }"
                                         :data-node-id="node.id"
                                         data-socket-id="default"
                                         @mousedown.stop.prevent="startDragLine(node.id, 'default', $event)"></div>
                                </div>
                            </div>

                            <div v-if="node.type === 'quest_end'">
                                <div class="bg-indigo-900/24 p-2 rounded border border-indigo-500/30 mb-2 space-y-2">
                                    <select v-model="node.data.result" @mousedown.stop
                                            class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-indigo-100">
                                        <option value="complete">Complete</option>
                                        <option value="fail">Fail</option>
                                        <option value="abort">Abort</option>
                                    </select>
                                    <input v-model="node.data.endingNote" @mousedown.stop
                                           class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-indigo-100"
                                           placeholder="Optional ending note..." />
                                </div>
                                <div class="bg-indigo-950/40 border border-indigo-500/30 rounded p-2 text-[10px] text-indigo-200/85 uppercase tracking-wide text-center">
                                    Terminal node
                                </div>
                            </div>

                            <div v-if="node.type === 'link_state'">
                                <div class="bg-red-900/20 p-2 rounded border border-red-500/25 mb-2 space-y-2">
                                    <div class="flex items-center gap-2">
                                        <select v-model="node.data.entryId" @mousedown.stop @change="onLinkStateTargetChange(node)"
                                                class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-red-200">
                                            <option :value="null">Link Entry...</option>
                                            <option v-for="entry in linkEntryOptions" :key="entry.id" :value="entry.id">{{ entry.name }}</option>
                                        </select>
                                        <button @click.stop="startLinkPicker(node.id)"
                                                class="w-7 h-7 rounded border transition"
                                                :class="linkPicker.active && linkPicker.sourceStateId === node.id ? 'text-red-100 border-red-300/70 bg-red-500/20' : 'text-red-300/80 border-red-500/30 hover:text-red-100 hover:border-red-300/70'"
                                                title="Pick Link Entry">
                                            <i class="fa-solid fa-eye-dropper text-[11px]"></i>
                                        </button>
                                        <button @click.stop="jumpToLinkEntry(node)"
                                                :disabled="!getLinkEntryForState(node)"
                                                class="w-7 h-7 rounded border transition disabled:opacity-35 disabled:cursor-not-allowed"
                                                :class="getLinkEntryForState(node) ? 'text-red-300/80 border-red-500/30 hover:text-red-100 hover:border-red-300/70' : 'text-slate-500 border-slate-700'"
                                                title="Jump to Link Entry">
                                            <i class="fa-solid fa-up-right-from-square text-[11px]"></i>
                                        </button>
                                    </div>
                                    <div v-if="!linkEntryOptions.length" class="text-[10px] text-red-300/70">
                                        No Link Entry nodes yet
                                    </div>
                                    <div v-if="linkPicker.active && linkPicker.sourceStateId === node.id" class="text-[10px] text-red-200/80">
                                        Pick mode: click a Link Entry node
                                    </div>
                                </div>
                                <div class="text-[10px] text-red-300/80 uppercase tracking-wide px-1">
                                    Jump node (input only)
                                </div>
                            </div>

                            <div v-if="node.type === 'link_entry'">
                                <div class="bg-red-950/35 p-2 rounded border border-red-500/25 mb-2 text-[10px] text-red-200/80 uppercase tracking-wide">
                                    Output only. Rename in node header.
                                </div>
                                <div class="socket socket-out hover:border-red-400"
                                     :class="{ 'socket-occupied': isSocketOccupied(node.id, 'default') }"
                                     :data-node-id="node.id"
                                     data-socket-id="default"
                                     @mousedown.stop.prevent="startDragLine(node.id, 'default', $event)"></div>
                            </div>

                            <div v-if="node.type === 'comment'" class="space-y-2">
                                <div class="doc-node-caption">Comment</div>
                                <textarea v-model="node.data.text" @mousedown.stop class="doc-node-note" placeholder="Document decisions, TODOs, assumptions..."></textarea>
                            </div>

                        </div>

                        <div v-if="node.type === 'group'" class="group-resize-handle group-resize-t" @mousedown.stop.prevent="startGroupResize(node, 't', $event)"></div>
                        <div v-if="node.type === 'group'" class="group-resize-handle group-resize-b" @mousedown.stop.prevent="startGroupResize(node, 'b', $event)"></div>
                        <div v-if="node.type === 'group'" class="group-resize-handle group-resize-l" @mousedown.stop.prevent="startGroupResize(node, 'l', $event)"></div>
                        <div v-if="node.type === 'group'" class="group-resize-handle group-resize-r" @mousedown.stop.prevent="startGroupResize(node, 'r', $event)"></div>
                        <div v-if="node.type === 'group'" class="group-resize-handle group-resize-tl" @mousedown.stop.prevent="startGroupResize(node, 'tl', $event)"></div>
                        <div v-if="node.type === 'group'" class="group-resize-handle group-resize-tr" @mousedown.stop.prevent="startGroupResize(node, 'tr', $event)"></div>
                        <div v-if="node.type === 'group'" class="group-resize-handle group-resize-bl" @mousedown.stop.prevent="startGroupResize(node, 'bl', $event)"></div>
                        <div v-if="node.type === 'group'" class="group-resize-handle group-resize-br" @mousedown.stop.prevent="startGroupResize(node, 'br', $event)"></div>
                    </div>

                </div>

                <div v-if="nodeConnectMenu.visible"
                     class="node-context-menu"
                     :style="{ left: nodeConnectMenu.x + 'px', top: nodeConnectMenu.y + 'px' }"
                     @mousedown.stop
                     @click.stop>
                    <div class="node-context-menu-title">Create and connect</div>
                    <div class="node-context-menu-list">
                        <button v-for="item in connectableNodeOptions"
                                :key="item.type"
                                type="button"
                                class="node-context-item"
                                :data-tone="item.tone"
                                @click="createNodeFromContext(item.type)">
                            <i :class="['node-context-item-icon', item.icon]"></i>
                            <span class="node-context-item-text">
                                <span class="node-context-item-label">{{ item.label }}</span>
                                <span class="node-context-item-desc">{{ item.desc }}</span>
                            </span>
                        </button>
                    </div>
                    <div class="node-context-menu-hint">Esc to cancel</div>
                </div>

                <div class="hierarchy-shell" @mousedown.stop>
                    <button class="hierarchy-toggle" @click.stop="toggleHierarchyPanel" :title="hierarchyPanelOpen ? 'Hide hierarchy' : 'Show hierarchy'">
                        <i class="fa-solid fa-sitemap"></i>
                    </button>
                    <div v-if="hierarchyPanelOpen" class="hierarchy-panel">
                        <div class="hierarchy-title">Graph Hierarchy</div>
                        <div class="hierarchy-controls">
                            <input v-model="hierarchySearch.query" class="hierarchy-search" placeholder="Search node names, text, values..." />
                            <div class="hierarchy-filter-row">
                                <button type="button" class="hierarchy-filter-btn" :class="{ active: !hierarchySearch.warningsOnly }" @click="hierarchySearch.warningsOnly = false">All</button>
                                <button type="button" class="hierarchy-filter-btn" :class="{ active: hierarchySearch.warningsOnly }" @click="hierarchySearch.warningsOnly = !hierarchySearch.warningsOnly">Warnings</button>
                                <button type="button" class="hierarchy-filter-btn" @click="clearHierarchyFilters">Reset</button>
                            </div>
                            <div class="hierarchy-filter-row">
                                <button v-for="f in hierarchyTypeFilters"
                                        :key="f.type"
                                        type="button"
                                        class="hierarchy-filter-btn"
                                        :class="{ active: hierarchySearch.include[f.type] !== false }"
                                        @click="toggleHierarchyTypeFilter(f.type)">
                                    {{ f.label }} ({{ f.count }})
                                </button>
                            </div>
                        </div>
                        <div class="hierarchy-body">
                            <div v-if="!filteredHierarchyRows.length" class="hierarchy-empty">No matching nodes</div>
                            <button v-for="row in filteredHierarchyRows"
                                    :key="row.key"
                                    class="hierarchy-row"
                                    :class="{ 'is-ref': row.kind === 'ref', 'is-cycle': row.kind === 'cycle' }"
                                    @click="jumpToNode(row.nodeId)">
                                <span class="hierarchy-tree" v-if="row.depth > 0">
                                    <span v-for="(guide, guideIdx) in row.guides"
                                          :key="row.key + '_g_' + guideIdx"
                                          class="hierarchy-guide"
                                          :class="guideIdx === row.guides.length - 1
                                                ? ['branch', guide ? 'branch-continue' : '']
                                                : (guide ? 'line' : '')"></span>
                                </span>
                                <span v-if="row.socket" class="hierarchy-socket">{{ row.socket }}</span>
                                <span class="hierarchy-pill" :class="'tone-' + row.tone">{{ row.name }}</span>
                                <span v-if="row.meta" class="hierarchy-meta">{{ row.meta }}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div v-if="graphWarnings.length" class="warnings-shell" @mousedown.stop>
                    <div class="warnings-panel">
                        <div class="warnings-title">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                            Graph Warnings ({{ graphWarnings.length }})
                        </div>
                        <div class="warnings-body">
                            <button v-for="warn in graphWarnings"
                                    :key="warn.id"
                                    class="warning-item"
                                    :class="'level-' + warn.level"
                                    @click="warn.nodeId ? jumpToNode(warn.nodeId) : null">
                                <i class="warning-icon" :class="warn.level === 'critical' ? 'fa-solid fa-triangle-exclamation' : 'fa-solid fa-circle-exclamation'"></i>
                                <span>{{ warn.text }}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="absolute bottom-6 left-1/2 -translate-x-1/2 z-50">
                    <div class="glass-panel rounded-2xl p-2 flex items-center gap-2 shadow-2xl">
                        <button @click="addNode('dialog')" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-blue-600/20 hover:text-blue-400 text-slate-400 transition group">
                            <i class="fa-solid fa-comment-dots text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">DIALOG</span>
                        </button>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <button @click="addNode('action')" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-purple-600/20 hover:text-purple-400 text-slate-400 transition group">
                            <i class="fa-solid fa-bolt text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">ACTION</span>
                        </button>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <button @click="addNode('condition')" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-yellow-600/20 hover:text-yellow-400 text-slate-400 transition group">
                            <i class="fa-solid fa-code-branch text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">IF / ELSE</span>
                        </button>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <button @click="addNode('switcher')" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-sky-600/20 hover:text-sky-400 text-slate-400 transition group">
                            <i class="fa-solid fa-shuffle text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">SWITCH</span>
                        </button>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <button @click="addNode('wait_event')" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-cyan-600/20 hover:text-cyan-300 text-slate-400 transition group">
                            <i class="fa-solid fa-hourglass-half text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">WAIT EV</span>
                        </button>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <button @click="addNode('wait_condition')" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-amber-600/20 hover:text-amber-300 text-slate-400 transition group">
                            <i class="fa-solid fa-stopwatch text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">WAIT IF</span>
                        </button>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <button @click="addNode('objective_set')" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-emerald-600/20 hover:text-emerald-300 text-slate-400 transition group">
                            <i class="fa-solid fa-list-check text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">OBJ SET</span>
                        </button>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <button @click="addNode('objective_complete')" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-emerald-700/20 hover:text-emerald-200 text-slate-400 transition group">
                            <i class="fa-solid fa-circle-check text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">OBJ OK</span>
                        </button>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <button @click="addNode('objective_fail')" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-rose-700/20 hover:text-rose-200 text-slate-400 transition group">
                            <i class="fa-solid fa-circle-xmark text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">OBJ FAIL</span>
                        </button>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <button @click="addNode('quest_end')" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-indigo-700/20 hover:text-indigo-200 text-slate-400 transition group">
                            <i class="fa-solid fa-flag-checkered text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">Q END</span>
                        </button>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <button @click="addNode('link_state')" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-red-600/20 hover:text-red-300 text-slate-400 transition group">
                            <i class="fa-solid fa-link text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">LINK ST</span>
                        </button>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <button @click="addNode('link_entry')" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-red-700/20 hover:text-red-200 text-slate-400 transition group">
                            <i class="fa-solid fa-right-to-bracket text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">LINK IN</span>
                        </button>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <button @click="addNode('comment')" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-amber-600/20 hover:text-amber-300 text-slate-400 transition group">
                            <i class="fa-solid fa-note-sticky text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">NOTE</span>
                        </button>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <button @click="addNode('group')" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-indigo-600/20 hover:text-indigo-300 text-slate-400 transition group">
                            <i class="fa-solid fa-vector-square text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">GROUP</span>
                        </button>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <button @click="resetView" title="Reset Camera" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl hover:bg-slate-700 text-slate-500 hover:text-white transition">
                            <i class="fa-solid fa-crosshairs text-xl mb-1"></i>
                            <span class="text-[10px] font-bold">CENTER</span>
                        </button>
                        <div class="w-10"></div>
                        <button @click="runScenario" class="flex flex-col items-center justify-center w-32 h-16 rounded-xl bg-emerald-600/20 text-emerald-300 hover:bg-emerald-500/30 hover:text-emerald-200 transition group">
                            <i class="fa-solid fa-play text-2xl mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[10px] font-bold">PLAY</span>
                        </button>
                    </div>
                </div>

            </div>

            <aside class="w-80 bg-slate-900 border-l border-slate-700 flex flex-col z-40 shadow-xl">
                <div class="flex border-b border-slate-700">
                    <button @click="tab = 'props'" class="flex-1 py-3 text-xs font-bold uppercase transition hover:text-white" :class="tab==='props' ? 'text-blue-400 border-b-2 border-blue-500 bg-slate-800' : 'text-slate-500'">Properties</button>
                    <button @click="tab = 'vars'" class="flex-1 py-3 text-xs font-bold uppercase transition hover:text-white" :class="tab==='vars' ? 'text-yellow-400 border-b-2 border-yellow-500 bg-slate-800' : 'text-slate-500'">Variables</button>
                    <button @click="tab = 'chars'" class="flex-1 py-3 text-xs font-bold uppercase transition hover:text-white" :class="tab==='chars' ? 'text-emerald-400 border-b-2 border-emerald-500 bg-slate-800' : 'text-slate-500'">Characters</button>
                </div>

                <div class="flex-1 overflow-y-auto p-4">
                    <div v-if="tab === 'props'">
                        <div v-if="selectedNodeIds.length > 1" class="h-full flex flex-col items-center justify-center text-slate-400">
                            <i class="fa-solid fa-layer-group text-3xl mb-2"></i>
                            <div class="text-sm">Selected {{ selectedNodeIds.length }} items</div>
                        </div>
                        <div v-else-if="selectedNode">
                            <div class="mb-4 pb-2 border-b border-slate-700 flex justify-between items-center text-slate-400 text-[10px] font-mono">
                                <span>ID: {{ selectedNode.id.substr(-6) }}</span>
                                <span class="uppercase font-bold text-white">{{ selectedNode.type }}</span>
                            </div>

                            <div v-if="selectedNode.type === 'dialog'" class="space-y-4">
                                <div>
                                    <label class="text-xs text-slate-500 block mb-1">Speaker</label>
                                    <select v-model="selectedNode.data.speakerId" class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm">
                                        <option :value="null">Select character...</option>
                                        <option v-for="c in characters" :value="c.id">{{ c.name }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500 block mb-1">Text</label>
                                    <textarea v-model="selectedNode.data.text" rows="4" class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none resize-none transition"></textarea>
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500 block mb-1">Replies</label>
                                    <div class="space-y-2">
                                        <div v-for="(c, i) in selectedNode.data.choices" :key="i" class="flex gap-2">
                                            <input v-model="c.text" class="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs">
                                            <button @click="selectedNode.data.choices.splice(i,1)" class="text-slate-600 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                                        </div>
                                    </div>
                                    <button @click="selectedNode.data.choices.push({text:'New Option'})" class="mt-2 w-full py-1 text-xs border border-dashed border-slate-600 text-slate-400 hover:text-white hover:border-slate-400 rounded transition">
                                        + Add reply
                                    </button>
                                </div>
                            </div>

                            <div v-if="selectedNode.type === 'action'" class="space-y-4">
                                <label class="text-xs text-slate-500 block">Actions</label>
                                <div v-if="!selectedNode.data.ops.length" class="text-xs text-slate-500 border border-dashed border-slate-700 rounded p-3 text-center">
                                    No actions. Add the first block.
                                </div>

                                <div class="space-y-3">
                                    <div v-for="(op, i) in selectedNode.data.ops" :key="op.id" class="bg-slate-800/60 p-3 rounded border border-slate-700 space-y-2">
                                        <div class="flex items-center gap-2">
                                            <select v-model="op.varId" @change="onActionVarChange(op)" class="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs">
                                                <option :value="null">Variable...</option>
                                                <option v-for="v in variables" :value="v.id">{{ v.name }}</option>
                                            </select>
                                            <button @click="removeActionOp(selectedNode, i)" class="text-slate-500 hover:text-red-400">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </div>

                                        <div v-if="!op.varId" class="text-xs text-slate-500">
                                            Select a variable for the action.
                                        </div>

                                        <div v-else-if="getVarType(op.varId) === 'bool'">
                                            <label class="flex items-center gap-2 bg-slate-950 border border-slate-700 rounded px-2 py-2 text-xs">
                                                <input type="checkbox" v-model="op.val" class="accent-emerald-500">
                                                <span>Set {{ op.val ? 'True' : 'False' }}</span>
                                            </label>
                                        </div>

                                        <div v-else-if="getVarType(op.varId) === 'enum'">
                                            <select v-model="op.val" class="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs">
                                                <option v-for="opt in getVarOptions(op.varId)" :value="opt">{{ opt }}</option>
                                            </select>
                                        </div>

                                        <div v-else-if="getVarType(op.varId) === 'string'">
                                            <input type="text" v-model="op.val" class="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs" placeholder="Text...">
                                        </div>

                                        <div v-else class="flex gap-2">
                                            <select v-model="op.op" class="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs">
                                                <option value="add">+</option>
                                                <option value="sub">-</option>
                                                <option value="mul">*</option>
                                                <option value="div">/</option>
                                                <option value="set">=</option>
                                            </select>
                                            <input type="number" v-model.number="op.val" class="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs">
                                        </div>
                                    </div>
                                </div>

                                <button @click="addActionOp(selectedNode)" class="w-full py-1 text-xs border border-dashed border-slate-600 text-slate-400 hover:text-white hover:border-slate-400 rounded transition">
                                    + Extra action
                                </button>
                            </div>

                            <div v-if="selectedNode.type === 'condition'" class="space-y-4">
                                <label class="text-xs text-slate-500 block">Condition</label>
                                <select v-model="selectedNode.data.varId" class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm">
                                    <option :value="null">Select variable...</option>
                                    <option v-for="v in variables" :value="v.id">{{ v.name }}</option>
                                </select>
                                <div class="flex gap-2" v-if="selectedNode.data.varId">
                                    <div v-if="getVarType(selectedNode.data.varId) === 'bool'" class="flex gap-2 w-full">
                                        <select v-model="selectedNode.data.op" class="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                            <option value="eq">==</option>
                                            <option value="neq">!=</option>
                                        </select>
                                        <label class="flex items-center gap-2 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                            <input type="checkbox" v-model="selectedNode.data.val" class="accent-emerald-500">
                                            <span>{{ selectedNode.data.val ? 'True' : 'False' }}</span>
                                        </label>
                                    </div>
                                    <div v-else-if="getVarType(selectedNode.data.varId) === 'enum'" class="flex gap-2 w-full">
                                        <select v-model="selectedNode.data.op" class="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                            <option value="eq">==</option>
                                            <option value="neq">!=</option>
                                        </select>
                                        <select v-model="selectedNode.data.val" class="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                            <option v-for="opt in getVarOptions(selectedNode.data.varId)" :value="opt">{{ opt }}</option>
                                        </select>
                                    </div>
                                    <div v-else-if="getVarType(selectedNode.data.varId) === 'string'" class="flex gap-2 w-full">
                                        <select v-model="selectedNode.data.op" class="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                            <option value="eq">==</option>
                                            <option value="neq">!=</option>
                                        </select>
                                        <input type="text" v-model="selectedNode.data.val" class="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                    </div>
                                    <div v-else class="flex gap-2 w-full">
                                        <select v-model="selectedNode.data.op" class="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                            <option value="eq">==</option>
                                            <option value="neq">!=</option>
                                            <option value="gt">&gt;</option>
                                            <option value="lt">&lt;</option>
                                        </select>
                                        <input type="number" v-model.number="selectedNode.data.val" class="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                    </div>
                                </div>
                            </div>

                            <div v-if="selectedNode.type === 'wait_event'" class="space-y-4">
                                <label class="text-xs text-slate-500 block">Wait Event</label>
                                <input v-model="selectedNode.data.eventKey" class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm text-cyan-100" placeholder="quest.bandits_cleared">
                                <input v-model="selectedNode.data.note" class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm text-cyan-100" placeholder="Optional note">
                                <div class="text-xs text-slate-500">Runtime should pause until this event key is emitted.</div>
                            </div>

                            <div v-if="selectedNode.type === 'wait_condition'" class="space-y-4">
                                <label class="text-xs text-slate-500 block">Wait Condition</label>
                                <select v-model="selectedNode.data.varId" class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm">
                                    <option :value="null">Select variable...</option>
                                    <option v-for="v in variables" :value="v.id">{{ v.name }}</option>
                                </select>
                                <div class="flex gap-2" v-if="selectedNode.data.varId">
                                    <div v-if="getVarType(selectedNode.data.varId) === 'bool'" class="flex gap-2 w-full">
                                        <select v-model="selectedNode.data.op" class="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                            <option value="eq">==</option>
                                            <option value="neq">!=</option>
                                        </select>
                                        <label class="flex items-center gap-2 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                            <input type="checkbox" v-model="selectedNode.data.val" class="accent-emerald-500">
                                            <span>{{ selectedNode.data.val ? 'True' : 'False' }}</span>
                                        </label>
                                    </div>
                                    <div v-else-if="getVarType(selectedNode.data.varId) === 'enum'" class="flex gap-2 w-full">
                                        <select v-model="selectedNode.data.op" class="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                            <option value="eq">==</option>
                                            <option value="neq">!=</option>
                                        </select>
                                        <select v-model="selectedNode.data.val" class="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                            <option v-for="opt in getVarOptions(selectedNode.data.varId)" :value="opt">{{ opt }}</option>
                                        </select>
                                    </div>
                                    <div v-else-if="getVarType(selectedNode.data.varId) === 'string'" class="flex gap-2 w-full">
                                        <select v-model="selectedNode.data.op" class="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                            <option value="eq">==</option>
                                            <option value="neq">!=</option>
                                        </select>
                                        <input type="text" v-model="selectedNode.data.val" class="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                    </div>
                                    <div v-else class="flex gap-2 w-full">
                                        <select v-model="selectedNode.data.op" class="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                            <option value="eq">==</option>
                                            <option value="neq">!=</option>
                                            <option value="gt">&gt;</option>
                                            <option value="lt">&lt;</option>
                                        </select>
                                        <input type="number" v-model.number="selectedNode.data.val" class="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-sm">
                                    </div>
                                </div>
                                <div class="text-xs text-slate-500">Quest waits until this condition is true, then continues.</div>
                            </div>

                            <div v-if="selectedNode.type === 'objective_set' || selectedNode.type === 'objective_complete' || selectedNode.type === 'objective_fail'" class="space-y-4">
                                <label class="text-xs text-slate-500 block">Objective Hook</label>
                                <input v-model="selectedNode.data.objectiveId" class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm text-emerald-100" placeholder="quest_find_relic">
                                <textarea v-if="selectedNode.type === 'objective_set'" v-model="selectedNode.data.objectiveText" rows="3" class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm text-emerald-100 resize-y" placeholder="Objective text in journal..."></textarea>
                                <input v-else v-model="selectedNode.data.reason" class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm text-emerald-100" placeholder="Optional reason">
                                <div class="text-xs text-slate-500">Engine bridge maps objective id to journal/task system.</div>
                            </div>

                            <div v-if="selectedNode.type === 'quest_end'" class="space-y-4">
                                <label class="text-xs text-slate-500 block">Quest End State</label>
                                <select v-model="selectedNode.data.result" class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm text-indigo-100">
                                    <option value="complete">Complete</option>
                                    <option value="fail">Fail</option>
                                    <option value="abort">Abort</option>
                                </select>
                                <textarea v-model="selectedNode.data.endingNote" rows="3" class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm text-indigo-100 resize-y" placeholder="Short ending note for narrative context..."></textarea>
                                <div class="text-xs text-slate-500">Use Quest End as an explicit final state instead of implicit dead-end.</div>
                            </div>

                            <div v-if="selectedNode.type === 'link_state'" class="space-y-4">
                                <label class="text-xs text-slate-500 block">Link Target</label>
                                <div class="flex items-center gap-2">
                                    <select v-model="selectedNode.data.entryId" @change="onLinkStateTargetChange(selectedNode)" class="flex-1 bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm text-red-100">
                                        <option :value="null">Select Link Entry...</option>
                                        <option v-for="entry in linkEntryOptions" :key="entry.id" :value="entry.id">{{ entry.name }}</option>
                                    </select>
                                    <button @click="startLinkPicker(selectedNode.id)"
                                            class="w-9 h-9 rounded border transition"
                                            :class="linkPicker.active && linkPicker.sourceStateId === selectedNode.id ? 'text-red-100 border-red-300/70 bg-red-500/20' : 'text-red-300/80 border-red-500/30 hover:text-red-100 hover:border-red-300/70'"
                                            title="Pick Link Entry">
                                        <i class="fa-solid fa-eye-dropper text-sm"></i>
                                    </button>
                                    <button @click="jumpToLinkEntry(selectedNode)"
                                            :disabled="!getLinkEntryForState(selectedNode)"
                                            class="w-9 h-9 rounded border transition disabled:opacity-35 disabled:cursor-not-allowed"
                                            :class="getLinkEntryForState(selectedNode) ? 'text-red-300/80 border-red-500/30 hover:text-red-100 hover:border-red-300/70' : 'text-slate-500 border-slate-700'"
                                            title="Jump to Link Entry">
                                        <i class="fa-solid fa-up-right-from-square text-sm"></i>
                                    </button>
                                </div>
                                <div v-if="!linkEntryOptions.length" class="text-xs text-slate-500 border border-dashed border-slate-700 rounded p-3 text-center">
                                    Add at least one Link Entry node.
                                </div>
                                <div v-if="linkPicker.active && linkPicker.sourceStateId === selectedNode.id" class="text-xs text-red-300/80">
                                    Pick mode is active. Click a Link Entry node on canvas.
                                </div>
                            </div>

                            <div v-if="selectedNode.type === 'link_entry'" class="space-y-4">
                                <label class="text-xs text-slate-500 block">Entry Name</label>
                                <input v-model="selectedNode.data.title" @input="onLinkEntryTitleInput(selectedNode)" class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm text-red-100" placeholder="Link name...">
                                <div class="text-xs text-slate-500">Used by Link State select and shown in node header.</div>
                            </div>

                            <div v-if="selectedNode.type === 'comment'" class="space-y-4">
                                <label class="text-xs text-slate-500 block">Comment Text</label>
                                <textarea v-model="selectedNode.data.text" rows="8" class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm text-amber-100 focus:border-amber-500 outline-none resize-y"></textarea>
                            </div>

                            <div v-if="selectedNode.type === 'group'" class="space-y-4">
                                <label class="text-xs text-slate-500 block">Group Tint</label>
                                <div class="flex flex-wrap gap-2">
                                    <button v-for="color in groupColorPalette"
                                            :key="'group-color-' + color"
                                            type="button"
                                            class="w-7 h-7 rounded border-2 transition"
                                            :class="normalizeGroupColor(selectedNode.data.color) === color ? 'border-slate-200 scale-105' : 'border-slate-700 hover:border-slate-500'"
                                            :style="{ background: color }"
                                            @click="setGroupColor(selectedNode, color)"></button>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="color" :value="normalizeGroupColor(selectedNode.data.color)" @input="setGroupColor(selectedNode, $event.target.value)" class="w-10 h-10 p-0 border border-slate-700 rounded bg-slate-950 cursor-pointer">
                                    <span class="text-xs text-slate-500">Drag any edge or corner to resize.</span>
                                </div>
                                <label class="flex items-center gap-2 text-xs text-slate-300">
                                    <input type="checkbox" v-model="selectedNode.data.zoomTitleLock" class="accent-sky-500">
                                    <span>Keep group title readable on zoom out</span>
                                </label>
                                <div class="text-xs text-slate-500">Inside group: {{ getGroupMemberCount(selectedNode) }} node(s)</div>
                            </div>

                        </div>
                        <div v-else class="h-full flex flex-col items-center justify-center text-slate-600 opacity-50">
                            <i class="fa-solid fa-computer-mouse text-4xl mb-2"></i>
                            <span class="text-xs">Select a node</span>
                        </div>
                    </div>

                    <div v-if="tab === 'vars'" class="space-y-3">
                        <div class="flex items-center justify-between">
                            <h3 class="text-[11px] font-bold uppercase text-slate-400 tracking-wide">Scenario Variables</h3>
                            <button @click="addVariable" class="px-2 py-1 rounded bg-blue-600 hover:bg-blue-500 text-white text-[11px] font-bold transition">
                                <i class="fa-solid fa-plus mr-1"></i> Add
                            </button>
                        </div>

                        <div v-if="!variables.length" class="text-xs text-slate-500 border border-dashed border-slate-700 rounded p-3 text-center">
                            No variables yet. Click "Add".
                        </div>

                        <div class="space-y-2">
                            <div v-for="v in variables" :key="v.id" class="bg-slate-800/60 p-3 rounded border border-slate-700 space-y-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] px-2 py-0.5 rounded font-bold uppercase"
                                          :class="getVariableTypeClass(v.type)">
                                        {{ getVariableTypeLabel(v.type) }}
                                    </span>
                                    <input v-model="v.name" class="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs" placeholder="Variable name">
                                    <button @click="removeVariable(v.id)" class="text-slate-500 hover:text-red-400">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>

                                <div class="grid grid-cols-2 gap-2">
                                    <select v-model="v.type" @change="updateVariableType(v)" class="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs">
                                        <option value="num">Number</option>
                                        <option value="bool">Bool</option>
                                        <option value="string">String</option>
                                        <option value="enum">Enum</option>
                                    </select>

                                    <div v-if="v.type === 'num'">
                                        <input type="number" v-model.number="v.init" class="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs">
                                    </div>
                                    <label v-else-if="v.type === 'bool'" class="flex items-center gap-2 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs">
                                        <input type="checkbox" v-model="v.init" class="accent-emerald-500">
                                        <span>{{ v.init ? 'True' : 'False' }}</span>
                                    </label>
                                    <div v-else-if="v.type === 'string'">
                                        <input type="text" v-model="v.init" class="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs" placeholder="Text">
                                    </div>
                                    <div v-else class="space-y-2">
                                        <select v-model="v.init" class="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs">
                                            <option v-for="opt in v.options" :value="opt">{{ opt }}</option>
                                        </select>
                                    </div>
                                </div>

                                <div v-if="v.type === 'enum'" class="space-y-2">
                                    <div class="text-[10px] text-slate-500 uppercase">Options</div>
                                    <div class="space-y-1">
                                        <div v-for="(opt, idx) in v.options" :key="idx" class="flex items-center gap-2">
                                            <input v-model="v.options[idx]" class="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs" placeholder="Option">
                                            <button @click="removeEnumOption(v, idx)" class="text-slate-500 hover:text-red-400">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button @click="addEnumOption(v)" class="w-full py-1 text-[10px] border border-dashed border-slate-600 text-slate-400 hover:text-white hover:border-slate-400 rounded transition">
                                        + Add option
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="tab === 'chars'" class="space-y-3">
                        <div class="flex items-center justify-between">
                            <h3 class="text-[11px] font-bold uppercase text-slate-400 tracking-wide">Characters</h3>
                            <button @click="addCharacter" class="px-2 py-1 rounded bg-emerald-600 hover:bg-emerald-500 text-white text-[11px] font-bold transition">
                                <i class="fa-solid fa-plus mr-1"></i> Add
                            </button>
                        </div>

                        <div v-if="!characters.length" class="text-xs text-slate-500 border border-dashed border-slate-700 rounded p-3 text-center">
                            No characters yet. Click "Add".
                        </div>

                        <div class="space-y-2">
                            <div v-for="c in characters" :key="c.id" class="bg-slate-800/60 p-3 rounded border border-slate-700 space-y-2">
                                <div class="flex items-center gap-2">
                                    <input v-model="c.name" class="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs" placeholder="Character name">
                                    <button @click="removeCharacter(c.id)" class="text-slate-500 hover:text-red-400">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <div class="bottom-tools-shell" @mousedown.stop>
            <div class="hotkeys-panel">
                <div class="hotkeys-head">
                    <div class="font-bold uppercase text-[9px] text-slate-400">Hotkeys</div>
                    <button type="button" class="hotkeys-doc-toggle" :class="{ active: helpPanelOpen }" @click="helpPanelOpen = !helpPanelOpen">Docs</button>
                </div>
                <div v-for="(h, i) in hotkeyHints" :key="i" class="flex items-center gap-2">
                    <span class="px-1.5 py-0.5 rounded bg-slate-800 border border-slate-700 text-slate-200 font-mono">{{ h.keys }}</span>
                    <span class="text-slate-300">{{ h.label }}</span>
                </div>
                <div class="autosave-state">Autosave: {{ autosaveStatusText }}</div>
            </div>
        </div>

        <div v-if="helpPanelOpen" class="export-validator-overlay" @mousedown.self="helpPanelOpen = false">
            <div class="export-validator-modal" @mousedown.stop>
                <div class="export-validator-head">
                    <div>
                        <div class="export-validator-title">Quest Architect Documentation</div>
                        <div class="export-validator-subtitle">Wiki guide focused on UX, design rules, and practical workflow</div>
                    </div>
                    <button @click="helpPanelOpen = false" class="export-validator-close" title="Close">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <iframe
                    class="export-validator-frame"
                    src="quest_architect/quest_architect_docs.html"
                    title="Quest Architect Docs">
                </iframe>
            </div>
        </div>

        <div v-if="exportPanelOpen" class="export-validator-overlay" @mousedown.self="exportPanelOpen = false; exportValidatorDocsOpen = false">
            <div class="export-validator-modal" @mousedown.stop>
                <div class="export-validator-head">
                    <div>
                        <div class="export-validator-title">Quest Exporter + Validator</div>
                        <div class="export-validator-subtitle">Production export, runtime diagnostics, and graph validation</div>
                    </div>
                    <div class="export-validator-head-actions">
                        <button @click="exportValidatorDocsOpen = true" class="export-validator-close" title="Validator Docs">
                            <i class="fa-solid fa-question"></i>
                        </button>
                        <button @click="exportPanelOpen = false; exportValidatorDocsOpen = false" class="export-validator-close" title="Close">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>
                <iframe
                    class="export-validator-frame"
                    src="quest_architect/quest_export_validator.html"
                    title="Quest Exporter and Validator">
                </iframe>
                <div v-if="exportValidatorDocsOpen" class="export-validator-docs-layer" @mousedown.self="exportValidatorDocsOpen = false">
                    <div class="export-validator-docs-modal" @mousedown.stop>
                        <div class="export-validator-head">
                            <div>
                                <div class="export-validator-title">Validator Documentation</div>
                                <div class="export-validator-subtitle">Wiki guide for modes, controls, diagnostics, and export formats</div>
                            </div>
                            <button @click="exportValidatorDocsOpen = false" class="export-validator-close" title="Close Docs">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                        <iframe
                            class="export-validator-frame"
                            src="quest_architect/quest_export_validator_docs.html"
                            title="Quest Export Validator Docs">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="isPlayMode" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center">
            <div class="w-[1250px] h-[780px] max-w-[95vw] max-h-[92vh] bg-slate-900 border border-slate-700 rounded-lg shadow-2xl flex flex-col overflow-hidden">
                <div class="h-10 bg-slate-950 flex justify-between items-center px-4 border-b border-slate-800">
                    <span class="text-xs font-bold text-emerald-500 uppercase tracking-widest">Running Scenario</span>
                    <button @click="isPlayMode = false" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="flex-1 flex min-h-0">
                    <div class="flex-1 flex flex-col p-6 gap-4 min-h-0">
                        <div class="flex-1 min-h-0 overflow-hidden font-mono text-sm flex flex-col justify-end" ref="gameLogRef">
                            <div class="flex flex-col gap-3">
                                <div v-for="(msg, i) in gameLog" :key="i">
                                    <span class="text-blue-400 font-bold block text-xs mb-1">{{ getCharacterName(msg.speakerId) }}</span>
                                    <p class="text-slate-200">{{ msg.text }}</p>
                        <div v-if="msg.choice" class="mt-1 pl-2 border-l-2 border-slate-600 text-slate-500 text-xs italic">
                            Chosen: {{ msg.choice }}
                        </div>
                                </div>
                            </div>
                        </div>

                        <div v-if="activeNode && activeNode.type === 'dialog' && !gameFinished" class="shrink-0 p-4 bg-slate-800 rounded border border-slate-700">
                            <div class="text-blue-400 font-bold mb-2">{{ getCharacterName(activeNode.data.speakerId) }}</div>
                            <div class="text-lg text-white mb-4">{{ activeNode.data.text }}</div>
                            <div class="space-y-2">
                                <button v-for="(c, i) in activeNode.data.choices" :key="i"
                                        @click="makeChoice(i)"
                                        class="w-full text-left p-3 rounded bg-slate-700 hover:bg-blue-600 transition text-slate-200 hover:text-white border border-slate-600">
                                    {{ i + 1 }}. {{ c.text }}
                                </button>
                            </div>
                        </div>

                        <div v-if="gameFinished" class="shrink-0 text-center text-slate-500">
                            --- End of scenario ---
                            <br>
                            <button @click="runScenario" class="mt-2 text-emerald-500 underline">Run again</button>
                        </div>
                    </div>

                    <div class="w-56 border-l border-slate-800 bg-slate-950/40 p-4 space-y-3">
                        <div class="text-xs font-bold uppercase text-slate-400 tracking-wide">Variables</div>
                        <div v-if="!variables.length" class="text-xs text-slate-500">No variables</div>
                        <div class="space-y-2">
                            <div v-for="v in variables" :key="v.id" class="flex items-center justify-between gap-2 text-xs">
                                <span class="text-slate-400 truncate">{{ v.name }}</span>
                                <span class="font-mono text-slate-200">{{ getRuntimeDisplay(v) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="cloud.show" class="fixed inset-0 z-[90] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6">
            <div class="w-[800px] max-w-[95vw] bg-slate-900 border border-slate-700 rounded-lg shadow-2xl overflow-hidden">
                <div class="h-12 bg-slate-950 flex items-center justify-between px-4 border-b border-slate-800">
                    <span class="text-xs font-bold uppercase tracking-widest text-slate-300">
                        {{ cloud.mode === 'load' ? 'Load From Cloud' : 'Save To Cloud' }}
                    </span>
                    <button @click="cloud.show = false" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <div class="p-4">
                    <div v-if="cloud.mode === 'save'" class="space-y-3">
                        <label class="text-xs text-slate-500 block">Title</label>
                        <input v-model="cloud.saveTitle" class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm">
                        <div class="flex items-center justify-between text-xs text-slate-500">
                            <span v-if="cloud.currentId">Current project will be overwritten</span>
                            <span v-else>Create new project</span>
                        </div>
                        <button @click="saveToCloud" class="w-full py-2 text-xs font-bold bg-emerald-600 hover:bg-emerald-500 text-white rounded">
                            Save To Cloud
                        </button>
                    </div>

                    <div v-else class="space-y-3">
                        <div v-if="cloud.loading" class="text-center text-slate-500 py-10">
                            <i class="fa-solid fa-spinner fa-spin text-2xl"></i>
                            <div class="mt-2 text-xs">Loading...</div>
                        </div>
                        <div v-else-if="!cloud.list.length" class="text-center text-slate-500 py-10 text-xs">
                            No projects
                        </div>
                        <div v-else class="space-y-2 max-h-[420px] overflow-y-auto pr-1">
                            <div v-for="q in cloud.list" :key="q.id" @click="loadFromCloud(q)"
                                 class="bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-slate-500 rounded p-3 text-sm cursor-pointer flex items-center justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="text-slate-200 font-bold truncate">{{ q.title }}</div>
                                    <div class="text-[10px] text-slate-500">
                                        {{ new Date((q.updated_at || q.created_at)).toLocaleString() }}
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 shrink-0">
                                    <button @click.stop="deleteFromCloud(q)" class="text-slate-500 hover:text-red-400">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                    <i class="fa-solid fa-download text-slate-500"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="quest_architect/quest_architect.js"></script>
</body>
</html>
