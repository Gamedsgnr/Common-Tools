<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Snippet Builder</title>
    <style>
        body { background: #222; color: #ddd; font-family: sans-serif; padding: 40px; max-width: 600px; margin: 0 auto; }
        input, textarea, select { width: 100%; background: #333; border: 1px solid #444; color: white; padding: 10px; margin-bottom: 15px; border-radius: 4px; display: block; box-sizing: border-box; }
        textarea { height: 150px; font-family: monospace; }
        label { font-size: 0.9em; color: #aaa; margin-bottom: 5px; display: block; }
        button { background: #007acc; color: white; border: none; padding: 15px; width: 100%; cursor: pointer; font-weight: bold; }
        button:hover { background: #005a9e; }
        .result-box { margin-top: 20px; background: #111; padding: 15px; border: 1px dashed #555; display: none; }
        /* Стиль для плашек найденных инпутов */
        .input-preview { margin-bottom: 15px; display: none; }
        .badge { display: inline-block; background: #444; color: #4ec9b0; padding: 2px 8px; border-radius: 3px; font-size: 0.8em; margin-right: 5px; border: 1px solid #555; }
    </style>
</head>
<body>
    <h2>➕ Добавить новый сниппет</h2>
    
    <label>Название (Title):</label>
    <input type="text" id="inTitle" placeholder="Например: Custom Rotator">

    <label>Язык (Language):</label>
    <select id="inLang" onchange="togglePreview()">
        <option value="cpp">C++</option>
        <option value="javascript">JavaScript</option>
        <option value="python">Python</option>
        <option value="html">HTML</option>
        <option value="css">CSS</option>
        <option value="hlsl">HLSL (Shader Code)</option> 
        <option value="text">Plain Text</option>
    </select>

    <label>Описание:</label>
    <input type="text" id="inDesc" placeholder="Что он делает...">

    <label>Код:</label>
    <textarea id="inCode" id="inCode" oninput="togglePreview()" placeholder="Вставьте код сюда..."></textarea>

    <div id="inputPreview" class="input-preview">
        <label style="color: #4ec9b0;">Авто-определенные входы (Inputs):</label>
        <div id="badgeContainer"></div>
    </div>

    <button onclick="generateJSON()">СГЕНЕРИРОВАТЬ ДЛЯ ВСТАВКИ</button>

    <div class="result-box" id="resultArea">
        <p id="pasteHint" style="color: #4ec9b0; margin-top: 0; font-size: 0.9em;">
            Скопируйте и вставьте в <b>snippets_db.js</b>:
        </p>
        <textarea id="outJson" style="height: 120px; color: #ce9178; font-family: monospace;"></textarea>
    </div>

    <script>
        const hlslKeywords = new Set([
            'float','float2','float3','float4','half','half2','half3','half4','int','int2','int3','int4','uint','bool','fixed','float4x4','float3x3','void','return','if','else','for','while','break','continue','discard','true','false','const','static','loop','unroll','abs','acos','any','asin','atan','atan2','ceil','clamp','cos','cross','ddx','ddy','distance','dot','exp','exp2','floor','fmod','frac','length','lerp','log','max','min','mul','normalize','pow','reflect','refract','round','rsqrt','saturate','sign','sin','smoothstep','sqrt','step','tan','tanh','tex2D','all','View','ResolvedView','Parameters','Sample','Texture2D'
        ]);

        function extractHlslInputs(code) {
            const cleanCode = code.replace(/\/\*[\s\S]*?\*\/|\/\/.*/g, '');
            const declared = new Set();
            const declRegex = /\b(?:float[1-4]?|half[1-4]?|int[1-4]?|uint[1-4]?|bool|fixed|float4x4|float3x3|struct)\s+([a-zA-Z_][a-zA-Z0-9_]*)\b/g;
            let m;
            while ((m = declRegex.exec(cleanCode)) !== null) declared.add(m[1]);

            const inputs = new Set();
            const wordRegex = /(\.)?(\b[a-zA-Z_][a-zA-Z0-9_]*\b)/g;
            while ((m = wordRegex.exec(cleanCode)) !== null) {
                const hasDot = m[1] === '.';
                const word = m[2];
                if (!hasDot && !hlslKeywords.has(word) && !declared.has(word) && !/^[xyzwrgba]{1,4}$/.test(word)) {
                    inputs.add(word);
                }
            }
            return Array.from(inputs);
        }

        function togglePreview() {
            const lang = document.getElementById('inLang').value;
            const preview = document.getElementById('inputPreview');
            const code = document.getElementById('inCode').value;
            
            if (lang === 'hlsl' && code.trim() !== "") {
                const detected = extractHlslInputs(code);
                if (detected.length > 0) {
                    preview.style.display = 'block';
                    document.getElementById('badgeContainer').innerHTML = detected.map(i => `<span class="badge">${i}</span>`).join('');
                    return;
                }
            }
            preview.style.display = 'none';
        }

        function generateJSON() {
            const title = document.getElementById('inTitle').value;
            const lang = document.getElementById('inLang').value;
            const desc = document.getElementById('inDesc').value;
            const code = document.getElementById('inCode').value;
            const hint = document.getElementById('pasteHint');

            const obj = {
                id: (lang === 'hlsl' ? "hlsl_" : "id_") + Date.now(),
                title: title,
                desc: desc,
                lang: lang,
                code: code
            };

            if (lang === 'hlsl') {
                const inputs = extractHlslInputs(code);
                obj.inputs = inputs.join(', ');
                hint.innerHTML = "Скопируйте и вставьте в <b>hlsl_db.js</b> (Инпуты определены автоматически):";
            } else {
                hint.innerHTML = "Скопируйте и вставьте в <b>snippets_db.js</b>:";
            }

            document.getElementById('outJson').value = "," + JSON.stringify(obj, null, 4);
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('outJson').select();
        }
    </script>
</body>
</html>
