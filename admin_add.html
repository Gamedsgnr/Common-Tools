<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Snippet Builder</title>
    <style>
        body { background: #222; color: #ddd; font-family: sans-serif; padding: 40px; max-width: 600px; margin: 0 auto; }
        input, textarea, select { width: 100%; background: #333; border: 1px solid #444; color: white; padding: 10px; margin-bottom: 15px; border-radius: 4px; display: block; box-sizing: border-box; }
        textarea { height: 150px; font-family: monospace; }
        label { font-size: 0.9em; color: #aaa; margin-bottom: 5px; display: block; }
        
        /* –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–∏–Ω–∏–π —Å—Ç–∏–ª—å */
        button { background: #007acc; color: white; border: none; padding: 15px; width: 100%; cursor: pointer; font-weight: bold; border-radius: 4px; transition: 0.2s; }
        button:hover { background: #005a9e; }

        .result-box { margin-top: 20px; background: #111; padding: 15px; border: 1px dashed #555; display: none; }
        .input-preview { margin-bottom: 15px; display: none; }
        .badge { display: inline-block; background: #444; color: #4ec9b0; padding: 2px 8px; border-radius: 3px; font-size: 0.8em; margin-right: 5px; border: 1px solid #555; }

        /* –õ–æ–∫–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å –≤ –æ–±—â–µ–º —Å—Ç–∏–ª–µ */
        .local-panel { 
            margin-top: 30px; 
            padding: 20px; 
            background: #1a1a1a; 
            border: 1px solid #333; 
            border-radius: 4px; 
            display: none; 
        }
        .btn-db-connect { background: #444; margin-bottom: 10px; }
        .btn-db-connect:hover { background: #555; }
        .btn-db-connect.connected { border-left: 4px solid #4ec9b0; color: #4ec9b0; }
        .btn-save-local { background: #007acc; display: none; margin-top: 10px; }
    </style>
</head>
<body>
    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–Ω–∏–ø–ø–µ—Ç</h2>
    
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ (Title):</label>
    <input type="text" id="inTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Custom Rotator">

    <label>–Ø–∑—ã–∫ (Language):</label>
    <select id="inLang" onchange="togglePreview()">
        <option value="cpp">C++</option>
        <option value="javascript">JavaScript</option>
        <option value="python">Python</option>
        <option value="html">HTML</option>
        <option value="css">CSS</option>
        <option value="hlsl">HLSL (Shader Code)</option> 
        <option value="text">Plain Text</option>
    </select>

    <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
    <input type="text" id="inDesc" placeholder="–ß—Ç–æ –æ–Ω –¥–µ–ª–∞–µ—Ç...">

    <label>–ö–æ–¥:</label>
    <textarea id="inCode" oninput="togglePreview()" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ —Å—é–¥–∞..."></textarea>

    <div id="inputPreview" class="input-preview">
        <label style="color: #4ec9b0;">–ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –≤—Ö–æ–¥—ã (Inputs):</label>
        <div id="badgeContainer"></div>
    </div>

    <button onclick="generateJSON()">–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ –î–õ–Ø –í–°–¢–ê–í–ö–ò</button>

    <div id="localAdmin" class="local-panel">
        <label id="dbLabel" style="color: #4ec9b0;">üè† –õ–û–ö–ê–õ–¨–ù–ê–Ø –ë–ê–ó–ê –î–ê–ù–ù–´–•</label>
        <div style="font-size: 11px; color: #666; margin-bottom: 10px;">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –Ω—É–∂–Ω—ã–π .js —Ñ–∞–π–ª –∏–∑ –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞</div>
        <button id="btnConnectDB" class="btn-db-connect" onclick="connectDatabase()">–ü–†–ò–í–Ø–ó–ê–¢–¨ –§–ê–ô–õ –ë–î (.js)</button>
        <button id="btnSaveToFile" class="btn-save-local" onclick="saveToLocalFile()">–î–û–ë–ê–í–ò–¢–¨ –í –§–ê–ô–õ –ë–ê–ó–´</button>
    </div>

    <div class="result-box" id="resultArea">
        <p id="pasteHint" style="color: #4ec9b0; margin-top: 0; font-size: 0.9em;">
            –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ <b>snippets_db.js</b>:
        </p>
        <textarea id="outJson" style="height: 120px; color: #ce9178; font-family: monospace;"></textarea>
    </div>

    <script>
        const hlslKeywords = new Set([
            'float','float2','float3','float4','half','half2','half3','half4','int','int2','int3','int4','uint','bool','fixed','float4x4','float3x3','void','return','if','else','for','while','break','continue','discard','true','false','const','static','loop','unroll','abs','acos','any','asin','atan','atan2','ceil','clamp','cos','cross','ddx','ddy','distance','dot','exp','exp2','floor','fmod','frac','length','lerp','log','max','min','mul','normalize','pow','reflect','refract','round','rsqrt','saturate','sign','sin','smoothstep','sqrt','step','tan','tanh','tex2D','all','View','ResolvedView','Parameters','Sample','Texture2D'
        ]);

        function extractHlslInputs(code) {
            const cleanCode = code.replace(/\/\*[\s\S]*?\*\/|\/\/.*/g, '');
            const declared = new Set();
            const declRegex = /\b(?:float[1-4]?|half[1-4]?|int[1-4]?|uint[1-4]?|bool|fixed|float4x4|float3x3|struct)\s+([a-zA-Z_][a-zA-Z0-9_]*)\b/g;
            let m;
            while ((m = declRegex.exec(cleanCode)) !== null) declared.add(m[1]);

            const inputs = new Set();
            const wordRegex = /(\.)?(\b[a-zA-Z_][a-zA-Z0-9_]*\b)/g;
            while ((m = wordRegex.exec(cleanCode)) !== null) {
                const hasDot = m[1] === '.';
                const word = m[2];
                if (!hasDot && !hlslKeywords.has(word) && !declared.has(word) && !/^[xyzwrgba]{1,4}$/.test(word)) {
                    inputs.add(word);
                }
            }
            return Array.from(inputs);
        }

        function togglePreview() {
            const lang = document.getElementById('inLang').value;
            const preview = document.getElementById('inputPreview');
            const code = document.getElementById('inCode').value;
            
            if (lang === 'hlsl' && code.trim() !== "") {
                const detected = extractHlslInputs(code);
                if (detected.length > 0) {
                    preview.style.display = 'block';
                    document.getElementById('badgeContainer').innerHTML = detected.map(i => `<span class="badge">${i}</span>`).join('');
                    return;
                }
            }
            preview.style.display = 'none';
        }

        // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç
        function generateJSON() {
            const title = document.getElementById('inTitle').value;
            const lang = document.getElementById('inLang').value;
            const desc = document.getElementById('inDesc').value;
            const code = document.getElementById('inCode').value;
            const hint = document.getElementById('pasteHint');

            if(!title || !code) { alert("–ó–∞–ø–æ–ª–Ω–∏ Title –∏ Code!"); return null; }

            const obj = {
                id: (lang === 'hlsl' ? "hlsl_" : "id_") + Date.now(),
                title: title,
                desc: desc,
                lang: lang,
                code: code
            };

            if (lang === 'hlsl') {
                const inputs = extractHlslInputs(code);
                obj.inputs = inputs.join(', ');
                hint.innerHTML = "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ <b>hlsl_db.js</b> (–ò–Ω–ø—É—Ç—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):";
            } else {
                hint.innerHTML = "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ <b>snippets_db.js</b>:";
            }

            document.getElementById('outJson').value = "," + JSON.stringify(obj, null, 4);
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('outJson').select();

            return obj;
        }

        // --- –õ–û–ì–ò–ö–ê –õ–û–ö–ê–õ–¨–ù–û–ì–û –°–û–•–†–ê–ù–ï–ù–ò–Ø ---
        let fileHandle;
        const localPanel = document.getElementById('localAdmin');
        const btnConnect = document.getElementById('btnConnectDB');
        const btnSave = document.getElementById('btnSaveToFile');

        const isLocal = window.location.hostname === "localhost" || 
                        window.location.hostname === "127.0.0.1" || 
                        window.location.protocol === "file:";

        if (isLocal) { localPanel.style.display = 'block'; }

        async function connectDatabase() {
            try {
                [fileHandle] = await window.showOpenFilePicker({
                    types: [{ description: 'JS Database', accept: {'text/javascript': ['.js']} }]
                });
                btnConnect.innerText = "‚úÖ –ë–î –ü–û–î–ö–õ–Æ–ß–ï–ù–ê (" + fileHandle.name + ")";
                btnConnect.classList.add('connected');
                btnSave.style.display = 'block';
            } catch (err) { console.log("User cancelled"); }
        }

        async function saveToLocalFile() {
            if (!fileHandle) return;
            const dataObj = generateJSON();
            if (!dataObj) return;

            try {
                const file = await fileHandle.getFile();
                let content = await file.text();

                // –ò—â–µ–º –∫–æ–Ω–µ—Ü –º–∞—Å—Å–∏–≤–∞ ];
                const lastBracketIndex = content.lastIndexOf('];');
                if (lastBracketIndex === -1) {
                    alert("–û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ]; –≤ —Ñ–∞–π–ª–µ " + file.name);
                    return;
                }

                const entryToAppend = `    ${JSON.stringify(dataObj, null, 4)},\n`;
                const newContent = content.slice(0, lastBracketIndex) + entryToAppend + content.slice(lastBracketIndex);

                const writable = await fileHandle.createWritable();
                await writable.write(newContent);
                await writable.close();

                alert("–°–Ω–∏–ø–ø–µ—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ " + file.name);
                
                // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                document.getElementById('inTitle').value = "";
                document.getElementById('inCode').value = "";
                togglePreview();
            } catch (err) {
                alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞: " + err.message);
            }
        }
    </script>
</body>
</html>