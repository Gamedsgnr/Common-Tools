<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CommonToolHub | Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #4ec9b0; --bg: #1e1e1e; --panel: #252526; --border: #333; --error: #f48771; }
        body { background: var(--bg); color: #ddd; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: var(--panel); padding: 30px; border-radius: 8px; border: 1px solid var(--border); width: 100%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; }
        
        h2 { color: var(--primary); margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; font-size: 1.2em; }
        label { display: block; margin: 15px 0 5px; font-size: 0.85em; color: #888; }
        input, textarea, select { width: 100%; background: #333; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 4px; box-sizing: border-box; outline: none; }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); }
        
        textarea { height: 200px; font-family: monospace; font-size: 0.9em; line-height: 1.4; color: #ce9178; }
        
        button { background: #007acc; color: white; border: none; padding: 12px; width: 100%; cursor: pointer; font-weight: bold; border-radius: 4px; margin-top: 20px; transition: 0.2s; }
        button:hover { background: #005a9e; }
        button:disabled { background: #444; cursor: not-allowed; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
        .hint-box { background: #2d2d30; padding: 10px; border-left: 3px solid #4ec9b0; margin-bottom: 15px; font-size: 0.85em; color: #ccc; display: none; }
        code { background: #111; padding: 2px 5px; border-radius: 3px; font-family: monospace; color: #dcdcaa; }

        /* –°—Ç–∞—Ç—É—Å—ã */
        .status { margin-top: 15px; padding: 10px; border-radius: 4px; font-size: 0.9em; display: none; }
        .success { background: rgba(78, 201, 176, 0.1); color: var(--primary); border: 1px solid var(--primary); }
        .error { background: rgba(209, 105, 105, 0.1); color: #d16969; border: 1px solid #d16969; }

        /* –≠–∫—Ä–∞–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ */
        #accessDenied { text-align: center; display: none; color: var(--error); }
        #accessDenied h1 { font-size: 3em; margin: 0; }
        #accessDenied p { color: #888; margin-top: 10px; }

        /* –§–æ—Ä–º–∞ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ –ø—Ä–æ–≤–µ—Ä–∫–∏) */
        #adminForm { display: none; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="accessDenied">
        <h1>üîí</h1>
        <h3>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h3>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ –±–æ–∫–æ–≤–æ–µ –º–µ–Ω—é.</p>
    </div>

    <div id="adminForm">
        <h2>üöÄ –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</h2>

        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
        <select id="targetTable" onchange="adjustFields()">
            <option value="snippets">–°–Ω–∏–ø–ø–µ—Ç (Python/JS/C++)</option>
            <option value="hlsl">HLSL Node (Custom Expression)</option>
            <option value="shaders">Shader / Material (BlueprintUE)</option>
            <option value="blueprints">Blueprint (BlueprintUE)</option>
        </select>

        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
        <input type="text" id="inTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ...">

        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <input type="text" id="inDesc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ...">

        <div id="extraFields"></div>

        <div id="hlslHint" class="hint-box">
            –î–ª—è –∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—Ö–æ–¥–æ–≤ –¥–æ–±–∞–≤—å –≤ –Ω–∞—á–∞–ª–æ –∫–æ–¥–∞ —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞:<br>
            <code>// Inputs: UV, Color, Power, Mask</code>
        </div>

        <label>–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥</label>
        <textarea id="inCode" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –∑–¥–µ—Å—å..."></textarea>

        <button id="btnSubmit" onclick="uploadData()">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨ –í –ë–ê–ó–£</button>
        <div id="statusMsg" class="status"></div>
    </div>
</div>

<script>
    // --- 1. –ù–ê–°–¢–†–û–ô–ö–ò SUPABASE ---
    const SUPABASE_URL = 'https://vmwwvwtsznxwoswzdzui.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_hfVfEOEyUxTAl9TCGQLQdA_2qpquHGk';
    
    // –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // –≠–ª–µ–º–µ–Ω—Ç—ã UI
    const adminForm = document.getElementById('adminForm');
    const accessDenied = document.getElementById('accessDenied');
    const statusMsg = document.getElementById('statusMsg');

    // --- 2. –ü–†–û–í–ï–†–ö–ê –°–ï–°–°–ò–ò –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ---
    async function checkAuth() {
        try {
            const { data: { session }, error } = await _supabase.auth.getSession();
            
            if (session) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–µ—Å—Å–∏—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                accessDenied.style.display = 'none';
                adminForm.style.display = 'block';
                adjustFields(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–µ–π
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å–µ—Å—Å–∏–∏ ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º
                adminForm.style.display = 'none';
                accessDenied.style.display = 'block';
            }
        } catch (err) {
            console.error("Auth check failed:", err);
            adminForm.style.display = 'none';
            accessDenied.innerHTML = "<p>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö</p>";
            accessDenied.style.display = 'block';
        }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
    checkAuth();

    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–ª–∏—Å—å –≤ —Å–æ—Å–µ–¥–Ω–µ–π –≤–∫–ª–∞–¥–∫–µ/—Ñ—Ä–µ–π–º–µ)
    _supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_OUT') {
            adminForm.style.display = 'none';
            accessDenied.style.display = 'block';
        } else if (event === 'SIGNED_IN' && session) {
            accessDenied.style.display = 'none';
            adminForm.style.display = 'block';
        }
    });

    // --- 3. –õ–û–ì–ò–ö–ê –§–û–†–ú–´ ---

    function adjustFields() {
        const table = document.getElementById('targetTable').value;
        const container = document.getElementById('extraFields');
        const hlslHint = document.getElementById('hlslHint');
        
        container.innerHTML = '';
        hlslHint.style.display = 'none';

        if (table === 'hlsl') {
            hlslHint.style.display = 'block';
        }
        else if (table === 'shaders' || table === 'blueprints') {
            container.innerHTML = `
                <label>ID —Å BlueprintUE</label>
                <input type="text" id="inEmbedId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: xyz123abc">
            `;
        }
    }

    async function uploadData() {
        const table = document.getElementById('targetTable').value;
        const btn = document.getElementById('btnSubmit');
        const codeVal = document.getElementById('inCode').value;
        const titleVal = document.getElementById('inTitle').value;
        
        if (!titleVal || !codeVal) {
            showStatus("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–æ–¥!", "error");
            return;
        }

        const payload = {
            title: titleVal,
            description: document.getElementById('inDesc').value,
            code: codeVal
        };

        // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –ø–æ–ª–µ–π ---
        
        // 1. HLSL: –ü–∞—Ä—Å–∏–Ω–≥ –∏–Ω–ø—É—Ç–æ–≤
        if (table === 'hlsl') {
            payload.lang = 'hlsl';
            const inputMatch = codeVal.match(/^\s*\/\/\s*Inputs:\s*(.*)$/im);
            if (inputMatch && inputMatch[1]) {
                payload.inputs = inputMatch[1].trim();
            } else {
                payload.inputs = "";
            }
        }

        // 2. BlueprintUE
        if (table === 'shaders' || table === 'blueprints') {
            const embedInput = document.getElementById('inEmbedId');
            if(embedInput) payload.embed_id = embedInput.value;
        }

        // 3. Snippets
        if (table === 'snippets') {
            payload.lang = 'text'; 
        }

        // –û–¢–ü–†–ê–í–ö–ê
        btn.disabled = true;
        btn.innerText = "–ó–ê–ì–†–£–ó–ö–ê...";
        statusMsg.style.display = 'none';

        try {
            const { error } = await _supabase.from(table).insert([payload]);

            if (error) throw error;

            showStatus("–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ " + table + "!", "success");
            
            // –û—á–∏—Å—Ç–∫–∞
            document.getElementById('inTitle').value = '';
            document.getElementById('inCode').value = '';
            document.getElementById('inDesc').value = '';
            if(document.getElementById('inEmbedId')) document.getElementById('inEmbedId').value = '';

        } catch (error) {
            showStatus("–û—à–∏–±–∫–∞: " + error.message, "error");
        } finally {
            btn.disabled = false;
            btn.innerText = "–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨ –í –ë–ê–ó–£";
        }
    }

    function showStatus(msg, type) {
        statusMsg.innerText = msg;
        statusMsg.className = 'status ' + type;
        statusMsg.style.display = 'block';
    }
</script>
</body>
</html>