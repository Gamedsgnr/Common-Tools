<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CommonToolHub | Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #4ec9b0; --bg: #1e1e1e; --panel: #252526; --border: #333; }
        body { background: var(--bg); color: #ddd; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: var(--panel); padding: 30px; border-radius: 8px; border: 1px solid var(--border); width: 100%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { color: var(--primary); margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; font-size: 1.2em; }
        label { display: block; margin: 15px 0 5px; font-size: 0.85em; color: #888; }
        input, textarea, select { width: 100%; background: #333; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 200px; font-family: monospace; font-size: 0.9em; line-height: 1.4; color: #ce9178; }
        button { background: #007acc; color: white; border: none; padding: 12px; width: 100%; cursor: pointer; font-weight: bold; border-radius: 4px; margin-top: 20px; transition: 0.2s; }
        button:hover { background: #005a9e; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
        .hint-box { background: #2d2d30; padding: 10px; border-left: 3px solid #4ec9b0; margin-bottom: 15px; font-size: 0.85em; color: #ccc; display: none; }
        code { background: #111; padding: 2px 5px; border-radius: 3px; font-family: monospace; color: #dcdcaa; }

        /* –°—Ç–∞—Ç—É—Å—ã */
        .status { margin-top: 15px; padding: 10px; border-radius: 4px; font-size: 0.9em; display: none; }
        .success { background: rgba(78, 201, 176, 0.1); color: var(--primary); border: 1px solid var(--primary); }
        .error { background: rgba(209, 105, 105, 0.1); color: #d16969; border: 1px solid #d16969; }
        
        .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logout-btn { background: none; color: #888; border: 1px solid #444; padding: 5px 10px; width: auto; margin: 0; font-size: 0.7em; }
    </style>
</head>
<body>

<div class="container">
    <div id="authSection">
        <h2>üîê –í—Ö–æ–¥ –¥–ª—è –∞–≤—Ç–æ—Ä–∞</h2>
        <label>Email</label>
        <input type="email" id="email">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="password">
        <button onclick="login()">–í–û–ô–¢–ò</button>
    </div>

    <div id="adminForm" style="display:none;">
        <div class="nav-header">
            <h2>üöÄ –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</h2>
            <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>

        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
        <select id="targetTable" onchange="adjustFields()">
            <option value="snippets">–°–Ω–∏–ø–ø–µ—Ç (Python/JS/C++)</option>
            <option value="hlsl">HLSL Node (Custom Expression)</option>
            <option value="shaders">Shader / Material (BlueprintUE)</option>
            <option value="blueprints">Blueprint (BlueprintUE)</option>
        </select>

        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
        <input type="text" id="inTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ...">

        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <input type="text" id="inDesc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ...">

        <div id="extraFields"></div>

        <div id="hlslHint" class="hint-box">
            –î–ª—è –∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—Ö–æ–¥–æ–≤ –¥–æ–±–∞–≤—å –≤ –Ω–∞—á–∞–ª–æ –∫–æ–¥–∞ —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞:<br>
            <code>// Inputs: UV, Color, Power, Mask</code>
        </div>

        <label>–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥</label>
        <textarea id="inCode" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –∑–¥–µ—Å—å..."></textarea>

        <button id="btnSubmit" onclick="uploadData()">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨ –í –ë–ê–ó–£</button>
        <div id="statusMsg" class="status"></div>
    </div>
</div>

<script>
    // --- –ù–ê–°–¢–†–û–ô–ö–ò SUPABASE (–í—Å—Ç–∞–≤—å —Å–≤–æ–∏!) ---
    const SUPABASE_URL = 'https://vmwwvwtsznxwoswzdzui.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_hfVfEOEyUxTAl9TCGQLQdA_2qpquHGk';
    
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const authSection = document.getElementById('authSection');
    const adminForm = document.getElementById('adminForm');
    const statusMsg = document.getElementById('statusMsg');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    async function checkUser() {
        const { data: { session } } = await _supabase.auth.getSession();
        if (session) {
            authSection.style.display = 'none';
            adminForm.style.display = 'block';
            adjustFields();
        } else {
            authSection.style.display = 'block';
            adminForm.style.display = 'none';
        }
    }
    checkUser();

    async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { error } = await _supabase.auth.signInWithPassword({ email, password });
        if (error) alert("–û—à–∏–±–∫–∞: " + error.message);
        else checkUser();
    }

    async function logout() {
        await _supabase.auth.signOut();
        checkUser();
    }

    function adjustFields() {
        const table = document.getElementById('targetTable').value;
        const container = document.getElementById('extraFields');
        const hlslHint = document.getElementById('hlslHint');
        
        container.innerHTML = '';
        hlslHint.style.display = 'none';

        if (table === 'hlsl') {
            hlslHint.style.display = 'block';
        }
        else if (table === 'shaders' || table === 'blueprints') {
            container.innerHTML = `
                <label>ID —Å BlueprintUE</label>
                <input type="text" id="inEmbedId" placeholder="xyz123abc">
            `;
        }
    }

    async function uploadData() {
        const table = document.getElementById('targetTable').value;
        const btn = document.getElementById('btnSubmit');
        const codeVal = document.getElementById('inCode').value;
        
        const payload = {
            title: document.getElementById('inTitle').value,
            description: document.getElementById('inDesc').value,
            code: codeVal
        };

        // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –†–ê–ó–ù–´–• –¢–ò–ü–û–í ---
        
        // 1. HLSL: –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫—É "// Inputs: ..."
        if (table === 'hlsl') {
            payload.lang = 'hlsl';
            
            // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É, –Ω–∞—á–∏–Ω–∞—é—â—É—é—Å—è —Å "// Inputs:" (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ)
            // –§–ª–∞–≥ 'm' (multiline) –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–∫–∞—Ç—å –ø–æ —Å—Ç—Ä–æ–∫–∞–º ^...$
            const inputMatch = codeVal.match(/^\s*\/\/\s*Inputs:\s*(.*)$/im);
            
            if (inputMatch && inputMatch[1]) {
                payload.inputs = inputMatch[1].trim();
                console.log("–ù–∞–π–¥–µ–Ω—ã –∏–Ω–ø—É—Ç—ã:", payload.inputs);
            } else {
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –∏–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
                payload.inputs = "";
                console.warn("–°—Ç—Ä–æ–∫–∞ '// Inputs:' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫–æ–¥–µ!");
            }
        }

        // 2. BlueprintUE (Shaders / Blueprints)
        if (table === 'shaders' || table === 'blueprints') {
            payload.embed_id = document.getElementById('inEmbedId').value;
        }

        // 3. Snippets (–ø—Ä–æ—Å—Ç–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω —è–≤–Ω–æ)
        if (table === 'snippets') {
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é, –ø–æ–∫–∞ —Å—Ç–∞–≤–∏–º 'text' –∏–ª–∏ –±–µ—Ä–µ–º –∏–∑ UI –µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å select
            payload.lang = 'text'; 
        }

        // –û–¢–ü–†–ê–í–ö–ê
        btn.disabled = true;
        btn.innerText = "–ó–ê–ì–†–£–ó–ö–ê...";

        const { error } = await _supabase.from(table).insert([payload]);

        btn.disabled = false;
        btn.innerText = "–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨ –í –ë–ê–ó–£";

        statusMsg.style.display = 'block';
        if (error) {
            statusMsg.className = 'status error';
            statusMsg.innerText = "–û—à–∏–±–∫–∞: " + error.message;
        } else {
            statusMsg.className = 'status success';
            statusMsg.innerText = "–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ " + table + "!";
            
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
            document.getElementById('inTitle').value = '';
            document.getElementById('inCode').value = '';
            if(document.getElementById('inEmbedId')) document.getElementById('inEmbedId').value = '';
        }
    }
</script>
</body>
</html>