<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Shader Adder</title>
    <style>
        body { background: #222; color: #ddd; font-family: sans-serif; padding: 30px; max-width: 800px; margin: 0 auto; }
        input, textarea { width: 100%; background: #333; border: 1px solid #444; color: white; padding: 10px; margin-bottom: 15px; border-radius: 4px; box-sizing: border-box; }
        textarea.code-in { height: 100px; font-family: monospace; font-size: 10px; opacity: 0.7; border-left: 3px solid #d16969; }
        label { color: #ce9178; font-weight: bold; margin-bottom: 5px; display: block; }
        .hint { font-size: 0.8em; color: #888; margin-bottom: 5px; }
        
        /* –ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫ */
        button { background: #d16969; color: white; border: none; padding: 15px; width: 100%; cursor: pointer; font-weight: bold; font-size: 1.1em; border-radius: 4px; transition: 0.2s; }
        button:hover { background: #b04c4c; }

        .result-box { margin-top: 30px; background: #151515; padding: 20px; border: 2px dashed #444; display: none; }

        /* –°—Ç–∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏ –≤ –æ–±—â–µ–º —Å—Ç–∏–ª–µ */
        .local-panel { 
            margin-top: 30px; 
            padding: 20px; 
            background: #1a1a1a; 
            border: 1px solid #333; 
            border-radius: 4px; 
            display: none; 
        }
        .btn-db-connect { background: #444; margin-bottom: 10px; } /* –í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
        .btn-db-connect:hover { background: #555; }
        .btn-db-connect.connected { border-left: 4px solid #ce9178; color: #ce9178; }

        .btn-save-local { background: #d16969; display: none; margin-top: 10px; }
    </style>
</head>
<body>
    <h2>üîÆ –î–æ–±–∞–≤–∏—Ç—å –®–µ–π–¥–µ—Ä/–ú–∞—Ç–µ—Ä–∏–∞–ª</h2>
    
    <label>1. –ù–∞–∑–≤–∞–Ω–∏–µ (Title)</label>
    <input type="text" id="inTitle" placeholder="–ü—Ä–∏–º–µ—Ä: Master Material Hologram">

    <label>2. –û–ø–∏—Å–∞–Ω–∏–µ</label>
    <input type="text" id="inDesc" placeholder="–ü–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –≥–æ–ª–æ–≥—Ä–∞–º–º...">

    <label>3. ID —Å —Å–∞–π—Ç–∞ BlueprintUE</label>
    <div class="hint">–í—Å—Ç–∞–≤—å—Ç–µ nodes –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –Ω–∞ —Å–∞–π—Ç, –Ω–∞–∂–º–∏—Ç–µ Create, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ ID –∏–∑ —Å—Å—ã–ª–∫–∏.</div>
    <input type="text" id="inId" placeholder="xyz123abc">

    <label>4. –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –Ω–æ–¥ (Ctrl+C –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤)</label>
    <textarea id="inCode" class="code-in" placeholder="Begin Object Class=/Script/Engine.Material..."></textarea>

    <button onclick="generate()">–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ JSON</button>

    <div id="localAdmin" class="local-panel">
        <label>üè† –õ–û–ö–ê–õ–¨–ù–ê–Ø –ë–ê–ó–ê –î–ê–ù–ù–´–•</label>
        <button id="btnConnectDB" class="btn-db-connect" onclick="connectDatabase()">–ü–†–ò–í–Ø–ó–ê–¢–¨ SHADERS_DB.JS</button>
        <button id="btnSaveToFile" class="btn-save-local" onclick="saveToLocalFile()">–î–û–ë–ê–í–ò–¢–¨ –í –§–ê–ô–õ –ë–ê–ó–´</button>
    </div>

    <div class="result-box" id="resultArea">
        <p style="color: #ce9178; margin-top: 0;">–°–∫–æ–ø–∏—Ä—É–π —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ –∏ –¥–æ–±–∞–≤—å –≤ —Ñ–∞–π–ª <b>shaders_db.js</b>:</p>
        <textarea id="outJson" style="height: 150px; color: #d4d4d4; font-family: monospace;"></textarea>
    </div>

    <script>
        // –¢–≤–æ—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function generate() {
            const title = document.getElementById('inTitle').value;
            const desc = document.getElementById('inDesc').value;
            const embedId = document.getElementById('inId').value.trim();
            const rawCode = document.getElementById('inCode').value;

            if(!title || !embedId) { alert("–ó–∞–ø–æ–ª–Ω–∏ Title –∏ ID!"); return; }

            const obj = {
                id: "sh_" + Date.now().toString().slice(-6),
                title: title,
                desc: desc,
                embedId: embedId,
                rawCode: rawCode
            };

            let jsonStr = JSON.stringify(obj, null, 4);
            const manualStr = "," + jsonStr; 

            const out = document.getElementById('outJson');
            out.value = manualStr;
            document.getElementById('resultArea').style.display = 'block';
            out.select();

            return obj;
        }

        // –õ–æ–≥–∏–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –∑–∞–ø–∏—Å–∏
        let fileHandle;
        const localPanel = document.getElementById('localAdmin');
        const btnConnect = document.getElementById('btnConnectDB');
        const btnSave = document.getElementById('btnSaveToFile');

        const isLocal = window.location.hostname === "localhost" || 
                        window.location.hostname === "127.0.0.1" || 
                        window.location.protocol === "file:";

        if (isLocal) { localPanel.style.display = 'block'; }

        async function connectDatabase() {
            try {
                [fileHandle] = await window.showOpenFilePicker({
                    types: [{ description: 'JS Database', accept: {'text/javascript': ['.js']} }]
                });
                btnConnect.innerText = "‚úÖ –ë–î –ü–û–î–ö–õ–Æ–ß–ï–ù–ê (" + fileHandle.name + ")";
                btnConnect.classList.add('connected');
                btnSave.style.display = 'block';
            } catch (err) { console.log("User cancelled"); }
        }

        async function saveToLocalFile() {
            if (!fileHandle) return;
            const shaderObj = generate();
            if (!shaderObj) return;

            try {
                const file = await fileHandle.getFile();
                let content = await file.text();

                const lastBracketIndex = content.lastIndexOf('];');
                if (lastBracketIndex === -1) {
                    alert("–û—à–∏–±–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–∞!");
                    return;
                }

                const entryToAppend = `    ${JSON.stringify(shaderObj, null, 4)},\n`;
                const newContent = content.slice(0, lastBracketIndex) + entryToAppend + content.slice(lastBracketIndex);

                const writable = await fileHandle.createWritable();
                await writable.write(newContent);
                await writable.close();

                alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –±–∞–∑—É!");
                
                // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
                document.getElementById('inTitle').value = "";
                document.getElementById('inId').value = "";
                document.getElementById('inCode').value = "";
            } catch (err) {
                alert("–û—à–∏–±–∫–∞: " + err.message);
            }
        }
    </script>
</body>
</html>