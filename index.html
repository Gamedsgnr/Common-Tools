<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Common Tools and Libs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit" async defer></script>
    <style>
        /* Сброс стилей */
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #1a1f2b;
            color: #dbe7f3;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- САЙДБАР --- */
        .sidebar {
            width: 260px;
            background: #141b26;
            border-right: 1px solid rgba(148, 163, 184, 0.15);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
            padding: 16px 12px;
            gap: 10px;
        }

        .sidebar-header {
            padding: 16px 14px;
            background: rgba(30, 41, 59, 0.45);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 16px;
            color: #7dd3fc;
            font-weight: bold;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow:
                0 14px 22px -12px rgba(2, 6, 23, 0.75),
                inset 0 1px 0 rgba(255, 255, 255, 0.18),
                inset 0 -12px 20px rgba(2, 6, 23, 0.28);
            backdrop-filter: blur(18px) saturate(1.2);
            -webkit-backdrop-filter: blur(18px) saturate(1.2);
            cursor: pointer;
        }

        .category-title {
            padding: 10px 8px 4px 8px;
            font-size: 0.72em;
            text-transform: uppercase;
            color: #9fb1c2;
            font-weight: bold;
            letter-spacing: 0.2em;
            transition: color 0.2s ease, text-shadow 0.2s ease;
        }

        .category-title.active {
            color: #d7e9ff;
            text-shadow: 0 0 12px rgba(125, 211, 252, 0.35);
        }

        .nav-links {
            list-style: none;
            padding: 0 4px 6px;
            overflow-y: auto;
        }

        .nav-links a {
            --item-accent: 125, 211, 252;
            display: block;
            padding: 10px 12px;
            color: #b8c2cf;
            text-decoration: none;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s, border-color 0.2s;
            border: 1px solid transparent;
            border-radius: 12px;
            font-size: 0.93em;
            position: relative;
            overflow: hidden;
        }

        .nav-links a::before {
            content: '';
            position: absolute;
            inset: 4px;
            border-radius: 10px;
            background:
                linear-gradient(160deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.02) 55%),
                linear-gradient(340deg, rgba(var(--item-accent), 0.16), rgba(var(--item-accent), 0) 60%);
            box-shadow:
                inset 0 0 10px rgba(255, 255, 255, 0.06),
                inset 0 0 16px rgba(var(--item-accent), 0.08);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            background:
                linear-gradient(135deg, rgba(2, 6, 23, 0.14), rgba(2, 6, 23, 0) 55%),
                linear-gradient(315deg, rgba(2, 6, 23, 0.24), rgba(2, 6, 23, 0) 60%);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .nav-links a i {
            width: 16px;
            text-align: center;
            color: rgba(var(--item-accent), 0.95);
            transition: color 0.2s ease, text-shadow 0.2s ease;
        }

        .nav-links a:hover {
            background: rgba(30, 41, 59, 0.45);
            color: #e6f0ff;
            border-color: rgba(var(--item-accent), 0.42);
            box-shadow:
                0 10px 18px -12px rgba(2, 6, 23, 0.7),
                inset 0 1px 0 rgba(255, 255, 255, 0.14),
                inset 0 -10px 18px rgba(2, 6, 23, 0.25),
                0 0 0 1px rgba(var(--item-accent), 0.14);
        }

        .nav-links a:hover::before,
        .nav-links a:hover::after {
            opacity: 1;
        }

        .nav-links a:hover i {
            color: rgba(var(--item-accent), 1);
            text-shadow: 0 0 12px rgba(var(--item-accent), 0.45);
        }

        .nav-links a.active {
            color: #e6f0ff;
            border-color: rgba(var(--item-accent), 0.55);
            background: rgba(30, 41, 59, 0.55);
            box-shadow:
                0 10px 18px -12px rgba(2, 6, 23, 0.7),
                inset 0 2px 4px rgba(255, 255, 255, 0.08),
                inset 0 -14px 22px rgba(2, 6, 23, 0.45),
                0 0 0 1px rgba(var(--item-accent), 0.2);
            animation: nav-press 220ms ease;
        }

        .nav-links a.active::before,
        .nav-links a.active::after {
            opacity: 1;
        }

        .nav-links a.active i {
            color: rgba(var(--item-accent), 1);
            text-shadow: 0 0 14px rgba(var(--item-accent), 0.5);
        }

        .nav-links a[href="blueprints_view.html"] { --item-accent: 134, 184, 216; }
        .nav-links a[href="shaders_view.html"] { --item-accent: 217, 132, 96; }
        .nav-links a[href="hlsl_view.html"] { --item-accent: 95, 163, 154; }
        .nav-links a[href="snippets_view.html"] { --item-accent: 141, 130, 186; }
        .nav-links a[href="UE_EnumGen.html"] { --item-accent: 125, 211, 252; }
        .nav-links a[href="UE_Converter_Pro.html"] { --item-accent: 95, 163, 154; }
        .nav-links a[href="CurveToCode_Pro.html"] { --item-accent: 134, 184, 216; }
        .nav-links a[href="progression_balancer.html"] { --item-accent: 185, 132, 96; }
        .nav-links a[href="factory_architect.html"] { --item-accent: 95, 163, 154; }
        .nav-links a[href="QuestArchitect2.html"] { --item-accent: 141, 130, 186; }
        .nav-links a[href="math_plotter.html"] { --item-accent: 125, 211, 252; }
        .nav-links a[href="shader_playground.html"] { --item-accent: 141, 130, 186; }
        .nav-links a[href="noise_gen.html"] { --item-accent: 95, 163, 154; }
        .nav-links a[href="admin_add.html"] { --item-accent: 134, 184, 216; }
        .nav-links a[href="admin_access_requests.html"] { --item-accent: 95, 163, 154; }
        .nav-links a[href="admin_bug_reports.html"] { --item-accent: 185, 137, 137; }

        @keyframes nav-press {
            0% { transform: translateY(0); box-shadow: 0 0 0 rgba(0,0,0,0); }
            60% { transform: translateY(1px); }
            100% { transform: translateY(0); }
        }

        .footer {
            margin-top: auto;
            padding: 12px 10px;
            font-size: 0.9em;
            color: #8fa1b3;
            text-align: center;
            border-top: 1px solid rgba(148, 163, 184, 0.15);
            cursor: pointer;
            transition: color 0.3s;
            user-select: none;
        }
        .footer:hover { color: #fff; }

        #loginBtn {
            border: 1px solid rgba(125, 211, 252, 0.4);
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(125, 211, 252, 0.2), rgba(30, 41, 59, 0.56));
            box-shadow:
                0 12px 20px -14px rgba(2, 6, 23, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.14),
                inset 0 -10px 18px rgba(2, 6, 23, 0.28);
            color: #dbe7f3;
        }

        #loginBtn:hover {
            border-color: rgba(125, 211, 252, 0.62);
            background: linear-gradient(135deg, rgba(125, 211, 252, 0.3), rgba(30, 41, 59, 0.62));
            box-shadow:
                0 12px 20px -14px rgba(2, 6, 23, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.14),
                inset 0 -10px 18px rgba(2, 6, 23, 0.28),
                0 0 0 1px rgba(125, 211, 252, 0.25),
                0 0 18px rgba(125, 211, 252, 0.2);
        }

        #loginBtn i {
            color: #7dd3fc;
            text-shadow: 0 0 10px rgba(125, 211, 252, 0.45);
        }

        #loginBtn.authenticated {
            border-color: rgba(95, 163, 154, 0.52);
            background: linear-gradient(135deg, rgba(95, 163, 154, 0.26), rgba(30, 41, 59, 0.56));
        }

        #loginBtn.authenticated:hover {
            border-color: rgba(95, 163, 154, 0.68);
            background: linear-gradient(135deg, rgba(95, 163, 154, 0.34), rgba(30, 41, 59, 0.62));
            box-shadow:
                0 12px 20px -14px rgba(2, 6, 23, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.14),
                inset 0 -10px 18px rgba(2, 6, 23, 0.28),
                0 0 0 1px rgba(95, 163, 154, 0.26),
                0 0 18px rgba(95, 163, 154, 0.24);
        }

        #loginBtn.authenticated i {
            color: #8ce6d6;
            text-shadow: 0 0 12px rgba(95, 163, 154, 0.5);
        }

        .footer.secondary {
            margin-top: 0;
            border-top: none;
            border: 1px solid rgba(185, 137, 137, 0.42);
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(185, 137, 137, 0.24), rgba(30, 41, 59, 0.52));
            box-shadow:
                0 12px 20px -14px rgba(2, 6, 23, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.14),
                inset 0 -10px 18px rgba(2, 6, 23, 0.28);
        }
        .footer.secondary:hover {
            color: #dbe7f3;
            border-color: rgba(185, 137, 137, 0.62);
            background: linear-gradient(135deg, rgba(185, 137, 137, 0.32), rgba(30, 41, 59, 0.58));
            box-shadow:
                0 12px 20px -14px rgba(2, 6, 23, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.14),
                inset 0 -10px 18px rgba(2, 6, 23, 0.28),
                0 0 0 1px rgba(185, 137, 137, 0.25),
                0 0 18px rgba(185, 137, 137, 0.2);
        }

        .footer.secondary i {
            color: #f3c5a5;
            text-shadow: 0 0 10px rgba(185, 137, 137, 0.45);
        }

        .footer.tertiary {
            margin-top: 0;
            border-top: none;
            border: 1px solid rgba(134, 184, 216, 0.4);
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(134, 184, 216, 0.2), rgba(30, 41, 59, 0.52));
            box-shadow:
                0 12px 20px -14px rgba(2, 6, 23, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.14),
                inset 0 -10px 18px rgba(2, 6, 23, 0.28);
            animation: access-pulse 2.4s ease-in-out infinite;
        }

        .footer.tertiary:hover {
            color: #dbe7f3;
            border-color: rgba(134, 184, 216, 0.62);
            background: linear-gradient(135deg, rgba(134, 184, 216, 0.3), rgba(30, 41, 59, 0.58));
            box-shadow:
                0 12px 20px -14px rgba(2, 6, 23, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.14),
                inset 0 -10px 18px rgba(2, 6, 23, 0.28),
                0 0 0 1px rgba(134, 184, 216, 0.24),
                0 0 18px rgba(134, 184, 216, 0.2);
        }

        .footer.tertiary i {
            color: #9ed3f7;
            text-shadow: 0 0 10px rgba(134, 184, 216, 0.4);
        }

        @keyframes access-pulse {
            0% {
                box-shadow:
                    0 12px 20px -14px rgba(2, 6, 23, 0.8),
                    inset 0 1px 0 rgba(255, 255, 255, 0.14),
                    inset 0 -10px 18px rgba(2, 6, 23, 0.28),
                    0 0 0 0 rgba(134, 184, 216, 0.25);
            }
            60% {
                box-shadow:
                    0 12px 20px -14px rgba(2, 6, 23, 0.8),
                    inset 0 1px 0 rgba(255, 255, 255, 0.14),
                    inset 0 -10px 18px rgba(2, 6, 23, 0.28),
                    0 0 0 8px rgba(134, 184, 216, 0);
            }
            100% {
                box-shadow:
                    0 12px 20px -14px rgba(2, 6, 23, 0.8),
                    inset 0 1px 0 rgba(255, 255, 255, 0.14),
                    inset 0 -10px 18px rgba(2, 6, 23, 0.28),
                    0 0 0 0 rgba(134, 184, 216, 0);
            }
        }

        /* --- ОСНОВНАЯ ЧАСТЬ --- */
        .main-content {
            flex-grow: 1;
            background-color: #1a1f2b;
            position: relative;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* Элементы админки (скрыты по умолчанию) */
        .admin-group { display: none; }

        /* --- МОДАЛЬНОЕ ОКНО --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        #bugReportModal {
            overflow: hidden;
        }

        .bug-modal-fx {
            position: absolute;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .bug-modal-fx .fx-bug {
            position: absolute;
            left: 0;
            top: 0;
            color: rgba(255, 166, 138, 0.62);
            text-shadow:
                0 0 10px rgba(255, 153, 119, 0.45),
                0 0 20px rgba(255, 119, 86, 0.3),
                0 0 24px rgba(2, 6, 23, 0.5);
            transform-origin: center center;
            user-select: none;
            will-change: transform, opacity;
            animation: bug-soft-blink 3.2s ease-in-out infinite;
        }

        @keyframes bug-soft-blink {
            0% { opacity: 0.26; }
            52% { opacity: 0.74; }
            100% { opacity: 0.26; }
        }

        .modal-box {
            background: #243142;
            padding: 30px;
            border: 1px solid #425368;
            border-radius: 8px;
            width: 340px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-box h3 { color: #6f98b2; margin-bottom: 10px; }

        .modal-box input {
            padding: 12px;
            background: #3a4a5e;
            border: 1px solid #4a5c73;
            color: white;
            border-radius: 4px;
            outline: none;
        }
        .modal-box input:focus { border-color: #6f98b2; }

        .modal-box button.btn-primary {
            padding: 12px;
            background: #3f6aa6;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
            margin-top: 10px;
        }
        .modal-box button.btn-primary:hover { background: #34598a; }

        .modal-box button.btn-close {
            background: transparent;
            color: #9aa4b2;
            border: none;
            cursor: pointer;
            padding: 5px;
        }
        .modal-box button.btn-close:hover { color: #ccc; }

        .error-msg {
            color: #f48771;
            font-size: 0.9em;
            display: none;
            margin-top: 5px;
        }

        .modal-box.bug-report-box {
            width: min(560px, 92vw);
            text-align: left;
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.28);
            border-radius: 16px;
            box-shadow:
                0 18px 30px -12px rgba(2, 6, 23, 0.7),
                inset 0 1px 0 rgba(255, 255, 255, 0.22),
                inset 0 -10px 22px rgba(2, 6, 23, 0.32);
            position: relative;
            z-index: 2;
        }

        .bug-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .bug-grid .full {
            grid-column: 1 / -1;
        }

        .bug-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .bug-field label {
            font-size: 0.8rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #9aa4b2;
        }

        .modal-box.bug-report-box input,
        .modal-box.bug-report-box select,
        .modal-box.bug-report-box textarea {
            width: 100%;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.65);
            border: 1px solid rgba(148, 163, 184, 0.25);
            color: #dbe7f3;
            border-radius: 10px;
            outline: none;
            font-family: inherit;
            resize: vertical;
            min-height: 42px;
        }

        .modal-box.bug-report-box textarea {
            min-height: 92px;
        }

        .modal-box.bug-report-box input:focus,
        .modal-box.bug-report-box select:focus,
        .modal-box.bug-report-box textarea:focus {
            border-color: rgba(125, 211, 252, 0.6);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .bug-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 4px;
        }

        .bug-actions .btn-ghost,
        .bug-actions .bug-submit {
            min-height: 42px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .bug-actions .bug-submit {
            flex: 1 1 0;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(148, 163, 184, 0.3);
            color: #9aa4b2;
            border-radius: 10px;
            padding: 10px 12px;
            cursor: pointer;
        }

        .btn-ghost:hover {
            color: #dbe7f3;
            border-color: rgba(148, 163, 184, 0.5);
        }

        .btn-primary.bug-submit {
            margin-top: 0;
            border-radius: 10px;
            padding: 10px 14px;
            background: #3b82f6;
        }

        .btn-primary.bug-submit:hover {
            background: #2f6fda;
        }

        .ok-msg {
            color: #7dd3fc;
            font-size: 0.9em;
            display: none;
        }

        .captcha-wrap {
            margin-top: 4px;
            display: none;
            align-items: center;
            justify-content: flex-start;
            min-height: 68px;
        }

        .captcha-wrap.is-visible {
            display: flex;
        }

        .captcha-note {
            color: #9aa4b2;
            font-size: 0.8em;
            line-height: 1.35;
        }

        .mobile-topbar,
        .mobile-overlay {
            display: none;
        }

        .mobile-topbar {
            --mobile-topbar-h: 56px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 90;
            height: var(--mobile-topbar-h);
            background: rgba(20, 27, 38, 0.92);
            border-bottom: 1px solid rgba(148, 163, 184, 0.22);
            backdrop-filter: blur(12px) saturate(1.1);
            -webkit-backdrop-filter: blur(12px) saturate(1.1);
            grid-template-columns: 40px 1fr auto;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
        }

        .mobile-brand {
            color: #dbe7f3;
            font-size: 0.95em;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-menu-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(30, 41, 59, 0.55);
            color: #dbe7f3;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .mobile-login-btn {
            min-width: 108px;
            max-width: 52vw;
            height: 36px;
            border-radius: 10px;
            border: 1px solid rgba(125, 211, 252, 0.45);
            background: linear-gradient(135deg, rgba(125, 211, 252, 0.22), rgba(30, 41, 59, 0.62));
            color: #dbe7f3;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 0 10px;
            font-size: 0.82em;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .mobile-login-btn i {
            color: #7dd3fc;
        }

        .mobile-login-btn.authenticated {
            border-color: rgba(95, 163, 154, 0.52);
            background: linear-gradient(135deg, rgba(95, 163, 154, 0.28), rgba(30, 41, 59, 0.62));
        }

        .mobile-login-btn.authenticated i {
            color: #8ce6d6;
        }

        .mobile-overlay {
            position: fixed;
            inset: 0;
            z-index: 50;
            background: rgba(2, 6, 23, 0.48);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        @media (max-width: 900px) {
            body {
                height: 100dvh;
                overflow: hidden;
                display: block;
            }

            .mobile-topbar {
                display: grid;
            }

            .mobile-overlay {
                display: block;
            }

            .sidebar {
                position: fixed;
                top: 56px;
                left: 0;
                width: min(88vw, 320px);
                height: calc(100dvh - 56px);
                z-index: 80;
                border-right: 1px solid rgba(148, 163, 184, 0.15);
                border-bottom: none;
                padding: 10px;
                gap: 8px;
                overflow: hidden auto;
                transform: translateX(-102%);
                transition: transform 0.22s ease;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }

            .sidebar-header {
                font-size: 1rem;
                padding: 12px;
            }

            body.mobile-sidebar-open .sidebar {
                transform: translateX(0);
            }

            body.mobile-sidebar-open .mobile-overlay {
                opacity: 1;
                pointer-events: auto;
            }

            body.mobile-sidebar-collapsed .mobile-menu-btn {
                opacity: 1;
                pointer-events: auto;
            }

            body.mobile-sidebar-open .mobile-menu-btn {
                opacity: 0;
                pointer-events: none;
            }

            .category-title {
                padding: 8px 6px 2px;
                font-size: 0.66em;
                letter-spacing: 0.14em;
            }

            .nav-links {
                padding: 0 2px 4px;
            }

            .nav-links a {
                padding: 9px 10px;
                font-size: 0.86em;
            }

            #loginBtn {
                display: none;
            }

            .main-content {
                height: calc(100dvh - 56px);
                margin-top: 56px;
            }

            .modal-box {
                width: min(92vw, 420px);
                padding: 18px;
            }

            .modal-box.bug-report-box {
                width: min(94vw, 560px);
            }

            .bug-grid {
                grid-template-columns: 1fr;
            }

            .bug-grid .full {
                grid-column: 1;
            }
        }

        @media (max-width: 640px) {
            .footer,
            .footer.secondary {
                font-size: 0.84em;
                padding: 10px 8px;
            }

            .mobile-brand {
                font-size: 0.88em;
            }

            .bug-actions {
                flex-direction: column-reverse;
                gap: 8px;
            }

            .bug-actions .btn-ghost,
            .bug-actions .bug-submit {
                width: 100%;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .footer.tertiary {
                animation: none;
            }
        }
    </style>
</head>
<body>
    <header class="mobile-topbar" id="mobileTopbar">
        <button class="mobile-menu-btn" id="mobileMenuBtn" type="button" onclick="openMobileSidebar()" aria-label="Open menu">
            <i class="fa-solid fa-bars"></i>
        </button>
        <div class="mobile-brand" onclick="openWelcomeHome()"><i class="fa-solid fa-toolbox" style="margin-right:8px"></i>Common Tools</div>
        <div class="mobile-login-btn" id="mobileLoginBtn" onclick="handleAuthClick()">
            <i class="fa-solid fa-lock"></i><span>Login</span>
        </div>
    </header>
    <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileSidebar()"></div>

    <aside class="sidebar">
        <div class="sidebar-header" onclick="openWelcomeHome()">
            <span><i class="fa-solid fa-toolbox" style="margin-right:8px"></i>Common Tools</span>
        </div>

        <div class="category-title">Visual Library</div>
        <ul class="nav-links">
            <li><a href="blueprints_view.html" target="tool-frame"><i class="fa-solid fa-cubes" style="margin-right:8px"></i>Blueprint Gallery</a></li>
            <li><a href="shaders_view.html" target="tool-frame"><i class="fa-solid fa-wand-magic-sparkles" style="margin-right:8px"></i>Shader Library</a></li>
            <li><a href="hlsl_view.html" target="tool-frame"><i class="fa-solid fa-code" style="margin-right:8px"></i>HLSL Library</a></li>
            <li><a href="snippets_view.html" target="tool-frame"><i class="fa-solid fa-file-code" style="margin-right:8px"></i>Snippets Library</a></li>
        </ul>

        <div class="category-title">Data Tools</div>
        <ul class="nav-links">
            <li><a href="UE_EnumGen.html" target="tool-frame"><i class="fa-solid fa-list-ol" style="margin-right:8px"></i>UE Enum Generator</a></li>
            <li><a href="UE_Converter_Pro.html" target="tool-frame"><i class="fa-solid fa-right-left" style="margin-right:8px"></i>Data Converter</a></li>
            <li><a href="CurveToCode_Pro.html" target="tool-frame"><i class="fa-solid fa-chart-line" style="margin-right:8px"></i>Curve Editor</a></li>
            <li><a href="progression_balancer.html" target="tool-frame"><i class="fa-solid fa-sliders" style="margin-right:8px"></i>Balance Progression Tool</a></li>
            <li><a href="factory_architect.html" target="tool-frame"><i class="fa-solid fa-industry" style="margin-right:8px"></i>Factory Architect</a></li>
            <li><a href="QuestArchitect2.html" target="tool-frame"><i class="fa-solid fa-diagram-project" style="margin-right:8px"></i>Quest Architect</a></li>
        </ul>

        <div class="category-title" style="color: #6f98b2;">Generators</div>
        <ul class="nav-links">
            <li><a href="math_plotter.html" target="tool-frame"><i class="fa-solid fa-square-root-variable" style="margin-right:8px"></i>Math Plotter</a></li>
            <li><a href="shader_playground.html" target="tool-frame"><i class="fa-solid fa-flask-vial" style="margin-right:8px"></i>HLSL Live Studio</a></li>
            <li><a href="noise_gen.html" target="tool-frame"><i class="fa-solid fa-image" style="margin-right:8px"></i>Texture Generator</a></li>
        </ul>

<div class="category-title admin-group" style="color: #6f98b2;">Admin Zone</div>
<ul class="nav-links admin-group">
    <li><a href="admin_add.html" target="tool-frame"><i class="fa-solid fa-pen-to-square" style="margin-right:8px"></i>Snippet Builder</a></li>
    <li><a href="admin_access_requests.html" target="tool-frame"><i class="fa-solid fa-user-check" style="margin-right:8px"></i>Access Requests</a></li>
    <li><a href="admin_bug_reports.html" target="tool-frame"><i class="fa-solid fa-bug" style="margin-right:8px"></i>Bug Reports</a></li>
</ul>

        <div class="footer" id="loginBtn" onclick="handleAuthClick()">
            <i id="statusIcon" class="fa-solid fa-lock" style="margin-right:8px"></i> Login
        </div>
        <div class="footer tertiary" id="accessRequestBtn" onclick="openAccessRequestModal()">
            <i class="fa-solid fa-envelope-open-text" style="margin-right:8px"></i> Access Request
        </div>
        <div class="footer secondary" id="bugReportBtn" onclick="openBugReportModal()">
            <i class="fa-solid fa-bug" style="margin-right:8px"></i> Bug Report
        </div>
    </aside>

    <main class="main-content">
        <iframe src="welcome.html" name="tool-frame" id="tool-frame"></iframe>
    </main>

    <div class="modal-overlay" id="loginModal">
        <div class="modal-box">
            <h3>Login</h3>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button class="btn-primary" onclick="loginSupabase()">SIGN IN</button>
            <button class="btn-close" onclick="closeModal()">Cancel</button>
            <div id="loginError" class="error-msg">Error message here</div>
        </div>
    </div>

    <div class="modal-overlay" id="bugReportModal">
        <div class="bug-modal-fx" id="bugModalFx" aria-hidden="true"></div>
        <div class="modal-box bug-report-box">
            <h3>Bug Report</h3>
            <div class="bug-grid">
                <div class="bug-field">
                    <label for="bugTool">Tool</label>
                    <select id="bugTool">
                        <option value="welcome">Welcome</option>
                        <option value="blueprints_view">Blueprint Gallery</option>
                        <option value="shaders_view">Shader Library</option>
                        <option value="hlsl_view">HLSL Library</option>
                        <option value="snippets_view">Snippets Library</option>
                        <option value="questarchitect2">Quest Architect</option>
                        <option value="ue_enumgen">UE Enum Generator</option>
                        <option value="ue_converter_pro">Data Converter</option>
                        <option value="curve_editor">Curve Editor</option>
                        <option value="math_plotter">Math Plotter</option>
                        <option value="hlsl_live_studio">HLSL Live Studio</option>
                        <option value="texture_generator">Texture Generator</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="bug-field">
                    <label for="bugPage">Page URL</label>
                    <input id="bugPage" type="text" readonly>
                </div>
                <div class="bug-field">
                    <label for="bugSeverity">Severity</label>
                    <select id="bugSeverity">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="bug-field full">
                    <label for="bugDescription">Describe Bug</label>
                    <textarea id="bugDescription" maxlength="4000" placeholder="What happened?"></textarea>
                </div>
                <div class="bug-field full">
                    <label for="bugSteps">Steps to Reproduce (optional)</label>
                    <textarea id="bugSteps" maxlength="4000" placeholder="1. ... 2. ... 3. ..."></textarea>
                </div>
                <div class="bug-field">
                    <label for="bugExpected">Expected Result (optional)</label>
                    <textarea id="bugExpected" maxlength="2000"></textarea>
                </div>
                <div class="bug-field">
                    <label for="bugActual">Actual Result (optional)</label>
                    <textarea id="bugActual" maxlength="2000"></textarea>
                </div>
            </div>
            <div id="bugCaptchaWrap" class="captcha-wrap">
                <div id="bugCaptcha"></div>
            </div>
            <div id="bugCaptchaNote" class="captcha-note" style="display:none;">Captcha is required for anonymous reports.</div>
            <div id="bugReportError" class="error-msg">Error</div>
            <div id="bugReportOk" class="ok-msg">Report sent.</div>
            <div class="bug-actions">
                <button class="btn-primary bug-submit" onclick="closeBugReportModal()">Cancel</button>
                <button class="btn-primary bug-submit" id="bugSubmitBtn" onclick="submitBugReport()">Send Report</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="accessRequestModal">
        <div class="modal-box bug-report-box">
            <h3>Access Request</h3>
            <p style="color:#9aa4b2; font-size:0.86em; line-height:1.45; margin-bottom:6px;">
                Open registration is planned. Right now the platform is in active development, so I am granting access manually based on requests.
            </p>
            <p style="color:#9aa4b2; font-size:0.84em; line-height:1.45; margin-bottom:8px;">
                Current access gives you early use of the tool set and feedback participation while features are still being refined.
                Requests are also collected to measure real interest and prioritize the roadmap.
            </p>
            <div class="bug-grid">
                <div class="bug-field full">
                    <label for="requestEmail">Email</label>
                    <input id="requestEmail" type="email" maxlength="255" placeholder="you@example.com">
                </div>
                <div class="bug-field full">
                    <label for="requestAbout">About You / Your Use Case</label>
                    <textarea id="requestAbout" maxlength="3000" placeholder="Tell me a bit about yourself and how you plan to use Common Tools."></textarea>
                </div>
            </div>
            <div id="requestCaptchaWrap" class="captcha-wrap">
                <div id="requestCaptcha"></div>
            </div>
            <div id="requestCaptchaNote" class="captcha-note" style="display:none;">Captcha is required for anonymous requests.</div>
            <div id="requestError" class="error-msg">Error</div>
            <div id="requestOk" class="ok-msg">Request sent.</div>
            <div class="bug-actions">
                <button class="btn-primary bug-submit" onclick="closeAccessRequestModal()">Cancel</button>
                <button class="btn-primary bug-submit" id="requestSubmitBtn" onclick="submitAccessRequest()">Send Request</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. НАСТРОЙКИ SUPABASE ---
        var SUPABASE_URL = 'https://vmwwvwtsznxwoswzdzui.supabase.co'; 
        var SUPABASE_KEY = 'sb_publishable_hfVfEOEyUxTAl9TCGQLQdA_2qpquHGk';
        var TURNSTILE_SITE_KEY = '0x4AAAAAACaV158q5lWbH-_T';
        
        var _sbClient = null;
        var _bugCaptchaWidgetId = null;
        var _requestCaptchaWidgetId = null;
        var _bugCaptchaToken = '';
        var _requestCaptchaToken = '';
        var _bugFxItems = [];
        var _bugFxAnimId = null;
        var _bugFxPrevTs = 0;
        var _bugFxLastSpawn = 0;

        // --- 2. ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ ---
        window.onload = async function() {
            console.log("CommonToolHub: Script loaded");
            initMobileLayout();
            setupSidebarActive();

            try {
                if (window.supabase) {
                    _sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                } else {
                    console.error("Библиотека Supabase JS не загружена.");
                    return;
                }

                // Проверяем текущую сессию
                const { data: { session }, error } = await _sbClient.auth.getSession();
                
                if (session) {
                    unlockUI(session.user);
                } else {
                    lockUI();
                }
                
                _sbClient.auth.onAuthStateChange((event, session) => {
                    if (session) unlockUI(session.user);
                    else lockUI();
                });

            } catch (err) {
                console.error("Ошибка инициализации Supabase:", err);
            }
        }

        // --- 3. ОБРАБОТКА КЛИКА ПО LOGIN ---
        function randomRange(min, max) {
            return min + Math.random() * (max - min);
        }

        function clearBugModalFx() {
            const layer = document.getElementById('bugModalFx');
            _bugFxItems = [];
            if (_bugFxAnimId) {
                cancelAnimationFrame(_bugFxAnimId);
                _bugFxAnimId = null;
            }
            _bugFxPrevTs = 0;
            _bugFxLastSpawn = 0;
            if (layer) layer.innerHTML = '';
        }

        function spawnBugModalFx() {
            const layer = document.getElementById('bugModalFx');
            const modal = document.getElementById('bugReportModal');
            if (!layer || !modal || modal.style.display !== 'flex') return;
            if (_bugFxItems.length >= 180) return;

            const width = modal.clientWidth || window.innerWidth;
            const radius = randomRange(13, 17);
            const x = randomRange(radius, Math.max(radius + 1, width - radius));
            const y = randomRange(-120, -22);

            const el = document.createElement('i');
            el.className = 'fa-solid fa-bug fx-bug';
            el.style.fontSize = `${Math.round(radius * 2)}px`;
            el.style.animationDuration = `${randomRange(3.2, 6.1).toFixed(2)}s`;
            layer.appendChild(el);

            _bugFxItems.push({
                el: el,
                x: x,
                y: y,
                vx: randomRange(-26, 26),
                vy: randomRange(-8, 18),
                r: radius,
                a: randomRange(-0.4, 0.4),
                va: randomRange(-0.35, 0.35),
                m: radius * radius,
                sleeping: false,
                restTime: 0
            });
        }

        function resolveBugModalFxCollisions() {
            for (let i = 0; i < _bugFxItems.length; i += 1) {
                const a = _bugFxItems[i];
                for (let j = i + 1; j < _bugFxItems.length; j += 1) {
                    const b = _bugFxItems[j];
                    const dx = b.x - a.x;
                    const dy = b.y - a.y;
                    const minDist = a.r + b.r;
                    const distSq = dx * dx + dy * dy;
                    if (distSq >= minDist * minDist) continue;

                    const dist = Math.sqrt(Math.max(distSq, 0.0001));
                    const nx = dx / dist;
                    const ny = dy / dist;
                    const overlap = minDist - dist;
                    const invMassA = 1 / a.m;
                    const invMassB = 1 / b.m;
                    const invMassSum = invMassA + invMassB;

                    a.x -= nx * overlap * (invMassA / invMassSum);
                    a.y -= ny * overlap * (invMassA / invMassSum);
                    b.x += nx * overlap * (invMassB / invMassSum);
                    b.y += ny * overlap * (invMassB / invMassSum);

                    const rvx = b.vx - a.vx;
                    const rvy = b.vy - a.vy;
                    const velAlongNormal = rvx * nx + rvy * ny;
                    if (velAlongNormal > 0) continue;

                    const restitution = 0.3;
                    const impulse = -(1 + restitution) * velAlongNormal / invMassSum;
                    const ix = impulse * nx;
                    const iy = impulse * ny;

                    a.vx -= ix * invMassA;
                    a.vy -= iy * invMassA;
                    b.vx += ix * invMassB;
                    b.vy += iy * invMassB;
                    a.sleeping = false;
                    b.sleeping = false;
                    a.restTime = 0;
                    b.restTime = 0;
                }
            }
        }

        function tickBugModalFx(ts) {
            const modal = document.getElementById('bugReportModal');
            if (!modal || modal.style.display !== 'flex') {
                _bugFxAnimId = null;
                return;
            }

            if (!_bugFxPrevTs) _bugFxPrevTs = ts;
            const dt = Math.min((ts - _bugFxPrevTs) / 1000, 0.034);
            _bugFxPrevTs = ts;

            if ((ts - _bugFxLastSpawn) >= 860) {
                spawnBugModalFx();
                _bugFxLastSpawn = ts;
            }

            const width = modal.clientWidth || window.innerWidth;
            const height = modal.clientHeight || window.innerHeight;
            const gravity = 520;

            for (let i = 0; i < _bugFxItems.length; i += 1) {
                const b = _bugFxItems[i];
                if (b.sleeping) continue;
                b.vy += gravity * dt;
                b.x += b.vx * dt;
                b.y += b.vy * dt;
                b.a += (b.vx / Math.max(b.r, 0.01)) * dt + b.va * dt;
                b.va *= 0.992;

                if (b.x < b.r) {
                    b.x = b.r;
                    b.vx *= -0.48;
                } else if (b.x > width - b.r) {
                    b.x = width - b.r;
                    b.vx *= -0.48;
                }

                const floor = height - b.r - 6;
                if (b.y > floor) {
                    b.y = floor;
                    if (Math.abs(b.vy) < 28) b.vy = 0;
                    else b.vy *= -0.28;
                    b.vx *= 0.985;
                    if (Math.abs(b.vx) < 2.5) b.vx = 0;
                }

                const onFloor = b.y >= (floor - 0.6);
                const nearStill = Math.abs(b.vx) < 1.2 && Math.abs(b.vy) < 1.2 && Math.abs(b.va) < 0.05;
                if (onFloor && nearStill) {
                    b.restTime += dt;
                    if (b.restTime >= 5) {
                        b.sleeping = true;
                        b.vx = 0;
                        b.vy = 0;
                        b.va = 0;
                    }
                } else {
                    b.restTime = 0;
                }
            }

            resolveBugModalFxCollisions();

            for (let i = 0; i < _bugFxItems.length; i += 1) {
                const b = _bugFxItems[i];
                b.el.style.transform = `translate(${(b.x - b.r).toFixed(2)}px, ${(b.y - b.r).toFixed(2)}px) rotate(${b.a.toFixed(3)}rad)`;
            }

            _bugFxAnimId = requestAnimationFrame(tickBugModalFx);
        }

        function initBugModalFx() {
            if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
            clearBugModalFx();
            for (let i = 0; i < 7; i += 1) spawnBugModalFx();
            _bugFxAnimId = requestAnimationFrame(tickBugModalFx);
        }
        function handleAuthClick() {
            if (!_sbClient) {
                alert("Ошибка: Supabase не инициализирован. Проверьте консоль.");
                return;
            }

            const isAuth = sessionStorage.getItem('ct_supabase_auth') === 'true';
            
            if (isAuth) {
                if(confirm("Вы уже авторизованы. Выйти из аккаунта?")) {
                    logoutSupabase();
                }
            } else {
                const modal = document.getElementById('loginModal');
                if (modal) {
                    modal.style.display = 'flex';
                    const emailInput = document.getElementById('email');
                    if (emailInput) emailInput.focus();
                }
            }
        }

        function closeModal() {
            const modal = document.getElementById('loginModal');
            const errBox = document.getElementById('loginError');
            if (modal) modal.style.display = 'none';
            if (errBox) errBox.style.display = 'none';
        }

        function openBugReportModal() {
            const modal = document.getElementById('bugReportModal');
            const pageInput = document.getElementById('bugPage');
            const toolSelect = document.getElementById('bugTool');
            const okBox = document.getElementById('bugReportOk');
            const errBox = document.getElementById('bugReportError');
            const captchaNote = document.getElementById('bugCaptchaNote');

            if (pageInput) pageInput.value = window.location.href;
            if (toolSelect) toolSelect.value = detectCurrentTool();
            if (okBox) okBox.style.display = 'none';
            if (errBox) errBox.style.display = 'none';
            if (captchaNote) captchaNote.style.display = 'none';
            if (modal) modal.style.display = 'flex';
            initBugModalFx();
            ensureCaptchaForModal('bug');
        }

        function closeBugReportModal() {
            const modal = document.getElementById('bugReportModal');
            const errBox = document.getElementById('bugReportError');
            const okBox = document.getElementById('bugReportOk');
            if (modal) modal.style.display = 'none';
            if (errBox) errBox.style.display = 'none';
            if (okBox) okBox.style.display = 'none';
            clearBugModalFx();
        }

        function openAccessRequestModal() {
            const modal = document.getElementById('accessRequestModal');
            const okBox = document.getElementById('requestOk');
            const errBox = document.getElementById('requestError');
            const captchaNote = document.getElementById('requestCaptchaNote');
            if (okBox) okBox.style.display = 'none';
            if (errBox) errBox.style.display = 'none';
            if (captchaNote) captchaNote.style.display = 'none';
            if (modal) modal.style.display = 'flex';
            const emailInput = document.getElementById('requestEmail');
            if (emailInput) emailInput.focus();
            ensureCaptchaForModal('request');
        }

        function closeAccessRequestModal() {
            const modal = document.getElementById('accessRequestModal');
            const okBox = document.getElementById('requestOk');
            const errBox = document.getElementById('requestError');
            if (modal) modal.style.display = 'none';
            if (okBox) okBox.style.display = 'none';
            if (errBox) errBox.style.display = 'none';
        }

        function detectCurrentTool() {
            const active = document.querySelector('.nav-links a.active');
            const href = active ? active.getAttribute('href') : '';
            const map = {
                'welcome.html': 'welcome',
                'blueprints_view.html': 'blueprints_view',
                'shaders_view.html': 'shaders_view',
                'hlsl_view.html': 'hlsl_view',
                'snippets_view.html': 'snippets_view',
                'QuestArchitect2.html': 'questarchitect2',
                'UE_EnumGen.html': 'ue_enumgen',
                'UE_Converter_Pro.html': 'ue_converter_pro',
                'CurveToCode_Pro.html': 'curve_editor',
                'math_plotter.html': 'math_plotter',
                'shader_playground.html': 'hlsl_live_studio',
                'noise_gen.html': 'texture_generator'
            };
            return map[href] || 'other';
        }

        async function isAnonymousUser() {
            if (!_sbClient) return true;
            try {
                const { data: { user } } = await _sbClient.auth.getUser();
                return !user;
            } catch (_) {
                return true;
            }
        }

        async function extractFunctionError(err, fallbackText) {
            if (!err) return fallbackText;
            const defaultMessage = (err.message || '').trim();

            const context = err.context || err.response || null;
            if (context) {
                try {
                    const response = typeof context.clone === 'function' ? context.clone() : context;
                    const data = await response.json();
                    if (data && typeof data.error === 'string' && data.error.trim()) return data.error.trim();
                    if (data && typeof data.message === 'string' && data.message.trim()) return data.message.trim();
                } catch (_) {
                    // no-op
                }
                try {
                    const response = typeof context.clone === 'function' ? context.clone() : context;
                    const text = await response.text();
                    if (typeof text === 'string' && text.trim()) return text.trim();
                } catch (_) {
                    // no-op
                }
            }

            if (defaultMessage && !/non-2xx/i.test(defaultMessage)) return defaultMessage;
            return defaultMessage || fallbackText;
        }

        function hasCaptchaConfigured() {
            return typeof TURNSTILE_SITE_KEY === 'string' && TURNSTILE_SITE_KEY.trim().length > 0;
        }

        async function ensureCaptchaForModal(kind) {
            const isAnon = await isAnonymousUser();
            const wrapId = kind === 'bug' ? 'bugCaptchaWrap' : 'requestCaptchaWrap';
            const widgetHostId = kind === 'bug' ? 'bugCaptcha' : 'requestCaptcha';
            const noteId = kind === 'bug' ? 'bugCaptchaNote' : 'requestCaptchaNote';
            const wrap = document.getElementById(wrapId);
            const note = document.getElementById(noteId);
            if (!wrap) return;

            if (!isAnon) {
                wrap.classList.remove('is-visible');
                if (note) note.style.display = 'none';
                return;
            }

            wrap.classList.add('is-visible');
            if (!hasCaptchaConfigured() || typeof window.turnstile === 'undefined') {
                if (note) {
                    note.innerText = 'Captcha is not configured. Set TURNSTILE_SITE_KEY in index.html.';
                    note.style.display = 'block';
                }
                return;
            }

            if (note) note.style.display = 'none';

            if (kind === 'bug' && _bugCaptchaWidgetId === null) {
                _bugCaptchaWidgetId = window.turnstile.render('#' + widgetHostId, {
                    sitekey: TURNSTILE_SITE_KEY,
                    callback: function(token) { _bugCaptchaToken = token || ''; },
                    'expired-callback': function() { _bugCaptchaToken = ''; },
                    'error-callback': function() { _bugCaptchaToken = ''; }
                });
                return;
            }

            if (kind === 'request' && _requestCaptchaWidgetId === null) {
                _requestCaptchaWidgetId = window.turnstile.render('#' + widgetHostId, {
                    sitekey: TURNSTILE_SITE_KEY,
                    callback: function(token) { _requestCaptchaToken = token || ''; },
                    'expired-callback': function() { _requestCaptchaToken = ''; },
                    'error-callback': function() { _requestCaptchaToken = ''; }
                });
                return;
            }

            const widgetId = kind === 'bug' ? _bugCaptchaWidgetId : _requestCaptchaWidgetId;
            if (widgetId !== null) {
                window.turnstile.reset(widgetId);
            }
        }

        // --- 4. ВХОД / ВЫХОД ---
        async function loginSupabase() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errBox = document.getElementById('loginError');
            const btn = document.querySelector('.modal-box .btn-primary');

            if (!email || !password) {
                errBox.innerText = "Введите Email и пароль";
                errBox.style.display = 'block';
                return;
            }

            errBox.style.display = 'none';
            btn.innerText = "Checking...";
            btn.disabled = true;

            try {
                const { data, error } = await _sbClient.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) {
                    throw error;
                } else {
                    closeModal();
                }
            } catch (error) {
                console.error("Login error:", error);
                errBox.innerText = error.message || "Ошибка входа";
                errBox.style.display = 'block';
            } finally {
                btn.innerText = "SIGN IN";
                btn.disabled = false;
            }
        }

        async function logoutSupabase() {
            if (_sbClient) {
                await _sbClient.auth.signOut();
                lockUI();
            }
        }

        async function submitBugReport() {
            if (!_sbClient) return;

            const desc = document.getElementById('bugDescription').value.trim();
            const toolKey = document.getElementById('bugTool').value;
            const pageUrl = document.getElementById('bugPage').value.trim();
            const steps = document.getElementById('bugSteps').value.trim();
            const expected = document.getElementById('bugExpected').value.trim();
            const actual = document.getElementById('bugActual').value.trim();
            const severity = document.getElementById('bugSeverity').value;
            const errBox = document.getElementById('bugReportError');
            const okBox = document.getElementById('bugReportOk');
            const btn = document.getElementById('bugSubmitBtn');
            const captchaNote = document.getElementById('bugCaptchaNote');

            errBox.style.display = 'none';
            okBox.style.display = 'none';

            if (desc.length < 10) {
                errBox.innerText = 'Describe the bug in at least 10 characters.';
                errBox.style.display = 'block';
                return;
            }

            const isAnon = await isAnonymousUser();
            if (isAnon) {
                if (!hasCaptchaConfigured()) {
                    errBox.innerText = 'Captcha is not configured.';
                    errBox.style.display = 'block';
                    if (captchaNote) captchaNote.style.display = 'block';
                    return;
                }
                if (!_bugCaptchaToken) {
                    errBox.innerText = 'Please complete captcha before sending.';
                    errBox.style.display = 'block';
                    if (captchaNote) captchaNote.style.display = 'block';
                    return;
                }
            }

            btn.disabled = true;
            btn.innerText = 'Sending...';

            try {
                const payload = {
                    tool_key: toolKey,
                    bug_description: desc,
                    steps_to_reproduce: steps || null,
                    expected_result: expected || null,
                    actual_result: actual || null,
                    severity: severity || 'medium',
                    page_url: pageUrl || null,
                    user_agent: navigator.userAgent || null
                };

                const { data, error } = await _sbClient.functions.invoke('submit-public-form', {
                    body: {
                        form_type: 'bug_report',
                        captcha_token: _bugCaptchaToken || null,
                        payload: payload
                    }
                });
                if (error) throw error;
                if (data && data.error) throw new Error(data.error);

                document.getElementById('bugDescription').value = '';
                document.getElementById('bugSteps').value = '';
                document.getElementById('bugExpected').value = '';
                document.getElementById('bugActual').value = '';
                document.getElementById('bugSeverity').value = 'medium';
                _bugCaptchaToken = '';
                if (typeof window.turnstile !== 'undefined' && _bugCaptchaWidgetId !== null) {
                    window.turnstile.reset(_bugCaptchaWidgetId);
                }
                okBox.innerText = 'Report sent. Thank you.';
                okBox.style.display = 'block';
            } catch (err) {
                errBox.innerText = await extractFunctionError(err, 'Failed to send report.');
                errBox.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerText = 'Send Report';
            }
        }

        // --- 5. ОБНОВЛЕНИЕ ИНТЕРФЕЙСА ---
        function toggleAccessRequestVisibility(isAuthenticated) {
            const requestBtn = document.getElementById('accessRequestBtn');
            if (requestBtn) {
                requestBtn.style.display = isAuthenticated ? 'none' : 'flex';
            }
        }

        function unlockUI(user) {
            console.log("User authorized:", user.email);
            sessionStorage.setItem('ct_supabase_auth', 'true'); 
            
            document.querySelectorAll('.admin-group').forEach(el => el.style.display = 'block');
            toggleAccessRequestVisibility(true);
            
            const btn = document.getElementById('loginBtn');
            if (btn) {
                btn.classList.add('authenticated');
                btn.innerHTML = `<i class="fa-solid fa-circle-check" style="margin-right:8px"></i> ${user.email}`;
            }

            const mobileBtn = document.getElementById('mobileLoginBtn');
            if (mobileBtn) {
                mobileBtn.classList.add('authenticated');
                mobileBtn.innerHTML = `<i class="fa-solid fa-circle-check"></i><span>${user.email}</span>`;
            }

            broadcastAuthState(true, user?.email || null);
        }

        function lockUI() {
            sessionStorage.removeItem('ct_supabase_auth');
            document.querySelectorAll('.admin-group').forEach(el => el.style.display = 'none');
            toggleAccessRequestVisibility(false);
            
            const btn = document.getElementById('loginBtn');
            if (btn) {
                btn.classList.remove('authenticated');
                btn.innerHTML = '<i id="statusIcon" class="fa-solid fa-lock" style="margin-right:8px"></i> Login';
            }

            const mobileBtn = document.getElementById('mobileLoginBtn');
            if (mobileBtn) {
                mobileBtn.classList.remove('authenticated');
                mobileBtn.innerHTML = '<i class="fa-solid fa-lock"></i><span>Login</span>';
            }

            broadcastAuthState(false, null);
        }

        function broadcastAuthState(isAuth, email) {
            const frame = document.getElementById('tool-frame');
            if (frame && frame.contentWindow) {
                frame.contentWindow.postMessage({ type: 'ct_auth', isAuth, email }, '*');
            }
        }

        function isMobileViewport() {
            return window.matchMedia('(max-width: 900px)').matches;
        }

        function openMobileSidebar() {
            if (!isMobileViewport()) return;
            document.body.classList.add('mobile-sidebar-open');
            document.body.classList.remove('mobile-sidebar-collapsed');
        }

        function closeMobileSidebar() {
            if (!isMobileViewport()) return;
            document.body.classList.remove('mobile-sidebar-open');
            document.body.classList.add('mobile-sidebar-collapsed');
        }

        function initMobileLayout() {
            const frame = document.getElementById('tool-frame');

            function syncLayout() {
                if (isMobileViewport()) {
                    const hasState =
                        document.body.classList.contains('mobile-sidebar-open') ||
                        document.body.classList.contains('mobile-sidebar-collapsed');
                    if (!hasState) {
                        document.body.classList.add('mobile-sidebar-open');
                        document.body.classList.remove('mobile-sidebar-collapsed');
                    }
                    if (frame) {
                        const src = (frame.getAttribute('src') || '').toLowerCase();
                        if (src === 'welcome.html') {
                            frame.setAttribute('src', 'about:blank');
                            frame.src = 'about:blank';
                        }
                    }
                } else {
                    document.body.classList.remove('mobile-sidebar-open', 'mobile-sidebar-collapsed');
                }
            }

            syncLayout();
            window.addEventListener('resize', syncLayout);
        }

        function openWelcomeHome() {
            const frame = document.getElementById('tool-frame');
            if (frame) {
                frame.setAttribute('src', 'welcome.html');
                frame.src = 'welcome.html';
            }
            document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.category-title').forEach(title => title.classList.remove('active'));
            localStorage.removeItem('ct_active_link');
            if (isMobileViewport()) {
                closeMobileSidebar();
            }
        }

        async function submitAccessRequest() {
            if (!_sbClient) {
                const errBox = document.getElementById('requestError');
                if (errBox) {
                    errBox.innerText = 'Supabase client not initialized.';
                    errBox.style.display = 'block';
                }
                return;
            }

            const email = (document.getElementById('requestEmail').value || '').trim().toLowerCase();
            const about = (document.getElementById('requestAbout').value || '').trim();
            const errBox = document.getElementById('requestError');
            const okBox = document.getElementById('requestOk');
            const btn = document.getElementById('requestSubmitBtn');
            const captchaNote = document.getElementById('requestCaptchaNote');

            if (errBox) errBox.style.display = 'none';
            if (okBox) okBox.style.display = 'none';

            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                errBox.innerText = 'Please enter a valid email.';
                errBox.style.display = 'block';
                return;
            }

            if (about.length < 15) {
                errBox.innerText = 'Please add at least 15 characters about yourself/use case.';
                errBox.style.display = 'block';
                return;
            }

            const isAnon = await isAnonymousUser();
            if (isAnon) {
                if (!hasCaptchaConfigured()) {
                    errBox.innerText = 'Captcha is not configured.';
                    errBox.style.display = 'block';
                    if (captchaNote) captchaNote.style.display = 'block';
                    return;
                }
                if (!_requestCaptchaToken) {
                    errBox.innerText = 'Please complete captcha before sending.';
                    errBox.style.display = 'block';
                    if (captchaNote) captchaNote.style.display = 'block';
                    return;
                }
            }

            btn.disabled = true;
            btn.innerText = 'Sending...';

            try {
                const { data, error } = await _sbClient.functions.invoke('submit-public-form', {
                    body: {
                        form_type: 'access_request',
                        captcha_token: _requestCaptchaToken || null,
                        payload: {
                            email: email,
                            about: about,
                            page_url: window.location.href || null,
                            user_agent: navigator.userAgent || null
                        }
                    }
                });
                if (error) throw error;
                if (data && data.error) throw new Error(data.error);

                let action = 'saved';
                if (data && data.action) {
                    action = data.action;
                }

                document.getElementById('requestAbout').value = '';
                _requestCaptchaToken = '';
                if (typeof window.turnstile !== 'undefined' && _requestCaptchaWidgetId !== null) {
                    window.turnstile.reset(_requestCaptchaWidgetId);
                }
                if (action === 'appended') {
                    okBox.innerText = 'Existing request found. Your new text was appended.';
                } else if (action === 'blocked_duplicate') {
                    okBox.innerText = 'No changes saved: same text was already submitted.';
                } else {
                    okBox.innerText = 'Request saved. Next submissions with this email will update the same request instead of creating a new row.';
                }
                okBox.style.display = 'block';
            } catch (err) {
                errBox.innerText = await extractFunctionError(err, 'Failed to send request.');
                errBox.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerText = 'Send Request';
            }
        }

        function setupSidebarActive() {
            const links = Array.from(document.querySelectorAll('.nav-links a'));
            const titles = Array.from(document.querySelectorAll('.category-title'));
            const frame = document.getElementById('tool-frame');

            function clearActive() {
                links.forEach(link => link.classList.remove('active'));
                titles.forEach(title => title.classList.remove('active'));
            }

            function setActive(link) {
                if (!link) return;
                clearActive();
                link.classList.add('active');
                const title = link.closest('ul')?.previousElementSibling;
                if (title && title.classList.contains('category-title')) {
                    title.classList.add('active');
                }
                localStorage.setItem('ct_active_link', link.getAttribute('href'));
            }

            links.forEach(link => {
                link.addEventListener('click', () => {
                    setActive(link);
                    if (isMobileViewport()) {
                        closeMobileSidebar();
                    }
                });
            });

            const stored = localStorage.getItem('ct_active_link');
            const initialHref = stored || frame?.getAttribute('src');
            const initialLink = initialHref ? links.find(l => l.getAttribute('href') === initialHref) : links[0];
            setActive(initialLink);

            if (frame) {
                frame.addEventListener('load', () => {
                    const src = frame.getAttribute('src');
                    const match = links.find(l => l.getAttribute('href') === src);
                    if (match) setActive(match);
                });
            }
        }

        window.onclick = function(event) {
            const loginModal = document.getElementById('loginModal');
            const bugModal = document.getElementById('bugReportModal');
            const requestModal = document.getElementById('accessRequestModal');
            if (event.target == loginModal) {
                closeModal();
            }
            if (event.target == bugModal) {
                closeBugReportModal();
            }
            if (event.target == requestModal) {
                closeAccessRequestModal();
            }
        }
    </script>
</body>
</html>





