<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Common Tools and Libs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π */
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #1a1f2b;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- –°–ê–ô–î–ë–ê–† --- */
        .sidebar {
            width: 260px;
            background: #141b26;
            border-right: 1px solid rgba(148, 163, 184, 0.15);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
            padding: 16px 12px;
            gap: 10px;
        }

        .sidebar-header {
            padding: 16px 14px;
            background: rgba(30, 41, 59, 0.45);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 16px;
            color: #7dd3fc;
            font-weight: bold;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow:
                0 14px 22px -12px rgba(2, 6, 23, 0.75),
                inset 0 1px 0 rgba(255, 255, 255, 0.18),
                inset 0 -12px 20px rgba(2, 6, 23, 0.28);
            backdrop-filter: blur(18px) saturate(1.2);
            -webkit-backdrop-filter: blur(18px) saturate(1.2);
        }

        .category-title {
            padding: 10px 8px 4px 8px;
            font-size: 0.72em;
            text-transform: uppercase;
            color: #9fb1c2;
            font-weight: bold;
            letter-spacing: 0.2em;
            transition: color 0.2s ease, text-shadow 0.2s ease;
        }

        .category-title.active {
            color: #d7e9ff;
            text-shadow: 0 0 12px rgba(125, 211, 252, 0.35);
        }

        .nav-links {
            list-style: none;
            padding: 0 4px 6px;
            overflow-y: auto;
        }

        .nav-links a {
            display: block;
            padding: 10px 12px;
            color: #b8c2cf;
            text-decoration: none;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s, border-color 0.2s;
            border: 1px solid transparent;
            border-radius: 8px;
            font-size: 0.93em;
        }

        .nav-links a:hover {
            background: rgba(30, 41, 59, 0.45);
            color: #e6f0ff;
            border-color: rgba(148, 163, 184, 0.35);
            box-shadow:
                0 10px 18px -12px rgba(2, 6, 23, 0.7),
                inset 0 1px 0 rgba(255, 255, 255, 0.14),
                inset 0 -10px 18px rgba(2, 6, 23, 0.25);
        }

        .nav-links a.active {
            color: #e6f0ff;
            border-color: rgba(125, 211, 252, 0.5);
            background: rgba(30, 41, 59, 0.55);
            box-shadow:
                0 10px 18px -12px rgba(2, 6, 23, 0.7),
                inset 0 2px 4px rgba(255, 255, 255, 0.08),
                inset 0 -14px 22px rgba(2, 6, 23, 0.45);
            animation: nav-press 220ms ease;
        }

        @keyframes nav-press {
            0% { transform: translateY(0); box-shadow: 0 0 0 rgba(0,0,0,0); }
            60% { transform: translateY(1px); }
            100% { transform: translateY(0); }
        }

        .footer {
            margin-top: auto;
            padding: 12px 10px;
            font-size: 0.9em;
            color: #8fa1b3;
            text-align: center;
            border-top: 1px solid rgba(148, 163, 184, 0.15);
            cursor: pointer;
            transition: color 0.3s;
            user-select: none;
        }
        .footer:hover { color: #fff; }

        /* --- –û–°–ù–û–í–ù–ê–Ø –ß–ê–°–¢–¨ --- */
        .main-content {
            flex-grow: 1;
            background-color: #1a1f2b;
            position: relative;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã –∞–¥–º–∏–Ω–∫–∏ (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
        .admin-group { display: none; }

        /* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal-box {
            background: #252526;
            padding: 30px;
            border: 1px solid #444;
            border-radius: 8px;
            width: 340px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-box h3 { color: #4ec9b0; margin-bottom: 10px; }

        .modal-box input {
            padding: 12px;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            outline: none;
        }
        .modal-box input:focus { border-color: #4ec9b0; }

        .modal-box button.btn-primary {
            padding: 12px;
            background: #007acc;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
            margin-top: 10px;
        }
        .modal-box button.btn-primary:hover { background: #005a9e; }

        .modal-box button.btn-close {
            background: transparent;
            color: #888;
            border: none;
            cursor: pointer;
            padding: 5px;
        }
        .modal-box button.btn-close:hover { color: #ccc; }

        .error-msg {
            color: #f48771;
            font-size: 0.9em;
            display: none;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <span>üü¶ Common Tools</span>
        </div>

        <div class="category-title">Visual Library</div>
        <ul class="nav-links">
            <li><a href="blueprints_view.html" target="tool-frame">üß© Blueprint Gallery</a></li>
            <li><a href="shaders_view.html" target="tool-frame">üîÆ Shader Library</a></li>
            <li><a href="hlsl_view.html" target="tool-frame">üíª HLSL Library</a></li>
            <li><a href="snippets_view.html" target="tool-frame">üìú Snippets Library</a></li>
        </ul>

        <div class="category-title">Data Tools</div>
        <ul class="nav-links">
            <li><a href="UE_EnumGen.html" target="tool-frame">üíæ UE Enum Generator</a></li>
            <li><a href="UE_Converter_Pro.html" target="tool-frame">üîÑ Data Converter</a></li>
            <li><a href="CurveToCode_Pro.html" target="tool-frame">üìâ Curve Editor</a></li>
            <li><a href="progression_balancer.html" target="tool-frame">üìä Balance Progression Tool</a></li>
            <li><a href="factory_architect.html" target="tool-frame">üè≠ Factory Architect</a></li>
            <li><a href="QuestArchitect2.html" target="tool-frame"><i class="fa-solid fa-diagram-project"></i> Quest Architect</a></li>
        </ul>

        <div class="category-title" style="color: #4ec9b0;">Generators</div>
        <ul class="nav-links">
            <li><a href="math_plotter.html" target="tool-frame">üìà Math Plotter</a></li>
            <li><a href="shader_playground.html" target="tool-frame">üéÆ HLSL Live Studio</a></li>
            <li><a href="noise_gen.html" target="tool-frame">üèÅ Texture Generator</a></li>
        </ul>

<div class="category-title admin-group" style="color: #4ec9b0;">Admin Zone</div>
<ul class="nav-links admin-group">
    <li><a href="admin_add.html" target="tool-frame">üìù Snippet Builder</a></li>
</ul>

        <div class="footer" id="loginBtn" onclick="handleAuthClick()">
            <span id="statusIcon">üîí</span> Login
        </div>
    </aside>

    <main class="main-content">
        <iframe src="welcome.html" name="tool-frame" id="tool-frame"></iframe>
    </main>

    <div class="modal-overlay" id="loginModal">
        <div class="modal-box">
            <h3>Supabase Login</h3>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button class="btn-primary" onclick="loginSupabase()">SIGN IN</button>
            <button class="btn-close" onclick="closeModal()">Cancel</button>
            <div id="loginError" class="error-msg">Error message here</div>
        </div>
    </div>

    <script>
        // --- 1. –ù–ê–°–¢–†–û–ô–ö–ò SUPABASE ---
        var SUPABASE_URL = 'https://vmwwvwtsznxwoswzdzui.supabase.co'; 
        var SUPABASE_KEY = 'sb_publishable_hfVfEOEyUxTAl9TCGQLQdA_2qpquHGk';
        
        var _sbClient = null;

        // --- 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ---
        window.onload = async function() {
            console.log("CommonToolHub: Script loaded");
            setupSidebarActive();

            try {
                if (window.supabase) {
                    _sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                } else {
                    console.error("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Supabase JS –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.");
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é
                const { data: { session }, error } = await _sbClient.auth.getSession();
                
                if (session) {
                    unlockUI(session.user);
                }
                
                _sbClient.auth.onAuthStateChange((event, session) => {
                    if (session) unlockUI(session.user);
                    else lockUI();
                });

            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:", err);
            }
        }

        // --- 3. –û–ë–†–ê–ë–û–¢–ö–ê –ö–õ–ò–ö–ê –ü–û LOGIN ---
        function handleAuthClick() {
            if (!_sbClient) {
                alert("–û—à–∏–±–∫–∞: Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
                return;
            }

            const isAuth = sessionStorage.getItem('ct_supabase_auth') === 'true';
            
            if (isAuth) {
                if(confirm("–í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?")) {
                    logoutSupabase();
                }
            } else {
                const modal = document.getElementById('loginModal');
                if (modal) {
                    modal.style.display = 'flex';
                    const emailInput = document.getElementById('email');
                    if (emailInput) emailInput.focus();
                }
            }
        }

        function closeModal() {
            const modal = document.getElementById('loginModal');
            const errBox = document.getElementById('loginError');
            if (modal) modal.style.display = 'none';
            if (errBox) errBox.style.display = 'none';
        }

        // --- 4. –í–•–û–î / –í–´–•–û–î ---
        async function loginSupabase() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errBox = document.getElementById('loginError');
            const btn = document.querySelector('.modal-box .btn-primary');

            if (!email || !password) {
                errBox.innerText = "–í–≤–µ–¥–∏—Ç–µ Email –∏ –ø–∞—Ä–æ–ª—å";
                errBox.style.display = 'block';
                return;
            }

            errBox.style.display = 'none';
            btn.innerText = "Checking...";
            btn.disabled = true;

            try {
                const { data, error } = await _sbClient.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) {
                    throw error;
                } else {
                    closeModal();
                }
            } catch (error) {
                console.error("Login error:", error);
                errBox.innerText = error.message || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞";
                errBox.style.display = 'block';
            } finally {
                btn.innerText = "SIGN IN";
                btn.disabled = false;
            }
        }

        async function logoutSupabase() {
            if (_sbClient) {
                await _sbClient.auth.signOut();
                lockUI();
            }
        }

        // --- 5. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
        function unlockUI(user) {
            console.log("User authorized:", user.email);
            sessionStorage.setItem('ct_supabase_auth', 'true'); 
            
            document.querySelectorAll('.admin-group').forEach(el => el.style.display = 'block');
            
            const btn = document.getElementById('loginBtn');
            if (btn) {
                btn.innerHTML = `<span style="margin-right:8px">üü¢</span> ${user.email}`;
                btn.style.color = "#fff";
            }

            broadcastAuthState(true, user?.email || null);
        }

        function lockUI() {
            sessionStorage.removeItem('ct_supabase_auth');
            document.querySelectorAll('.admin-group').forEach(el => el.style.display = 'none');
            
            const btn = document.getElementById('loginBtn');
            if (btn) {
                btn.innerHTML = '<span id="statusIcon" style="margin-right:8px">üîí</span> Login';
                btn.style.color = "#888";
            }

            broadcastAuthState(false, null);
        }

        function broadcastAuthState(isAuth, email) {
            const frame = document.getElementById('tool-frame');
            if (frame && frame.contentWindow) {
                frame.contentWindow.postMessage({ type: 'ct_auth', isAuth, email }, '*');
            }
        }

        function setupSidebarActive() {
            const links = Array.from(document.querySelectorAll('.nav-links a'));
            const titles = Array.from(document.querySelectorAll('.category-title'));
            const frame = document.getElementById('tool-frame');

            function clearActive() {
                links.forEach(link => link.classList.remove('active'));
                titles.forEach(title => title.classList.remove('active'));
            }

            function setActive(link) {
                if (!link) return;
                clearActive();
                link.classList.add('active');
                const title = link.closest('ul')?.previousElementSibling;
                if (title && title.classList.contains('category-title')) {
                    title.classList.add('active');
                }
                localStorage.setItem('ct_active_link', link.getAttribute('href'));
            }

            links.forEach(link => {
                link.addEventListener('click', () => setActive(link));
            });

            const stored = localStorage.getItem('ct_active_link');
            const initialHref = stored || frame?.getAttribute('src');
            const initialLink = initialHref ? links.find(l => l.getAttribute('href') === initialHref) : links[0];
            setActive(initialLink);

            if (frame) {
                frame.addEventListener('load', () => {
                    const src = frame.getAttribute('src');
                    const match = links.find(l => l.getAttribute('href') === src);
                    if (match) setActive(match);
                });
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('loginModal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
