<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CommonToolHub | Math Plotter Pro</title>
    <style>
        body { margin: 0; background: #1a1a1a; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; color: #ccc; overflow: hidden; }
        .sidebar { width: 380px; border-right: 2px solid #333; display: flex; flex-direction: column; background: #1e1e1e; }
        
        .section-header { background: #252526; padding: 10px; font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; border-bottom: 1px solid #333; margin-top: 5px; }
        
        /* –°–µ—Ç–∫–∞ –ø—Ä–µ—Å–µ—Ç–æ–≤ */
        .presets-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; padding: 10px; background: #202020; }
        .btn-preset { background: #2d2d2d; border: 1px solid #3f3f3f; color: #d4d4d4; padding: 6px; font-size: 11px; cursor: pointer; text-align: left; border-radius: 3px; transition: 0.2s; }
        .btn-preset:hover { background: #007acc; color: white; border-color: #007acc; }

        /* –ü–∞–Ω–µ–ª—å —Ñ—É–Ω–∫—Ü–∏–π */
        .quick-fill { padding: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; background: #252526; }
        .btn-func { background: #333; border: 1px solid #444; color: #4ec9b0; padding: 4px; font-size: 10px; cursor: pointer; border-radius: 2px; }
        .btn-func:hover { background: #4ec9b0; color: #111; }

        .formula-area { padding: 10px; background: #111; }
        textarea { width: 100%; height: 70px; background: #1e1e1e; color: #ce9178; border: 1px solid #333; padding: 10px; font-family: 'Consolas', monospace; font-size: 14px; resize: none; box-sizing: border-box; outline: none; }
        textarea:focus { border-color: #007acc; }

        .error-msg { color: #f44747; font-size: 11px; padding: 5px 10px; background: rgba(244, 71, 71, 0.1); display: none; }

        .params-container { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; border-top: 1px solid #333; }
        .param-row { display: flex; flex-direction: column; gap: 4px; font-size: 11px; background: #252526; padding: 8px; border-radius: 4px; }
        .param-info { display: flex; justify-content: space-between; color: #9cdcfe; }
        
        input[type="range"] { width: 100%; height: 4px; cursor: pointer; appearance: none; background: #444; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 12px; height: 12px; background: #007acc; border-radius: 50%; }

        .output-area { padding: 10px; background: #1e1e1e; border-top: 1px solid #333; }
        .hlsl-label { font-size: 10px; color: #569cd6; margin-bottom: 5px; display: block; }
        .hlsl-code { background: #0a0a0a; padding: 10px; font-size: 12px; color: #d4d4d4; border-radius: 4px; font-family: 'Consolas', monospace; border: 1px solid #333; white-space: pre-wrap; margin-bottom: 5px; }

        .main-view { flex: 1; position: relative; background: #0c0c0c; }
        canvas { width: 100%; height: 100%; }
        .coord-info { position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.7); padding: 5px 12px; font-size: 11px; color: #888; border-radius: 20px; border: 1px solid #333; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="section-header">Shader Presets</div>
    <div class="presets-grid">
        <button class="btn-preset" onclick="loadPreset('sin(x * freq) * amp')">üìà Sine Wave</button>
        <button class="btn-preset" onclick="loadPreset('frac(x * freq) * amp')">üìê Sawtooth</button>
        <button class="btn-preset" onclick="loadPreset('step(0.5, frac(x * freq))')">üü¶ Square Pulse</button>
        <button class="btn-preset" onclick="loadPreset('abs(frac(x * freq) * 2.0 - 1.0)')">üî∫ Triangle</button>
        <button class="btn-preset" onclick="loadPreset('smoothstep(0.0, 1.0, sin(x) * 0.5 + 0.5)')">üåä Soft Glow</button>
        <button class="btn-preset" onclick="loadPreset('pow(abs(sin(x)), exp)')">üîã Sharp Pulse</button>
    </div>

    <div class="section-header">Quick HLSL functions</div>
    <div class="quick-fill">
        <button class="btn-func" onclick="insert('abs(')">abs</button>
        <button class="btn-func" onclick="insert('frac(')">frac</button>
        <button class="btn-func" onclick="insert('step(0.5, ')">step</button>
        <button class="btn-func" onclick="insert('saturate(')">saturate</button>
        <button class="btn-func" onclick="insert('smoothstep(0., 1., ')">s-step</button>
        <button class="btn-func" onclick="insert('lerp(a, b, t)')">lerp</button>
        <button class="btn-func" onclick="insert('clamp(x, 0., 1.)')">clamp</button>
        <button class="btn-func" onclick="insert('pow(x, 2.)')">pow</button>
    </div>

    <div class="section-header">Formula (y =)</div>
    <div class="formula-area">
        <textarea id="formulaInput" spellcheck="false" oninput="compileFormula()">sin(x * freq) * amp</textarea>
    </div>
    <div id="errorDisplay" class="error-msg"></div>

    <div class="section-header">Inputs / Parameters</div>
    <div id="paramsContainer" class="params-container"></div>

    <div class="section-header">UE Custom Node (Standard)</div>
    <div class="output-area">
        <div id="hlslOutput" class="hlsl-code"></div>
        <button class="btn-preset" style="width:100%; text-align:center;" onclick="copyCode('hlslOutput')">üìã Copy for Unreal</button>
    </div>

    <div class="section-header">For HLSL Studio (Playground)</div>
    <div class="output-area">
        <div id="studioOutput" class="hlsl-code" style="color: #ce9178;"></div>
        <button class="btn-preset" style="width:100%; text-align:center; background: #28a745;" onclick="copyCode('studioOutput')">üöÄ Copy for Studio</button>
    </div>
</div>

<div class="main-view">
    <div class="coord-info" id="coordInfo">X: 0.00, Y: 0.00</div>
    <canvas id="plotCanvas"></canvas>
</div>

<script>
    const canvas = document.getElementById('plotCanvas');
    const ctx = canvas.getContext('2d');
    const formulaInput = document.getElementById('formulaInput');
    const paramsContainer = document.getElementById('paramsContainer');
    const errorDisplay = document.getElementById('errorDisplay');
    const hlslOutput = document.getElementById('hlslOutput');
    const studioOutput = document.getElementById('studioOutput');
    const coordInfo = document.getElementById('coordInfo');
    
    let params = { freq: 2.0, amp: 1.0, exp: 4.0 };
    let compiledFunc = null;
    let currentParamNames = [];
    let viewScale = 70;

    // –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ (HLSL style –¥–ª—è JS)
    const frac = (x) => x - Math.floor(x);
    const lerp = (a, b, t) => a * (1 - t) + b * t;
    const step = (e, x) => x < e ? 0 : 1;
    const saturate = (x) => Math.max(0, Math.min(1, x));
    const smoothstep = (e0, e1, x) => {
        let t = Math.max(0, Math.min(1, (x - e0) / (e1 - e0)));
        return t * t * (3 - 2 * t);
    };
    const clamp = (x, min, max) => Math.max(min, Math.min(max, x));

    function compileFormula() {
        const rawCode = formulaInput.value;
        const words = rawCode.match(/[a-zA-Z_]\w*/g) || [];
        const reserved = ['sin','cos','abs','step','smoothstep','frac','lerp','clamp','saturate','x','PI','pow','exp','log','sqrt','tan','max','min','Time'];
        currentParamNames = [...new Set(words.filter(w => !reserved.includes(w)))];

        try {
            const argNames = ['x', ...currentParamNames, 'sin', 'cos', 'abs', 'frac', 'step', 'smoothstep', 'lerp', 'clamp', 'saturate', 'pow', 'PI', 'Time'];
            compiledFunc = new Function(...argNames, `return ${rawCode};`);
            
            errorDisplay.style.display = 'none';
            updateOutputs(rawCode);
            updateParamsUI();
        } catch (e) {
            errorDisplay.innerText = "Syntax Error: " + e.message;
            errorDisplay.style.display = 'block';
            compiledFunc = null;
        }
    }

    function updateOutputs(code) {
        // 1. –í—ã–≤–æ–¥ –¥–ª—è Unreal Custom Node
        let inputs = currentParamNames.length > 0 ? `// Inputs: x, ${currentParamNames.join(', ')}\n` : `// Input: x\n`;
        hlslOutput.innerText = `${inputs}return ${code};`;

        // 2. –í—ã–≤–æ–¥ –¥–ª—è —Ç–≤–æ–µ–≥–æ HLSL Studio
        let studioParams = currentParamNames
            .map(p => `float ${p} = ${params[p] !== undefined ? params[p].toFixed(2) : '1.0'};`)
            .join('\n');
        
        // –ó–∞–º–µ–Ω—è–µ–º x –Ω–∞ UV.x –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —à–µ–π–¥–µ—Ä–µ
        let studioBody = code.replace(/\bx\b/g, 'UV.x');
        studioOutput.innerText = `${studioParams}\n\nfloat res = ${studioBody};\nreturn float4(res, res, res, 1.0);`;
    }

    function updateParamsUI() {
        const existingSliders = Array.from(paramsContainer.querySelectorAll('.param-row span:first-child')).map(s => s.innerText);
        if (JSON.stringify(existingSliders) === JSON.stringify(currentParamNames)) return;

        paramsContainer.innerHTML = '';
        currentParamNames.forEach(p => {
            if (params[p] === undefined) params[p] = 1.0;
            const div = document.createElement('div');
            div.className = 'param-row';
            div.innerHTML = `
                <div class="param-info"><span>${p}</span><span id="v_${p}">${params[p]}</span></div>
                <input type="range" min="-10" max="10" step="0.01" value="${params[p]}" oninput="updateParamValue('${p}', this.value)">
            `;
            paramsContainer.appendChild(div);
        });
    }

    function updateParamValue(name, val) {
        params[name] = parseFloat(val);
        document.getElementById(`v_${name}`).innerText = val;
        updateOutputs(formulaInput.value); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–æ–¥–∞ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ —Å–ª–∞–π–¥–µ—Ä–∞
    }

    function insert(text) {
        const start = formulaInput.selectionStart;
        const end = formulaInput.selectionEnd;
        formulaInput.value = formulaInput.value.substring(0, start) + text + formulaInput.value.substring(end);
        compileFormula();
        formulaInput.focus();
    }

    function loadPreset(f) {
        formulaInput.value = f;
        compileFormula();
    }

    function draw() {
        requestAnimationFrame(draw);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const w = canvas.width, h = canvas.height;
        const cX = w / 2, cY = h / 2;

        // –°–µ—Ç–∫–∞
        ctx.strokeStyle = '#252526';
        ctx.beginPath();
        for(let i = -20; i <= 20; i++) {
            ctx.moveTo(cX + i * viewScale, 0); ctx.lineTo(cX + i * viewScale, h);
            ctx.moveTo(0, cY + i * viewScale); ctx.lineTo(w, cY + i * viewScale);
        }
        ctx.stroke();

        // –û—Å–∏
        ctx.strokeStyle = '#444';
        ctx.beginPath();
        ctx.moveTo(cX, 0); ctx.lineTo(cX, h);
        ctx.moveTo(0, cY); ctx.lineTo(w, cY);
        ctx.stroke();

        if (!compiledFunc) return;

        // –ì—Ä–∞—Ñ–∏–∫
        ctx.strokeStyle = '#4ec9b0';
        ctx.lineWidth = 2.5;
        ctx.beginPath();

        let first = true;
        const mathArgs = [Math.sin, Math.cos, Math.abs, frac, step, smoothstep, lerp, clamp, saturate, Math.pow, Math.PI, 1.0]; // 1.0 –¥–ª—è Time –≤ —Å—Ç–∞—Ç–∏–∫–µ

        for(let px = 0; px < w; px++) {
            const x = (px - cX) / viewScale;
            const pValues = currentParamNames.map(n => params[n]);

            try {
                const y = compiledFunc(x, ...pValues, ...mathArgs);
                const py = cY - y * viewScale;
                
                if (px === 0 || isNaN(py) || Math.abs(py) > 5000) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            } catch(e) {}
        }
        ctx.stroke();
    }

    canvas.onmousemove = (e) => {
        const x = (e.offsetX - canvas.width/2) / viewScale;
        const y = (canvas.height/2 - e.offsetY) / viewScale;
        coordInfo.innerText = `X: ${x.toFixed(2)}, Y: ${y.toFixed(2)}`;
    };

    function copyCode(id) {
        navigator.clipboard.writeText(document.getElementById(id).innerText);
    }

    window.onresize = () => { canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; };
    window.onresize();
    compileFormula();
    draw();
</script>
</body>
</html>