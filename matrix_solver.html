<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Economy Solver Pro</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
    <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #1e1e1e;
            color: #d4d4d4;
            margin: 0;
            height: 100vh;
        }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #333; border: 2px solid #1e1e1e; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        input, select {
            background-color: #252526 !important;
            border: 1px solid #333 !important;
            color: #ccc !important;
            outline: none;
        }
        input:focus { border-color: #007acc !important; }
        [x-cloak] { display: none !important; }

        .matrix-table input {
            width: 80px;
            padding: 4px 8px;
            font-family: 'Consolas', monospace;
            text-align: right;
        }
        .btn-blue { background-color: #007acc; color: white; transition: 0.2s; }
        .btn-blue:hover { background-color: #005a9e; }
        .card { background-color: #252526; border: 1px solid #333; }
        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #888;
        }
        .tab.active {
            color: #4ec9b0;
            font-weight: bold;
            border-bottom-color: #4ec9b0;
        }
        .row-sum-error { background-color: #5a1d1d !important; }

        /* Drawflow styles */
        :root {
            --df-node-bg: #1f2937;
            --df-node-border: #374151;
            --df-node-text: #f3f4f6;
            --df-connection-color: #3b82f6;
            --df-connection-width: 3px;
        }
        #leontiefDrawflow {
            background-size: 25px 25px;
            background-image: radial-gradient(#374151 1px, transparent 1px);
            background-color: #111827;
            height: 100%; width: 100%;
        }
        .drawflow .drawflow-node {
            background: var(--df-node-bg);
            border: 2px solid var(--df-node-border);
            border-radius: 8px;
            min-width: 180px;
            color: var(--df-node-text);
            padding: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }
        .drawflow .drawflow-node.selected {
            background: var(--df-node-bg) !important;
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6);
        }
        .drawflow-node-header {
             padding: 6px 10px;
             border-bottom: 1px solid #374151;
             font-weight: bold;
             font-size: 0.8rem;
             color: #93c5fd;
        }
        .drawflow-node-content {
             padding: 10px;
             font-size: 0.75rem;
             line-height: 1.5;
        }

    </style>
</head>
<body x-data="matrixApp" x-init="init()">

    <div class="h-screen flex flex-col overflow-hidden">
        <header class="h-12 border-b border-[#333] bg-[#2d2d2d] flex justify-between items-center px-6 shrink-0">
            <div class="flex items-center gap-3">
                <span style="color: #4ec9b0; font-weight: bold;">ðŸ§® Matrix Optimizer</span>
                <span class="text-[10px] bg-[#3e3e42] px-2 py-0.5 rounded text-[#888]">PRO VERSION</span>
            </div>
            <div class="flex gap-2">
                <button @click="solve()" class="btn-blue px-6 py-1 rounded text-sm font-bold shadow-lg">RUN CALCULATIONS</button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <main class="flex-1 flex flex-col overflow-auto bg-[#1e1e1e]">
                <div class="flex border-b border-[#333] shrink-0">
                    <div @click="activeTab = 'simplex'" :class="{'active': activeTab === 'simplex'}" class="tab">Simplex Optimizer</div>
                    <div @click="activeTab = 'leontief'" :class="{'active': activeTab === 'leontief'}" class="tab">Leontief I-O Analysis</div>
                    <div @click="activeTab = 'markov'" :class="{'active': activeTab === 'markov'}" class="tab">Markov Chains</div>
                </div>

                <div x-show="activeTab === 'simplex'" class="flex flex-1 overflow-hidden" x-cloak>
                    <div x-data="simplexEngine" class="w-full flex">
                        <aside class="w-72 bg-[#252526] border-r border-[#333] p-4 overflow-y-auto shrink-0">
                            <div class="mb-6">
                                <div class="flex justify-between items-center mb-2"><h3 class="text-[11px] uppercase font-bold text-[#6c6c6c]">Resources</h3><button @click="addResource()" class="text-[#4ec9b0] hover:text-white text-lg">+</button></div>
                                <div class="space-y-2"><template x-for="(res, idx) in resources" :key="idx"><div class="p-2 card rounded"><input type="text" x-model="res.name" class="w-full text-xs font-bold mb-1 bg-transparent border-none"><div class="flex justify-between items-center"><span class="text-[10px] text-[#6c6c6c]">Limit:</span><input type="number" x-model.number="res.limit" class="w-20 text-[10px] p-1 rounded"></div></div></template></div>
                            </div>
                            <div class="mb-6">
                                <div class="flex justify-between items-center mb-2"><h3 class="text-[11px] uppercase font-bold text-[#6c6c6c]">Products</h3><button @click="addProduct()" class="text-[#4ec9b0] hover:text-white text-lg">+</button></div>
                                <div class="space-y-2"><template x-for="(prod, idx) in products" :key="idx"><div class="p-2 card rounded"><input type="text" x-model="prod.name" class="w-full text-xs font-bold mb-1 bg-transparent border-none"><div class="flex justify-between items-center"><span class="text-[10px] text-[#6c6c6c]">Profit:</span><input type="number" x-model.number="prod.profit" class="w-20 text-[10px] p-1 rounded"></div></div></template></div>
                            </div>
                        </aside>
                        <div class="flex-1 overflow-auto p-8">
                             <h2 class="text-sm font-bold mb-6 text-[#4ec9b0]">Production Coefficients (Resource per Product)</h2>
                            <div class="inline-block card rounded-lg overflow-hidden mb-10">
                                <table class="matrix-table text-xs">
                                    <thead><tr class="bg-[#2d2d2d]"><th class="p-3 border-b border-[#333]"></th><template x-for="p in products"><th class="p-3 border-b border-[#333] text-[#4ec9b0] font-normal" x-text="p.name"></th></template></tr></thead>
                                    <tbody><template x-for="(res, rIdx) in resources" :key="rIdx"><tr><td class="p-3 bg-[#2d2d2d] border-r border-[#333] font-bold" x-text="res.name"></td><template x-for="(prod, pIdx) in products" :key="pIdx"><td class="p-1 border-b border-r border-[#333]"><input type="number" step="0.1" x-model.number="matrixA[rIdx][pIdx]"></td></template></tr></template></tbody>
                                </table>
                            </div>
                            <template x-if="results"><div class="grid grid-cols-2 gap-8"><div class="card p-6 rounded-lg"><h3 class="text-[#4ec9b0] font-bold text-xs uppercase mb-4">Optimal Plan</h3><div class="space-y-2"><template x-for="(val, key) in results.solution" :key="key"><div x-show="typeof val === 'number' && key !== 'result'" class="flex justify-between border-b border-[#333] py-2"><span class="text-[#888]" x-text="key"></span><span class="text-white font-bold font-mono" x-text="val.toFixed(2)"></span></div></template></div><div class="mt-6 flex justify-between items-center"><span class="text-[10px] text-[#6c6c6c] uppercase">Expected Profit:</span><span class="text-2xl font-black text-white" x-text="results.totalProfit.toFixed(0)"></span></div></div><div class="card p-6 rounded-lg"><h3 class="text-[#ce9178] font-bold text-xs uppercase mb-4">Resource Utilization</h3><div class="space-y-4"><template x-for="(data, name) in results.usage" :key="name"><div><div class="flex justify-between text-[10px] mb-1"><span x-text="name"></span><span x-text="data.used.toFixed(1) + '/' + data.limit"></span></div><div class="w-full h-1.5 bg-[#1e1e1e] rounded-full overflow-hidden"><div class="h-full" :style="`width: ${Math.min(data.percent, 100)}%`" :class="data.percent > 90 ? 'bg-orange-600' : 'bg-[#007acc]'"></div></div></div></template></div></div></div></template>
                        </div>
                    </div>
                </div>

                <div x-show="activeTab === 'leontief'" class="flex flex-1 overflow-hidden" x-cloak>
                    <div x-data="leontiefEngine" @vue:mounted="initEditor()" class="w-full flex">
                        <aside class="w-96 bg-[#252526] border-r border-[#333] p-4 flex flex-col">
                             <h2 class="text-sm font-bold mb-4 text-[#4ec9b0] flex-shrink-0">Technology Matrix & Demand</h2>
                             <div class="mb-4 flex-shrink-0">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-[11px] uppercase font-bold text-[#6c6c6c]">Economy Items</h3>
                                    <button @click="addItem()" class="text-[#4ec9b0] hover:text-white text-lg">+</button>
                                </div>
                                <div class="space-y-2 max-h-48 overflow-y-auto pr-2">
                                    <template x-for="(item, idx) in items" :key="idx"><div class="p-2 card rounded flex justify-between items-center"><input type="text" x-model="item.name" class="w-full text-xs font-bold bg-transparent border-none"><div class="flex items-center"><span class="text-[10px] text-[#6c6c6c] mr-2">Demand:</span><input type="number" x-model.number="item.demand" class="w-20 text-[10px] p-1 rounded"></div></div></template>
                                </div>
                            </div>
                            <div class="flex-grow overflow-auto pr-2">
                                <p class="text-xs text-[#888] mb-2 max-w-xl flex-shrink-0">Matrix A: How many units of 'Row' are needed for 1 unit of 'Col'.</p>
                                <div class="inline-block card rounded-lg overflow-hidden">
                                    <table class="matrix-table text-xs">
                                        <thead><tr class="bg-[#2d2d2d]"><th class="p-2 border-b border-[#333] sticky top-0 left-0 z-10 bg-[#2d2d2d] text-center">â†“/â†’</th><template x-for="item in items"><th class="p-2 border-b border-[#333] text-[#4ec9b0] font-normal sticky top-0 bg-[#2d2d2d]" x-text="item.name"></th></template></tr></thead>
                                        <tbody><template x-for="(rowItem, rIdx) in items" :key="rIdx"><tr><td class="p-2 bg-[#2d2d2d] border-r border-[#333] font-bold sticky left-0" x-text="rowItem.name"></td><template x-for="(colItem, cIdx) in items" :key="cIdx"><td class="p-1 border-b border-r border-[#333]"><input type="number" step="0.1" x-model.number="techMatrix[rIdx][cIdx]"></td></template></tr></template></tbody>
                                    </table>
                                </div>
                            </div>
                        </aside>
                         <div class="flex-1 relative">
                            <div id="leontiefDrawflow" @drop.prevent @dragover.prevent></div>
                            <template x-if="totalProduction">
                                <div class="absolute top-4 left-4 card p-4 rounded-lg bg-opacity-80 backdrop-blur-sm max-w-xs max-h-[90%] overflow-y-auto">
                                     <h3 class="text-[#ce9178] font-bold text-xs uppercase mb-2">Total Production Required (X)</h3>
                                     <div class="space-y-1">
                                         <template x-for="(item, idx) in items" :key="idx"><div class="flex justify-between border-b border-[#333] py-1 text-xs"><span class="text-[#888]" x-text="item.name"></span><span class="text-white font-mono" x-text="totalProduction[idx] ? totalProduction[idx].toFixed(2) : '0.00'"></span></div></template>
                                     </div>
                                 </div>
                            </template>
                         </div>
                    </div>
                </div>
                
                <div x-show="activeTab === 'markov'" class="flex flex-1 overflow-hidden" x-cloak>
                   <div x-data="markovEngine" class="w-full flex">
                        <aside class="w-72 bg-[#252526] border-r border-[#333] p-4 overflow-y-auto shrink-0">
                             <div class="mb-6">
                                <div class="flex justify-between items-center mb-2"><h3 class="text-[11px] uppercase font-bold text-[#6c6c6c]">System States</h3><button @click="addState()" class="text-[#4ec9b0] hover:text-white text-lg">+</button></div>
                                <div class="space-y-2"><template x-for="(state, idx) in states" :key="idx"><div class="p-2 card rounded"><input type="text" x-model="state.name" class="w-full text-xs font-bold bg-transparent border-none"></div></template></div>
                            </div>
                            <div class="mb-6 card p-3">
                                <h3 class="text-[11px] uppercase font-bold text-[#6c6c6c] mb-2">Initial State Vector</h3>
                                <template x-for="(state, idx) in states" :key="idx">
                                    <div class="flex justify-between items-center mb-1"><span class="text-xs text-[#888]" x-text="state.name"></span><input type="number" step="0.01" min="0" max="1" x-model.number="initialVector[idx]" class="w-20 text-[10px] p-1 rounded"></div>
                                </template>
                            </div>
                             <div class="mb-6 card p-3">
                                <h3 class="text-[11px] uppercase font-bold text-[#6c6c6c] mb-2">Simulation Steps</h3>
                                <input type="number" min="1" x-model.number="steps" class="w-full text-sm p-1 rounded">
                            </div>
                        </aside>
                         <div class="flex-1 overflow-auto p-8">
                            <h2 class="text-sm font-bold mb-6 text-[#4ec9b0]">Transition Probability Matrix (P)</h2>
                            <p class="text-xs text-[#888] mb-4 max-w-xl">Each cell (Row, Col) is the probability of moving FROM 'Row' state TO 'Col' state. <strong class="text-[#ce9178]">Each row's sum must equal 1.</strong></p>
                            <div class="inline-block card rounded-lg overflow-hidden mb-10">
                                <table class="matrix-table text-xs">
                                    <thead><tr class="bg-[#2d2d2d]"><th class="p-3 border-b border-[#333] sticky left-0 z-10 bg-[#2d2d2d]">â†“ FROM / TO â†’</th><template x-for="state in states"><th class="p-3 border-b border-[#333] text-[#4ec9b0] font-normal" x-text="state.name"></th></template></tr></thead>
                                    <tbody><template x-for="(rowState, rIdx) in states" :key="rIdx"><tr><td class="p-3 bg-[#2d2d2d] border-r border-[#333] font-bold" x-text="rowState.name"></td><template x-for="(colState, cIdx) in states" :key="cIdx"><td class="p-1 border-b border-r border-[#333]"><input type="number" step="0.01" min="0" max="1" x-model.number="transitionMatrix[rIdx][cIdx]" :class="{'row-sum-error': rowSums[rIdx] !== 1}"></td></template></tr></template></tbody>
                                </table>
                            </div>
                            <template x-if="results.after_n_steps"><div class="grid grid-cols-2 gap-8"><div class="card p-6 rounded-lg"><h3 class="text-[#ce9178] font-bold text-xs uppercase mb-4" x-text="`Distribution after ${steps} Steps`"></h3><div class="space-y-2"><template x-for="(state, idx) in states" :key="idx"><div class="flex justify-between border-b border-[#333] py-2"><span class="text-[#888]" x-text="state.name"></span><div class="flex items-center gap-4"><span class="text-sm text-gray-400" x-text="`( ${(initialVector[idx]*100).toFixed(1)}% -> ${(results.after_n_steps[idx]*100).toFixed(1)}% )`"></span><span class="text-white font-bold font-mono text-lg" x-text="(results.after_n_steps[idx]*100).toFixed(2) + '%'"></span></div></div></template></div></div><template x-if="results.steady_state"><div class="card p-6 rounded-lg"><h3 class="text-[#9cdcfe] font-bold text-xs uppercase mb-4">Steady-State Distribution (Long-term)</h3><div class="space-y-2"><template x-for="(state, idx) in states" :key="idx"><div class="flex justify-between border-b border-[#333] py-2"><span class="text-[#888]" x-text="state.name"></span><span class="text-white font-bold font-mono text-lg" x-text="(results.steady_state[idx]*100).toFixed(2) + '%'"></span></div></template></div></div></template></div></template>
                         </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        // EMBEDDED javascript-lp-solver
        var solver=function(){"use strict";class t{constructor(t,e,s,i){this.feasible=s,this.evaluation=e,this.bounded=i,this._tableau=t,this.solutionSet={}}generateSolutionSet(){const t={},e=this._tableau,s=e.varIndexByRow,i=e.variablesPerIndex,o=e.matrix,a=e.width,n=e.rhsColumn,l=e.height-1,h=Math.round(1/e.precision);for(let e=1;e<=l;e+=1){const l=s[e],r=i[l];if(void 0===r||!0===r.isSlack)continue;const c=o[e*a+n];t[r.id]=Math.round((Number.EPSILON+c)*h)/h}return t}}class e extends t{constructor(t,e,s,i,o){super(t,e,s,i),this.iter=o}}class s{constructor(t=64){this.heap=new Array(t),this.size=0,this.seqCounter=0,this.pool=new Array(64),this.poolSize=0}allocEntry(t,e){if(this.poolSize>0){const s=this.pool[--this.poolSize];return s.branch=t,s.seq=e,s}return{branch:t,seq:e}}freeEntry(t){this.poolSize<256&&(this.pool[this.poolSize++]=t)}get length(){return this.size}isEmpty(){return 0===this.size}clear(){this.size=0,this.seqCounter=0}isBefore(t,e){return t.branch.relaxedEvaluation!==e.branch.relaxedEvaluation?t.branch.relaxedEvaluation<e.branch.relaxedEvaluation:t.seq>e.seq}push(t){const e=this.heap;let s=this.size;if(this.size++,s>=e.length&&(e.length=2*e.length),t=this.allocEntry(t,this.seqCounter++),s>0){let o=(s-1)>>1;for(;s>0&&this.isBefore(t,e[o]);)e[s]=e[o],s=o,o=(s-1)>>1}e[s]=t}pop(){if(0===this.size)return;const t=this.heap,e=t[0],i=e.branch;if(this.size--,this.freeEntry(e),0===this.size)return i;const o=t[this.size];let a=0;const n=this.size>>1;for(;a<n;){let e=(a<<1)+1,s=t[e];const i=e+1;if(i<this.size&&this.isBefore(t[i],s)&&(e=i,s=t[i]),!this.isBefore(s,o))break;t[a]=s,a=e}return t[a]=o,i}peek(){return this.size>0?this.heap[0].branch:void 0}}function i(t,e,s){return{type:t,varIndex:e,value:s}}function o(t,e){return{relaxedEvaluation:t,cuts:e}}function a(){const t=(t,e)=>{var s;t.restore(),t.addCutConstraints(e),t.simplex(),(null===(s=t.model)||void 0===s?void 0:s.useMIRCuts)&&(()=>{let e=.9*t.computeFractionalVolume(!0);for(;t.applyMIRCuts(),t.simplex(),t.computeFractionalVolume(!0)<e;)e=.9*t.computeFractionalVolume(!0)})()},n=(n)=>{var l,h,r,c,d;const u=new s;let p=0;const m=null!==(h=(null===(l=n.model)||void 0===l?void 0:l.tolerance)&&void 0!==h?h:0);let v=!0,g=1e99;(null===(r=n.model)||void 0===r?void 0:r.timeout)&&(g=Date.now()+n.model.timeout);let b=-1/0,f=null;const w=[],y=n.optionalObjectives,S=y.length;for(let t=0;t<S;t+=1)w.push(1/0);const I=o(-1/0,[]);letx;for(u.push(I);!u.isEmpty()&&!0===v&&Date.now()<g;){if(null===(c=n.model)||void 0===c?void 0:c.isMinimization?x=n.bestPossibleEval*(1+m):x=n.bestPossibleEval*(1-m),m>0&&b<x&&(v=!1),I=u.pop(),I.relaxedEvaluation>=b)continue;const l=I.cuts;if(t(n,l),p++,!1===n.feasible)continue;const s=n.evaluation;if(s>b)continue;if(s===b){let t=!0;for(let e=0;e<S;e+=1){const s=y[e].reducedCosts[0],i=w[e];if(s>i)break;if(s<i){t=!1;break}}if(t)continue}if(!0===n.isIntegral()){if(n.__isIntegral=!0,1===p)return void(n.branchAndCutIterations=p);f=I,b=s;for(let t=0;t<S;t+=1)w[t]=y[t].reducedCosts[0];if(null===(d=n.model)||void 0===d?void 0:d.keep_solutions){const t=n.model.tableau.getSolution(),e=t.generateSolutionSet();e.result=t.evaluation,n.model.solutions||(n.model.solutions=[]),n.model.solutions.push(e)}}else{1===p&&n.save();const t=n.getMostFractionalVar(),e=t.index,s=t.value,l=[],h=[];const r=I.cuts.length;for(let t=0;t<r;t+=1){const s=I.cuts[t];s.varIndex===e?"min"===s.type?l.push(s):h.push(s):(h.push(s),l.push(s))}const c=i("min",e,Math.ceil(s));h.push(c);const d=i("max",e,Math.floor(s));l.push(d),u.push(o(s,h)),u.push(o(s,l))}}null!==f&&t(n,f.cuts),n.branchAndCutIterations=p};return{applyCuts:t,branchAndCut:n}}
        // ... ALL OF THE javascript-lp-solver CODE ...
        return e}}());
    </script>
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('matrixApp', () => ({
                activeTab: 'simplex',
                init() {
                    console.log("matrixApp init() called.");
                    if(typeof solver == 'undefined') {
                        alert("Warning: javascript-lp-solver did not load correctly. The Simplex Optimizer tab may not work. Please check your network connection or ad-blocker.");
                    }
                },
                solve() {
                    console.log("matrixApp.solve() called. Active tab:", this.activeTab);
                    const eventName = { simplex: 'solve-simplex', leontief: 'solve-leontief', markov: 'solve-markov' }[this.activeTab];
                    if(eventName) {
                        console.log(`matrixApp: Dispatching event: ${eventName}`);
                        document.dispatchEvent(new CustomEvent(eventName, { bubbles: true }));
                    } else {
                        console.warn("matrixApp: No event name for active tab:", this.activeTab);
                    }
                }
            }));
            
             Alpine.data('simplexEngine', () => ({
                resources: [{name: 'Iron', limit: 500}, {name: 'Wood', limit: 300}],
                products: [{name: 'Sword', profit: 50}, {name: 'Shield', profit: 40}],
                matrixA: [[2, 1], [1, 3]],
                results: null,
                init() { 
                    console.log("simplexEngine init() called.");
                    document.addEventListener('solve-simplex', () => {
                        console.log("simplexEngine: 'solve-simplex' event received.");
                        this.solve();
                    }); 
                },
                addResource() { this.resources.push({name: 'New Resource', limit: 100}); this.matrixA.push(new Array(this.products.length).fill(0)); },
                addProduct() { this.products.push({name: 'New Product', profit: 10}); this.matrixA.forEach(row => row.push(0)); },
                solve() {
                    console.log("simplexEngine solve() called.");
                    if (!window.solver) return alert("solver.js not loaded.");
                    try {
                        const model = { optimize: "profit", opType: "max", constraints: {}, variables: {} };
                        this.resources.forEach(res => { model.constraints[res.name] = { max: res.limit || 0 }; });
                        this.products.forEach((prod, pIdx) => {
                            const v = { profit: prod.profit || 0 };
                            this.resources.forEach((res, rIdx) => { v[res.name] = this.matrixA[rIdx][pIdx] || 0; });
                            model.variables[prod.name] = v;
                        });
                        const solution = solver.Solve(model);
                        if (!solution.feasible) {
                            console.log("simplexEngine solve() finished with infeasible solution.");
                            return alert("Infeasible solution.");
                        }
                        const usage = {};
                        this.resources.forEach((res, rIdx) => {
                            let total = 0;
                            this.products.forEach((p, pIdx) => { total += (solution[p.name] || 0) * (this.matrixA[rIdx][pIdx] || 0); });
                            usage[res.name] = { used: total, limit: res.limit, percent: (total / res.limit) * 100 };
                        });
                        this.results = { solution, totalProfit: solution.result || 0, usage };
                        console.log("simplexEngine solve() finished successfully.");
                    } catch (e) { console.error(e); alert("Math Error: " + e.message); }
                }
            }));

            Alpine.data('leontiefEngine', () => ({
                items: [{name: 'Iron Ore', demand: 0}, {name: 'Wood', demand: 0}, {name: 'Iron Sword', demand: 10}],
                techMatrix: [[0, 0, 5], [0, 0, 2], [0, 0, 0]],
                totalProduction: null,
                editor: null,
                init() { 
                    console.log("leontiefEngine init() called.");
                    const container = document.getElementById('leontiefDrawflow');
                    this.editor = new Drawflow(container);
                    this.editor.start();

                    document.addEventListener('solve-leontief', () => {
                        console.log("leontiefEngine: 'solve-leontief' event received.");
                        this.solve();
                    }); 
                },
                addItem() { this.items.push({name: 'New Item', demand: 0}); this.techMatrix.forEach(row => row.push(0)); this.techMatrix.push(new Array(this.items.length).fill(0)); },
                visualizeGraph() {
                    console.log("leontiefEngine visualizeGraph() called.");
                    this.editor.clear();
                    const nodeWidth = 180;
                    const nodes = {};

                    this.items.forEach((item, i) => {
                        const html = `<div class="drawflow-node-header">${item.name}</div><div class="drawflow-node-content">Demand: ${item.demand}<br>Total: ${this.totalProduction[i].toFixed(2)}</div>`;
                        nodes[i] = this.editor.addNode('item', 1, 1, 50 + (i * (nodeWidth + 50)), 150, 'item-node', { name: item.name }, html);
                    });

                    this.techMatrix.forEach((row, rIdx) => {
                        row.forEach((val, cIdx) => {
                            if (val > 0) {
                                this.editor.addConnection(nodes[rIdx], nodes[cIdx], 'output_1', 'input_1');
                            }
                        });
                    });

                    console.log("leontiefEngine visualizeGraph() finished.");
                },
                solve() {
                    console.log("leontiefEngine solve() called.");
                    if (!window.math) return alert("math.js not loaded.");
                    try {
                        const A = math.matrix(this.techMatrix);
                        const y = math.matrix(this.items.map(i => i.demand));
                        const n = this.items.length; if (n === 0) return;
                        const I = math.identity(n);
                        const I_minus_A = math.subtract(I, A);
                        if (math.abs(math.det(I_minus_A)) < 1e-9) return alert("Matrix is singular (non-productive economy).");
                        const leontiefInverse = math.inv(I_minus_A);
                        this.totalProduction = math.multiply(leontiefInverse, y).toArray();
                        this.$nextTick(() => this.visualizeGraph());
                        console.log("leontiefEngine solve() finished successfully.");
                    } catch(e) { console.error(e); alert("Math Error: " + e.message); }
                }
            }));

            Alpine.data('markovEngine', () => ({
                states: [{name: 'New Player'}, {name: 'Engaged'}, {name: 'Churned'}],
                transitionMatrix: [[0.1, 0.8, 0.1], [0.05, 0.9, 0.05], [0, 0, 1]],
                initialVector: [1, 0, 0],
                steps: 10,
                results: {},
                get rowSums() { return this.transitionMatrix.map(row => math.round(math.sum(row), 3)); },
                init() { 
                    console.log("markovEngine init() called.");
                    document.addEventListener('solve-markov', () => {
                        console.log("markovEngine: 'solve-markov' event received.");
                        this.solve();
                    }); 
                },
                addState() {
                    this.states.push({name: 'New State'}); this.initialVector.push(0); this.transitionMatrix.forEach(row => row.push(0)); this.transitionMatrix.push(new Array(this.states.length).fill(0));
                },
                solve() {
                    console.log("markovEngine solve() called.");
                    if (!window.math) return alert("math.js not loaded.");
                    try {
                        if (math.abs(math.sum(this.initialVector) - 1) > 1e-9) return alert("Sum of Initial State Vector must be 1.");
                        if (this.rowSums.some(s => math.abs(s - 1) > 1e-9)) return alert("The sum of each row in the transition matrix must be 1.");
                        
                        const P = math.matrix(this.transitionMatrix);
                        const s0 = math.matrix(this.initialVector);
                        const s_n = math.multiply(s0, math.pow(P, this.steps)).toArray();

                        const eigs = math.eigs(math.transpose(P));
                        const eigenvalues = eigs.values.toArray();
                        const steadyIdx = eigenvalues.findIndex(v => math.abs(math.subtract(v, 1)) < 1e-9);

                        if (steadyIdx === -1) {
                             this.results = { after_n_steps: s_n, steady_state: null };
                             throw new Error("No steady state found. The system may not be regular or ergodic.");
                        }
                        
                        let steadyVectorRaw = math.column(eigs.vectors, steadyIdx);
                        let steadyVector = math.flatten(steadyVectorRaw.toArray());
                        const steadySum = math.sum(steadyVector);
                        steadyVector = math.multiply(steadyVector, 1 / steadySum).map(v => math.abs(v));

                        this.results = {
                            after_n_steps: s_n,
                            steady_state: steadyVector
                        };
                        console.log("markovEngine solve() finished successfully.");
                    } catch(e) { console.error(e); alert("Markov Calc Error: " + e.message); }
                }
            }));
        });
    </script>
</body>
</html>
