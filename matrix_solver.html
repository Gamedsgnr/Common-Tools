<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Economy Solver Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/javascript-lp-solver@0.5.0/browser/solver.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
    <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #1e1e1e;
            color: #d4d4d4;
            margin: 0;
            height: 100vh;
        }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #333; border: 2px solid #1e1e1e; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        input, select {
            background-color: #252526 !important;
            border: 1px solid #333 !important;
            color: #ccc !important;
            outline: none;
        }
        input:focus { border-color: #007acc !important; }
        [x-cloak] { display: none !important; }

        .matrix-table input {
            width: 80px;
            padding: 4px 8px;
            font-family: 'Consolas', monospace;
            text-align: right;
        }
        .btn-blue { background-color: #007acc; color: white; transition: 0.2s; }
        .btn-blue:hover { background-color: #005a9e; }
        .card { background-color: #252526; border: 1px solid #333; }
        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #888;
        }
        .tab.active {
            color: #4ec9b0;
            font-weight: bold;
            border-bottom-color: #4ec9b0;
        }

        /* Drawflow styles */
        :root {
            --df-node-bg: #1f2937;
            --df-node-border: #374151;
            --df-node-text: #f3f4f6;
            --df-connection-color: #3b82f6;
            --df-connection-width: 3px;
        }
        #leontiefDrawflow {
            background-size: 25px 25px;
            background-image: radial-gradient(#374151 1px, transparent 1px);
            background-color: #111827;
            height: 100%; width: 100%;
        }
        .drawflow .drawflow-node {
            background: var(--df-node-bg);
            border: 2px solid var(--df-node-border);
            border-radius: 8px;
            min-width: 150px;
            color: var(--df-node-text);
            padding: 0;
        }
        .drawflow .drawflow-node.selected {
            background: var(--df-node-bg) !important;
            border-color: #3b82f6;
        }
        .drawflow-node-header {
             padding: 4px;
             border-bottom: 1px solid #374151;
             font-weight: bold;
             font-size: 0.75rem;
        }
        .drawflow-node-content {
             padding: 8px;
             font-size: 0.7rem;
        }

    </style>
</head>
<body x-data="matrixApp" x-init="init()">

    <div class="h-screen flex flex-col overflow-hidden">
        <header class="h-12 border-b border-[#333] bg-[#2d2d2d] flex justify-between items-center px-6 shrink-0">
            <div class="flex items-center gap-3">
                <span style="color: #4ec9b0; font-weight: bold;">ðŸ§® Matrix Optimizer</span>
                <span class="text-[10px] bg-[#3e3e42] px-2 py-0.5 rounded text-[#888]">PRO VERSION</span>
            </div>
            <div class="flex gap-2">
                <button @click="solve()" class="btn-blue px-6 py-1 rounded text-sm font-bold shadow-lg">RUN CALCULATIONS</button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <main class="flex-1 flex flex-col overflow-auto bg-[#1e1e1e]">
                <div class="flex border-b border-[#333] shrink-0">
                    <div @click="activeTab = 'simplex'" :class="{'active': activeTab === 'simplex'}" class="tab">Simplex Optimizer</div>
                    <div @click="activeTab = 'leontief'" :class="{'active': activeTab === 'leontief'}" class="tab">Leontief I-O Analysis</div>
                    <div @click="activeTab = 'markov'" :class="{'active': activeTab === 'markov'}" class="tab">Markov Chains</div>
                </div>

                <!-- Simplex View -->
                <div x-show="activeTab === 'simplex'" class="flex flex-1 overflow-hidden" x-cloak>
                    <!-- ... Simplex content remains the same ... -->
                </div>

                <!-- Leontief View -->
                 <div x-show="activeTab === 'leontief'" class="flex flex-1 overflow-hidden" x-cloak>
                    <div x-data="leontiefEngine" class="w-full flex">
                        <aside class="w-96 bg-[#252526] border-r border-[#333] p-4 flex flex-col">
                             <h2 class="text-sm font-bold mb-4 text-[#4ec9b0] flex-shrink-0">Technology Matrix & Demand</h2>
                             <div class="mb-4 flex-shrink-0">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-[11px] uppercase font-bold text-[#6c6c6c]">Economy Items</h3>
                                    <button @click="addItem()" class="text-[#4ec9b0] hover:text-white text-lg">+</button>
                                </div>
                                <div class="space-y-2 max-h-48 overflow-y-auto pr-2">
                                    <template x-for="(item, idx) in items" :key="idx"><div class="p-2 card rounded flex justify-between items-center"><input type="text" x-model="item.name" class="w-full text-xs font-bold bg-transparent border-none"><div class="flex items-center"><span class="text-[10px] text-[#6c6c6c] mr-2">Demand:</span><input type="number" x-model.number="item.demand" class="w-20 text-[10px] p-1 rounded"></div></div></template>
                                </div>
                            </div>
                            <div class="flex-grow overflow-auto pr-2">
                                <p class="text-xs text-[#888] mb-2 max-w-xl flex-shrink-0">Matrix A: How many units of 'Row' are needed for 1 unit of 'Col'.</p>
                                <div class="inline-block card rounded-lg overflow-hidden">
                                    <table class="matrix-table text-xs">
                                        <thead><tr class="bg-[#2d2d2d]"><th class="p-2 border-b border-[#333] sticky top-0 left-0 z-10 bg-[#2d2d2d] text-center">â†“/â†’</th><template x-for="item in items"><th class="p-2 border-b border-[#333] text-[#4ec9b0] font-normal sticky top-0 bg-[#2d2d2d]" x-text="item.name"></th></template></tr></thead>
                                        <tbody><template x-for="(rowItem, rIdx) in items" :key="rIdx"><tr><td class="p-2 bg-[#2d2d2d] border-r border-[#333] font-bold sticky left-0" x-text="rowItem.name"></td><template x-for="(colItem, cIdx) in items" :key="cIdx"><td class="p-1 border-b border-r border-[#333]"><input type="number" step="0.1" x-model.number="techMatrix[rIdx][cIdx]"></td></template></tr></template></tbody>
                                    </table>
                                </div>
                            </div>
                        </aside>
                         <div class="flex-1 relative">
                            <div id="leontiefDrawflow" @drop.prevent @dragover.prevent></div>
                            <template x-if="totalProduction">
                                <div class="absolute top-4 left-4 card p-4 rounded-lg bg-opacity-80 backdrop-blur-sm max-w-xs max-h-[90%] overflow-y-auto">
                                     <h3 class="text-[#ce9178] font-bold text-xs uppercase mb-2">Total Production Required (X)</h3>
                                     <div class="space-y-1">
                                         <template x-for="(item, idx) in items" :key="idx"><div class="flex justify-between border-b border-[#333] py-1 text-xs"><span class="text-[#888]" x-text="item.name"></span><span class="text-white font-mono" x-text="totalProduction[idx] ? totalProduction[idx].toFixed(2) : '0.00'"></span></div></template>
                                     </div>
                                 </div>
                            </template>
                         </div>
                    </div>
                </div>
                
                <!-- Markov View -->
                <div x-show="activeTab === 'markov'" class="flex flex-1 overflow-hidden" x-cloak>
                   <!-- ... Markov content remains the same ... -->
                </div>

            </main>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('matrixApp', () => ({
                activeTab: 'simplex',
                init() {
                    console.log("matrixApp init() called.");
                    if(typeof solver == 'undefined') {
                        alert("Warning: javascript-lp-solver did not load correctly. The Simplex Optimizer tab may not work. Please check your network connection or ad-blocker.");
                    }
                },
                solve() {
                    console.log("matrixApp.solve() called. Active tab:", this.activeTab);
                    const eventName = { simplex: 'solve-simplex', leontief: 'solve-leontief', markov: 'solve-markov' }[this.activeTab];
                    if(eventName) {
                        console.log(`matrixApp: Dispatching event: ${eventName}`);
                        document.dispatchEvent(new CustomEvent(eventName, { bubbles: true }));
                    } else {
                        console.warn("matrixApp: No event name for active tab:", this.activeTab);
                    }
                }
            }));
            
             Alpine.data('simplexEngine', () => ({/* ... same as before ... */}));

            Alpine.data('leontiefEngine', () => ({
                items: [{name: 'Iron Ore', demand: 0}, {name: 'Wood', demand: 0}, {name: 'Iron Sword', demand: 10}],
                techMatrix: [[0, 0, 5], [0, 0, 2], [0, 0, 0]],
                totalProduction: null,
                editor: null,
                init() { 
                    console.log("leontiefEngine init() called.");
                    const container = document.getElementById('leontiefDrawflow');
                    this.editor = new Drawflow(container);
                    this.editor.start();

                    document.addEventListener('solve-leontief', () => {
                        console.log("leontiefEngine: 'solve-leontief' event received.");
                        this.solve();
                    }); 
                },
                addItem() { this.items.push({name: 'New Item', demand: 0}); this.techMatrix.forEach(row => row.push(0)); this.techMatrix.push(new Array(this.items.length).fill(0)); },
                visualizeGraph() {
                    console.log("leontiefEngine visualizeGraph() called.");
                    this.editor.clear();
                    const nodeWidth = 160;
                    const nodeHeight = 80;
                    const nodes = {};

                    this.items.forEach((item, i) => {
                        const html = `<div class="drawflow-node-header">${item.name}</div><div class="drawflow-node-content">Demand: ${item.demand}<br>Total: ${this.totalProduction[i].toFixed(2)}</div>`;
                        nodes[i] = this.editor.addNode('item', 1, 1, 50 + (i * (nodeWidth + 40)), 150, 'item-node', { name: item.name }, html);
                    });

                    this.techMatrix.forEach((row, rIdx) => {
                        row.forEach((val, cIdx) => {
                            if (val > 0) {
                                // rIdx is input for cIdx
                                this.editor.addConnection(nodes[rIdx], nodes[cIdx], 'output_1', 'input_1');
                            }
                        });
                    });

                    console.log("leontiefEngine visualizeGraph() finished.");
                },
                solve() {
                    console.log("leontiefEngine solve() called.");
                    if (!window.math) return alert("math.js not loaded.");
                    try {
                        const A = math.matrix(this.techMatrix);
                        const y = math.matrix(this.items.map(i => i.demand));
                        const n = this.items.length; if (n === 0) return;
                        const I = math.identity(n);
                        const I_minus_A = math.subtract(I, A);
                        if (math.abs(math.det(I_minus_A)) < 1e-9) return alert("Matrix is singular (non-productive economy).");
                        const leontiefInverse = math.inv(I_minus_A);
                        this.totalProduction = math.multiply(leontiefInverse, y).toArray();
                        this.$nextTick(() => this.visualizeGraph());
                        console.log("leontiefEngine solve() finished successfully.");
                    } catch(e) { console.error(e); alert("Math Error: " + e.message); }
                }
            }));

            Alpine.data('markovEngine', () => ({
                states: [{name: 'New Player'}, {name: 'Engaged'}, {name: 'Churned'}],
                transitionMatrix: [[0.1, 0.8, 0.1], [0.05, 0.9, 0.05], [0, 0, 1]],
                initialVector: [1, 0, 0],
                steps: 10,
                results: {},
                get rowSums() { return this.transitionMatrix.map(row => math.round(math.sum(row), 3)); },
                init() { 
                    console.log("markovEngine init() called.");
                    document.addEventListener('solve-markov', () => {
                        console.log("markovEngine: 'solve-markov' event received.");
                        this.solve();
                    }); 
                },
                addState() {
                    this.states.push({name: 'New State'}); this.initialVector.push(0); this.transitionMatrix.forEach(row => row.push(0)); this.transitionMatrix.push(new Array(this.states.length).fill(0));
                },
                solve() {
                    console.log("markovEngine solve() called.");
                    if (!window.math) return alert("math.js not loaded.");
                    try {
                        if (math.abs(math.sum(this.initialVector) - 1) > 1e-9) return alert("Sum of Initial State Vector must be 1.");
                        if (this.rowSums.some(s => math.abs(s - 1) > 1e-9)) return alert("The sum of each row in the transition matrix must be 1.");
                        
                        const P = math.matrix(this.transitionMatrix);
                        const s0 = math.matrix(this.initialVector);
                        const s_n = math.multiply(s0, math.pow(P, this.steps)).toArray();

                        const eigs = math.eigs(math.transpose(P));
                        const eigenvalues = eigs.values.toArray();
                        const steadyIdx = eigenvalues.findIndex(v => math.abs(math.subtract(v, 1)) < 1e-9);

                        if (steadyIdx === -1) {
                             this.results = { after_n_steps: s_n, steady_state: null };
                             throw new Error("No steady state found. The system may not be regular or ergodic.");
                        }
                        
                        let steadyVectorRaw = math.column(eigs.vectors, steadyIdx);
                        let steadyVector = math.flatten(steadyVectorRaw.toArray());
                        const steadySum = math.sum(steadyVector);
                        steadyVector = math.multiply(steadyVector, 1 / steadySum).map(v => math.abs(v));

                        this.results = {
                            after_n_steps: s_n,
                            steady_state: steadyVector.toArray()
                        };
                        console.log("markovEngine solve() finished successfully.");
                    } catch(e) { console.error(e); alert("Markov Calc Error: " + e.message); }
                }
            }));
        });
    </script>
</body>
</html>