<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Shader Library</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1e1e1e; color: #d4d4d4; padding: 20px; display: flex; height: 95vh; gap: 20px; box-sizing: border-box; margin: 0; }
        
        /* –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê */
        .list-panel { width: 300px; display: flex; flex-direction: column; border-right: 1px solid #333; padding-right: 20px; flex-shrink: 0; }
        .search-box { background: #252526; border: 1px solid #333; color: white; padding: 10px; width: 100%; margin-bottom: 15px; border-radius: 4px; box-sizing: border-box; }
        .sh-list { overflow-y: auto; flex: 1; }
        
        .loading-text { text-align: center; color: #888; margin-top: 20px; font-style: italic; }

        .sh-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 4px; transition: 0.2s; border-left: 3px solid transparent; background: #252526; }
        .sh-item:hover { background-color: #2a2d2e; }
        .sh-item.active { background-color: #37373d; border-left-color: #d16969; color: white; } /* –ö—Ä–∞—Å–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç –¥–ª—è —à–µ–π–¥–µ—Ä–æ–≤ */
        
        .s-title { font-weight: bold; display: block; color: #d16969; }
        .s-desc { font-size: 0.8em; color: #888; margin-top: 4px; display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        /* –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê */
        .detail-panel { flex: 1; display: flex; flex-direction: column; background: #111; border-radius: 6px; border: 1px solid #333; overflow: hidden; position: relative; }
        
        /* –¢–£–õ–ë–ê–† */
        .toolbar {
            min-height: 60px;
            background: #252526; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between; 
            padding: 10px 20px;
            box-sizing: border-box;
        }
        
        .header-info { display: flex; flex-direction: column; justify-content: center; gap: 4px; }
        .main-title { font-weight: bold; color: #ddd; font-size: 1.1em; }
        .sub-desc { font-size: 0.9em; color: #888; max-width: 600px; }

        .btn-copy {
            background-color: #d16969; color: white; border: none; padding: 8px 16px; 
            border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; flex-shrink: 0;
            display: none;
        }
        .btn-copy:hover { background-color: #b04c4c; }
        .btn-copy:active { transform: translateY(1px); }

        .frame-container { flex: 1; position: relative; background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgb3BhY2l0eT0iMC4wNSI+PHBhdGggZD0iTTAgMGg0MHY0MEgwVjB6IiBmaWxsPSIjZmZmIi8+PC9zdmc+'); }
        
        iframe { width: 100%; height: 100%; border: none; display: none; }
        .placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #555; font-size: 1.2em; }
    </style>
</head>
<body>

    <div class="list-panel">
        <input type="text" class="search-box" placeholder="–ü–æ–∏—Å–∫ —à–µ–π–¥–µ—Ä–∞..." onkeyup="renderList(this.value)">
        <div class="sh-list" id="listContainer">
            <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã...</div>
        </div>
    </div>

    <div class="detail-panel">
        <div class="toolbar">
            <div class="header-info">
                <span id="headerTitle" class="main-title">–í—ã–±–µ—Ä–∏—Ç–µ —à–µ–π–¥–µ—Ä</span>
                <span id="headerDesc" class="sub-desc"></span>
            </div>

            <button class="btn-copy" onclick="copyRawCode()" id="copyBtn">
                üìÑ COPY NODES
            </button>
        </div>
        <div class="frame-container">
            <div class="placeholder" id="placeholder">Select a Shader</div>
            <iframe id="shFrame" scrolling="no" allowfullscreen></iframe>
        </div>
    </div>

    <script>
        // --- 1. –ù–ê–°–¢–†–û–ô–ö–ò SUPABASE ---
    const SUPABASE_URL = 'https://vmwwvwtsznxwoswzdzui.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_hfVfEOEyUxTAl9TCGQLQdA_2qpquHGk';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let shadersData = [];

        const listContainer = document.getElementById('listContainer');
        const shFrame = document.getElementById('shFrame');
        const placeholder = document.getElementById('placeholder');
        
        const headerTitle = document.getElementById('headerTitle');
        const headerDesc = document.getElementById('headerDesc');
        const copyBtn = document.getElementById('copyBtn');
        
        let currentRawCode = "";

        // --- 2. –ó–ê–ì–†–£–ó–ö–ê ---
        async function fetchShaders() {
            const { data, error } = await _supabase
                .from('shaders')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                listContainer.innerHTML = `<div class="loading-text" style="color:#d16969">–û—à–∏–±–∫–∞: ${error.message}</div>`;
                return;
            }

            shadersData = data;
            renderList();
        }

        // --- 3. –û–¢–†–ò–°–û–í–ö–ê ---
        function renderList(filter = "") {
            listContainer.innerHTML = "";
            
            if (shadersData.length === 0) {
                listContainer.innerHTML = `<div class="loading-text">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>`;
                return;
            }

            const searchParts = filter.toLowerCase().split(' ').filter(p => p.trim() !== "");

            shadersData.forEach((item, index) => {
                const descText = item.description || item.desc || "";

                if (searchParts.length > 0) {
                    const searchTarget = (item.title + " " + descText).toLowerCase();
                    const isMatch = searchParts.every(part => searchTarget.includes(part));
                    if (!isMatch) return;
                }

                const div = document.createElement('div');
                div.className = 'sh-item';
                div.innerHTML = `<span class="s-title">üîÆ ${item.title}</span><span class="s-desc">${descText}</span>`;
                div.onclick = () => loadShader(index, div);
                listContainer.appendChild(div);
            });
        }

        function loadShader(index, element) {
            const item = shadersData[index];
            document.querySelectorAll('.sh-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            const descText = item.description || item.desc || "";

            placeholder.style.display = 'none';
            shFrame.style.display = 'block';
            
            // –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            if (item.code) {
                copyBtn.style.display = 'flex';
                currentRawCode = item.code;
            } else {
                copyBtn.style.display = 'none';
            }
            
            headerTitle.innerText = item.title;
            headerDesc.innerText = descText;

            // –ó–∞–≥—Ä—É–∑–∫–∞ iframe
            if (item.embed_id) {
                shFrame.src = `https://blueprintue.com/render/${item.embed_id}/`;
            } else if (item.embedId) { 
                shFrame.src = `https://blueprintue.com/render/${item.embedId}/`;
            } else {
                shFrame.style.display = 'none';
                placeholder.style.display = 'block';
                placeholder.innerText = "No Embed ID found";
            }
        }

        function copyRawCode() {
            if (!currentRawCode) { alert("–ù–µ—Ç –∫–æ–¥–∞"); return; }
            navigator.clipboard.writeText(currentRawCode).then(() => {
                const originalText = copyBtn.innerText;
                copyBtn.innerText = "‚úÖ COPIED!";
                setTimeout(() => copyBtn.innerText = originalText, 1500);
            });
        }

        document.addEventListener('DOMContentLoaded', fetchShaders);
    </script>
</body>
</html>